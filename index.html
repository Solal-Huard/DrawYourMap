<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw Your Map - Travel Diary & Road Trip Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Leaflet CSS for road maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0d0d12;
            --bg-panel: #151520;
            --bg-elevated: #1c1c2a;
            --bg-hover: #252538;
            --accent-primary: #6366f1;
            --accent-secondary: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --text-primary: #f1f1f4;
            --text-secondary: #9494a8;
            --text-muted: #5e5e72;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-accent: rgba(99, 102, 241, 0.5);
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --serendipity: #f472b6;
            --road-primary: #fbbf24;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary), #8b5cf6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .logo-icon.serendipity-mode {
            background: linear-gradient(135deg, var(--serendipity), var(--road-primary));
        }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            padding: 12px;
            gap: 8px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .mode-tab {
            flex: 1;
            padding: 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .mode-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .mode-tab.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .mode-tab.serendipity.active {
            background: linear-gradient(135deg, var(--serendipity), var(--road-primary));
            border-color: var(--serendipity);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 3px;
        }

        /* Section */
        .section {
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 10px;
            padding-left: 4px;
        }

        /* Stats */
        .travel-stats {
            background: linear-gradient(135deg, var(--bg-elevated), var(--bg-hover));
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-box {
            text-align: center;
        }

        .stat-box .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-box .stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Buttons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), #8b5cf6);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-accent);
        }

        .btn-serendipity {
            background: linear-gradient(135deg, var(--serendipity), var(--road-primary));
            color: white;
            font-weight: 600;
        }

        .btn-serendipity:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(244, 114, 182, 0.4);
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Selected Display */
        .selected-display {
            background: linear-gradient(135deg, var(--bg-elevated), var(--bg-hover));
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .selected-display.has-selection {
            border-color: var(--border-accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .selected-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .selected-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Search */
        .search-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .search-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            background: var(--bg-dark);
            overflow: hidden;
        }

        #worldMap {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #worldMap:active {
            cursor: grabbing;
        }

        #worldMap path {
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 0.5;
            transition: filter 0.15s, stroke 0.15s;
        }

        #worldMap path:hover {
            stroke: var(--accent-primary);
            stroke-width: 1;
            filter: brightness(1.3);
            cursor: pointer;
        }

        #worldMap path.selected {
            stroke: var(--accent-secondary);
            stroke-width: 2;
            filter: drop-shadow(0 0 8px var(--accent-glow));
        }

        /* Leaflet Road Map */
        #roadMap {
            width: 100%;
            height: 100%;
            display: none;
            background: #1a1a2e;
        }

        #roadMap.active {
            display: block;
        }

        .leaflet-container {
            background: #1a1a2e;
            font-family: 'DM Sans', sans-serif;
        }

        /* Leaflet control styling */
        .leaflet-control-layers {
            background: var(--bg-panel) !important;
            border: 1px solid var(--border-subtle) !important;
            border-radius: 10px !important;
            color: var(--text-primary) !important;
        }

        .leaflet-control-layers-expanded {
            padding: 10px 14px !important;
        }

        .leaflet-control-layers label {
            color: var(--text-primary) !important;
            font-size: 0.85rem;
        }

        .leaflet-popup-content-wrapper {
            background: var(--bg-panel) !important;
            border-radius: 12px !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5) !important;
        }

        .leaflet-popup-content {
            color: var(--text-primary) !important;
            margin: 12px 14px !important;
        }

        .leaflet-popup-tip {
            background: var(--bg-panel) !important;
        }

        .leaflet-control-attribution {
            background: rgba(21, 21, 32, 0.8) !important;
            color: var(--text-muted) !important;
            font-size: 0.65rem !important;
        }

        .leaflet-control-attribution a {
            color: var(--accent-secondary) !important;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 50;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* ==================== SERENDIPITY PANEL ==================== */
        .serendipity-content {
            display: none;
        }

        .serendipity-content.active {
            display: block;
        }

        .road-trip-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .road-trip-card:hover {
            border-color: var(--serendipity);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(244, 114, 182, 0.2);
        }

        .road-trip-card.active {
            border-color: var(--serendipity);
            background: rgba(244, 114, 182, 0.1);
        }

        .road-trip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .road-trip-icon {
            font-size: 1.5rem;
        }

        .road-trip-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .road-trip-meta {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .road-trip-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .road-trip-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .road-tag {
            padding: 4px 10px;
            background: var(--bg-dark);
            border-radius: 12px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .road-tag.toll-free { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .road-tag.scenic { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
        .road-tag.adventure { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .road-tag.camping { background: rgba(20, 184, 166, 0.2); color: #14b8a6; }
        .road-tag.fourx4 { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .road-tag.wildlife { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }

        .road-trip-card.personal {
            border-left: 3px solid var(--success);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), transparent);
        }

        .personal-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--success);
            color: white;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Rental Provider Card */
        .rental-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .rental-card:hover {
            border-color: var(--accent-primary);
        }

        .rental-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .rental-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .rental-name a {
            color: var(--accent-secondary);
            text-decoration: none;
        }

        .rental-name a:hover {
            text-decoration: underline;
        }

        .rental-rating {
            font-size: 0.75rem;
        }

        .rental-note {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Camping Site Card */
        .camping-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .camping-card:hover {
            border-color: var(--serendipity);
            transform: translateX(4px);
        }

        .camping-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .camping-name {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .camping-type {
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 500;
        }

        .camping-type.nwr {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .camping-type.private {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
        }

        .camping-location {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .camping-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
        }

        .camping-price {
            color: var(--success);
            font-weight: 500;
        }

        .camping-facilities {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Vanlifer Info Panel */
        .vanlifer-info {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .vanlifer-info h4 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .info-item {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .info-item .icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .info-item .label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .info-item .value {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .info-item.good .value { color: var(--success); }
        .info-item.warning .value { color: var(--warning); }
        .info-item.bad .value { color: var(--danger); }

        /* Community Alerts */
        .community-alerts {
            margin-top: 16px;
        }

        .alert-item {
            display: flex;
            gap: 10px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--warning);
        }

        .alert-item.danger { border-left-color: var(--danger); }
        .alert-item.info { border-left-color: var(--accent-primary); }
        .alert-item.success { border-left-color: var(--success); }

        .alert-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .alert-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .alert-meta {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Add Alert Button */
        .add-alert-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px dashed var(--border-subtle);
            border-radius: 10px;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-alert-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Alert Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            width: 450px;
            max-width: 95vw;
            max-height: 90vh;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
        }

        textarea.form-input {
            min-height: 80px;
            resize: vertical;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Route Info Popup */
        .route-popup {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 16px;
            min-width: 280px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .route-popup h4 {
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .route-popup p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        /* Marker Icons */
        .custom-marker {
            background: var(--bg-panel);
            border: 2px solid var(--serendipity);
            border-radius: 50%;
            width: 30px !important;
            height: 30px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .custom-marker.alert-marker {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.2);
        }

        .custom-marker.danger-marker {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.2);
        }

        .custom-marker.poi-marker {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.2);
        }

        /* Reddit Tips */
        .reddit-tips {
            background: linear-gradient(135deg, #ff4500, #ff6b35);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .reddit-tips h4 {
            color: white;
            font-size: 0.85rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reddit-tip {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            color: white;
        }

        .reddit-tip:last-child {
            margin-bottom: 0;
        }

        .reddit-tip .tip-text {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .reddit-tip .tip-source {
            font-size: 0.65rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* Country Info for Vanlifers */
        .country-vanlifer-info {
            background: var(--bg-elevated);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .country-vanlifer-header {
            padding: 14px;
            background: linear-gradient(135deg, var(--bg-hover), var(--bg-elevated));
            border-bottom: 1px solid var(--border-subtle);
        }

        .country-vanlifer-header h4 {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vanlifer-details {
            padding: 14px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-value {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .detail-value.good { color: var(--success); }
        .detail-value.moderate { color: var(--warning); }
        .detail-value.bad { color: var(--danger); }

        /* Hidden content */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 45vh;
            }

            .mode-tabs {
                padding: 8px;
            }

            .mode-tab {
                padding: 8px;
                font-size: 0.7rem;
            }
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.3s ease;
        }

        /* File input */
        .hidden-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon" id="logoIcon">üó∫Ô∏è</div>
                    <span id="logoText">Travel Diary</span>
                </div>
            </div>

            <!-- Mode Tabs -->
            <div class="mode-tabs">
                <button class="mode-tab active" onclick="switchMode('diary')" id="diaryModeTab">üìî Diary</button>
                <button class="mode-tab serendipity" onclick="switchMode('serendipity')" id="serendipityModeTab">üõ£Ô∏è Serendipity</button>
            </div>

            <div class="sidebar-content">
                <!-- ==================== DIARY MODE CONTENT ==================== -->
                <div id="diaryContent" class="mode-content">
                    <!-- Travel Stats -->
                    <div class="travel-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="countriesVisited">0</div>
                            <div class="stat-label">Countries</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="continentsExplored">0</div>
                            <div class="stat-label">Continents</div>
                        </div>
                    </div>

                    <!-- Selected Country -->
                    <div class="selected-display" id="selectedDisplay">
                        <div class="selected-label">Selected</div>
                        <div class="selected-name" id="selectedCountryName">Click a country</div>
                    </div>

                    <!-- Search -->
                    <div class="section">
                        <div class="section-title">üîç Search</div>
                        <select class="search-select" id="countrySearch" onchange="selectCountryByCode(this.value)">
                            <option value="">-- Select country --</option>
                        </select>
                    </div>

                    <!-- Quick Actions -->
                    <div class="section">
                        <div class="section-title">‚ö° Quick Actions</div>
                        <button class="btn btn-primary" onclick="markAsVisited()" style="margin-bottom: 8px;">‚úÖ Mark Visited</button>
                        <button class="btn btn-secondary" onclick="resetMap()">üîÑ Reset All</button>
                    </div>

                    <!-- Export -->
                    <div class="section">
                        <div class="section-title">üíæ Save/Load</div>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="exportData()">üì§ Export</button>
                            <button class="btn btn-secondary" onclick="importData()">üì• Import</button>
                        </div>
                        <input type="file" id="fileInput" class="hidden-input" accept=".json" onchange="handleImport(event)">
                    </div>
                </div>

                <!-- ==================== SERENDIPITY MODE CONTENT ==================== -->
                <div id="serendipityContent" class="mode-content serendipity-content">
                    <!-- Serendipity Stats -->
                    <div class="travel-stats" style="background: linear-gradient(135deg, rgba(244, 114, 182, 0.2), rgba(251, 191, 36, 0.2));">
                        <div class="stat-box">
                            <div class="stat-value" id="routesExplored">0</div>
                            <div class="stat-label">Routes</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="kmTraveled">0</div>
                            <div class="stat-label">KM Planned</div>
                        </div>
                    </div>

                    <!-- Reddit Tips -->
                    <div class="reddit-tips">
                        <h4>üî• Hot from r/roadtrip</h4>
                        <div class="reddit-tip">
                            <div class="tip-text">"The Wild Atlantic Way in Ireland is absolutely breathtaking. Skip the Ring of Kerry crowds!"</div>
                            <div class="tip-source">u/wanderlust_adventures ‚Ä¢ 2.4k upvotes</div>
                        </div>
                        <div class="reddit-tip">
                            <div class="tip-text">"Pro tip: iOverlander app is essential for finding free camping spots in Europe"</div>
                            <div class="tip-source">u/vanlife_europe ‚Ä¢ 1.8k upvotes</div>
                        </div>
                    </div>

                    <!-- Iconic Road Trips -->
                    <div class="section">
                        <div class="section-title">üõ£Ô∏è Iconic Road Trips</div>
                        <div id="roadTripsList">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- Vanlifer Country Info -->
                    <div class="country-vanlifer-info" id="vanliferCountryInfo" style="display: none;">
                        <div class="country-vanlifer-header">
                            <h4>üöê <span id="vanliferCountryName">Country</span> - Vanlifer Info</h4>
                        </div>
                        <div class="vanlifer-details">
                            <div class="detail-row">
                                <span class="detail-label">üõ£Ô∏è Tolls</span>
                                <span class="detail-value" id="tollInfo">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">‚õ∫ Wild Camping</span>
                                <span class="detail-value" id="campingInfo">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">‚õΩ Fuel Cost</span>
                                <span class="detail-value" id="fuelInfo">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üìã Visa (EU)</span>
                                <span class="detail-value" id="visaInfo">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üöó Road Quality</span>
                                <span class="detail-value" id="roadQualityInfo">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">üíß Water Access</span>
                                <span class="detail-value" id="waterInfo">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Route Details Panel (for selected route) -->
                    <div id="routeDetailsPanel" style="display: none;">
                        <div class="section">
                            <div class="section-title">üöó Location 4x4 avec tente de toit</div>
                            <div id="rentalProvidersList"></div>
                        </div>
                        <div class="section">
                            <div class="section-title">üèïÔ∏è Campings sur la route</div>
                            <div id="campingSitesList"></div>
                        </div>
                    </div>

                    <!-- Community Alerts -->
                    <div class="section community-alerts">
                        <div class="section-title">‚ö†Ô∏è Community Alerts</div>
                        <div id="alertsList">
                            <!-- Populated dynamically -->
                        </div>
                        <button class="add-alert-btn" onclick="openAlertModal()">+ Add Road Alert</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container" id="mapContainer">
            <div class="zoom-controls" id="zoomControls">
                <button class="zoom-btn" onclick="zoomIn()" title="Zoom in">+</button>
                <button class="zoom-btn" onclick="zoomOut()" title="Zoom out">‚àí</button>
                <button class="zoom-btn" onclick="resetZoom()" title="Reset">‚ü≤</button>
            </div>
            <!-- D3 World Map -->
            <svg id="worldMap" viewBox="0 0 2000 1000" preserveAspectRatio="xMidYMid meet"></svg>
            <!-- Leaflet Road Map -->
            <div id="roadMap"></div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal-overlay" id="alertModal">
        <div class="modal">
            <div class="modal-header">
                <h3>üö® Report Road Alert</h3>
                <button class="modal-close" onclick="closeAlertModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Alert Type</label>
                    <select class="form-select" id="alertType">
                        <option value="road_work">üöß Road Work / Closure</option>
                        <option value="hazard">‚ö†Ô∏è Road Hazard</option>
                        <option value="police">üëÆ Police Control</option>
                        <option value="fuel">‚õΩ Fuel Station Issue</option>
                        <option value="camping">üèïÔ∏è Camping Spot Update</option>
                        <option value="tip">üí° Helpful Tip</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Location / Route</label>
                    <input type="text" class="form-input" id="alertLocation" placeholder="e.g., Route 66, near Flagstaff">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-input" id="alertDescription" placeholder="Describe the situation..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" style="width: auto;" onclick="closeAlertModal()">Cancel</button>
                <button class="btn btn-serendipity" style="width: auto;" onclick="submitAlert()">Submit Alert</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ==================== GLOBAL STATE ====================
        let currentMode = 'diary';
        let selectedCountry = null;
        let currentCountryId = null;
        let currentCountryName = '';
        let countryColors = {};
        let svg, g, projection, path;
        let countriesData = [];
        let roadMap = null;
        let activeRoute = null;
        let communityAlerts = [];
        const DEFAULT_COLOR = '#3a3a4d';
        const VISITED_COLOR = '#22c55e';

        // ==================== ICONIC ROAD TRIPS DATABASE ====================
        const roadTrips = [
            {
                id: 'namibia_highlights',
                name: 'Namibia Highlights',
                icon: 'üá≥üá¶',
                country: 'Namibia',
                distance: '3500 km',
                duration: '12-16 days',
                coordinates: [[-22.5609, 17.0658], [-24.7275, 15.7390]],
                waypoints: [
                    [-22.5609, 17.0658, 'Windhoek'],
                    [-22.6792, 14.5272, 'Swakopmund'],
                    [-23.1061, 14.4361, 'Walvis Bay'],
                    [-24.7275, 15.7390, 'Sossusvlei'],
                    [-24.4628, 15.9446, 'Sesriem Canyon'],
                    [-23.3425, 15.9369, 'Solitaire'],
                    [-19.1738, 15.9494, 'Twyfelfontein'],
                    [-19.5833, 13.1000, 'Skeleton Coast'],
                    [-19.0154, 15.9150, 'Palmwag'],
                    [-18.8558, 16.1568, 'Etosha (Okaukuejo)'],
                    [-18.7878, 16.9306, 'Etosha (Halali)'],
                    [-18.8111, 17.0667, 'Etosha (Namutoni)'],
                    [-22.5609, 17.0658, 'Windhoek']
                ],
                tags: ['fourx4', 'adventure', 'camping', 'wildlife'],
                description: 'L\'aventure ultime en Namibie: dunes rouges de Sossusvlei, c√¥te des squelettes, faune d\'Etosha.',
                tips: 'Location 4x4 avec tente de toit obligatoire. R√©server les campings NWR √† l\'avance!',
                personalTrip: true,
                tripDate: 'Il y a 3 mois',
                rentalProviders: [
                    { name: 'ASCO Car Hire', url: 'https://ascocarhire.com', rating: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê', note: 'Excellent, v√©hicules bien entretenus' },
                    { name: 'Namibia2Go', url: 'https://namibia2go.com', rating: '‚≠ê‚≠ê‚≠ê‚≠ê', note: 'Bon rapport qualit√©/prix' },
                    { name: 'Britz Namibia', url: 'https://britz.co.za', rating: '‚≠ê‚≠ê‚≠ê‚≠ê', note: 'Grande flotte, pro' },
                    { name: 'Camping Car Hire', url: 'https://campingcarhire.com', rating: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê', note: 'Sp√©cialiste camping' },
                    { name: 'Safari Car Rental', url: 'https://safaricarrental.com', rating: '‚≠ê‚≠ê‚≠ê‚≠ê', note: 'Service client top' }
                ],
                campingSites: [
                    { name: 'Urban Camp Windhoek', location: 'Windhoek', type: 'Priv√©', price: '~250 NAD', facilities: 'Piscine, bar, wifi', coords: [-22.5700, 17.0800] },
                    { name: 'Alte Br√ºcke', location: 'Swakopmund', type: 'Priv√©', price: '~300 NAD', facilities: 'Pr√®s centre-ville, propre', coords: [-22.6850, 14.5350] },
                    { name: 'Sesriem Campsite (NWR)', location: 'Sossusvlei', type: 'NWR', price: '~350 NAD', facilities: 'Acc√®s dunes au lever du soleil!', coords: [-24.4800, 15.8300] },
                    { name: 'Sossus Oasis', location: 'Sesriem', type: 'Priv√©', price: '~400 NAD', facilities: 'Piscine, restaurant', coords: [-24.4700, 15.8200] },
                    { name: 'Solitaire Guest Farm', location: 'Solitaire', type: 'Priv√©', price: '~350 NAD', facilities: 'Apfelstrudel l√©gendaire!', coords: [-23.8900, 16.0100] },
                    { name: 'Palmwag Lodge Camp', location: 'Palmwag', type: 'Priv√©', price: '~400 NAD', facilities: 'Rhinos, √©l√©phants', coords: [-19.8800, 13.9500] },
                    { name: 'Okaukuejo (NWR)', location: 'Etosha', type: 'NWR', price: '~450 NAD', facilities: 'Waterhole illumin√© la nuit!', coords: [-18.9000, 15.9200] },
                    { name: 'Halali (NWR)', location: 'Etosha', type: 'NWR', price: '~400 NAD', facilities: 'Central, waterhole', coords: [-18.7600, 16.5000] },
                    { name: 'Namutoni (NWR)', location: 'Etosha', type: 'NWR', price: '~450 NAD', facilities: 'Fort historique, waterhole', coords: [-18.8100, 16.9300] }
                ]
            },
            {
                id: 'route66',
                name: 'Route 66',
                icon: 'üá∫üá∏',
                country: 'USA',
                distance: '3940 km',
                duration: '2-3 weeks',
                coordinates: [[34.0522, -118.2437], [41.8781, -87.6298]],
                waypoints: [
                    [34.0522, -118.2437, 'Los Angeles'],
                    [35.2226, -101.8313, 'Amarillo'],
                    [35.0844, -106.6504, 'Albuquerque'],
                    [36.1627, -86.7816, 'Nashville'],
                    [41.8781, -87.6298, 'Chicago']
                ],
                tags: ['scenic', 'adventure'],
                description: 'The quintessential American road trip from Chicago to LA through the heart of America.',
                tips: 'Best in spring or fall. Many original motels and diners still open.'
            },
            {
                id: 'panamerican',
                name: 'Pan-American Highway',
                icon: 'üåé',
                country: 'Multi',
                distance: '30000 km',
                duration: '6-12 months',
                coordinates: [[-54.8019, -68.3030], [64.8378, -147.7164]],
                waypoints: [
                    [-54.8019, -68.3030, 'Ushuaia'],
                    [-33.4489, -70.6693, 'Santiago'],
                    [-12.0464, -77.0428, 'Lima'],
                    [19.4326, -99.1332, 'Mexico City'],
                    [64.8378, -147.7164, 'Fairbanks']
                ],
                tags: ['adventure', 'epic'],
                description: 'The ultimate road trip spanning the Americas from Argentina to Alaska.',
                tips: 'Darien Gap requires shipping vehicle. Plan border crossings carefully.'
            },
            {
                id: 'wildatlantic',
                name: 'Wild Atlantic Way',
                icon: 'üáÆüá™',
                country: 'Ireland',
                distance: '2500 km',
                duration: '2 weeks',
                coordinates: [[51.8985, -8.4756], [55.2408, -7.3074]],
                waypoints: [
                    [51.8985, -8.4756, 'Cork'],
                    [52.2593, -9.7066, 'Dingle'],
                    [53.2707, -9.0568, 'Galway'],
                    [54.2766, -8.4761, 'Sligo'],
                    [55.2408, -7.3074, 'Malin Head']
                ],
                tags: ['scenic', 'toll-free', 'camping'],
                description: 'Stunning coastal route along Ireland\'s rugged Atlantic coast.',
                tips: 'Wild camping legal. Weather unpredictable - pack layers!'
            },
            {
                id: 'nc500',
                name: 'North Coast 500',
                icon: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø',
                country: 'Scotland',
                distance: '830 km',
                duration: '5-7 days',
                coordinates: [[57.4778, -4.2247], [58.6373, -3.0689]],
                waypoints: [
                    [57.4778, -4.2247, 'Inverness'],
                    [57.8690, -5.0960, 'Applecross'],
                    [58.4374, -4.9943, 'Durness'],
                    [58.4397, -3.0943, 'John o\' Groats'],
                    [57.4778, -4.2247, 'Inverness']
                ],
                tags: ['scenic', 'toll-free', 'camping'],
                description: 'Scotland\'s answer to Route 66. Breathtaking Highland scenery.',
                tips: 'Single track roads require patience. Book accommodation in summer.'
            },
            {
                id: 'greatocean',
                name: 'Great Ocean Road',
                icon: 'üá¶üá∫',
                country: 'Australia',
                distance: '243 km',
                duration: '2-3 days',
                coordinates: [[-38.1499, 144.3617], [-38.6805, 143.1051]],
                waypoints: [
                    [-38.1499, 144.3617, 'Torquay'],
                    [-38.4089, 144.0033, 'Lorne'],
                    [-38.6639, 143.1044, '12 Apostles'],
                    [-38.7833, 143.0833, 'Port Campbell']
                ],
                tags: ['scenic', 'toll-free'],
                description: 'One of the world\'s most scenic coastal drives.',
                tips: 'Best light for 12 Apostles at sunrise/sunset. Watch for koalas!'
            },
            {
                id: 'transfagarasan',
                name: 'TransfƒÉgƒÉrƒÉ»ôan',
                icon: 'üá∑üá¥',
                country: 'Romania',
                distance: '151 km',
                duration: '1-2 days',
                coordinates: [[45.5989, 24.6224], [45.3523, 24.6189]],
                waypoints: [
                    [45.5989, 24.6224, 'Curtea de Arge»ô'],
                    [45.6042, 24.6150, 'Balea Lake'],
                    [45.3523, 24.6189, 'Sibiu']
                ],
                tags: ['scenic', 'adventure', 'toll-free'],
                description: 'Called "the best road in the world" by Top Gear.',
                tips: 'Only open June-October. Arrive early to avoid crowds.'
            },
            {
                id: 'garden_route',
                name: 'Garden Route',
                icon: 'üáøüá¶',
                country: 'South Africa',
                distance: '300 km',
                duration: '5-7 days',
                coordinates: [[-34.0373, 23.0471], [-33.9580, 22.4610]],
                waypoints: [
                    [-34.0373, 23.0471, 'Storms River'],
                    [-34.0355, 23.3695, 'Plettenberg Bay'],
                    [-33.9580, 22.4610, 'George']
                ],
                tags: ['scenic', 'adventure', 'camping'],
                description: 'Lush forests, lagoons, and stunning coastline.',
                tips: 'Great for wildlife. Bungee jump at Bloukrans Bridge!'
            },
            {
                id: 'ring_road',
                name: 'Ring Road',
                icon: 'üáÆüá∏',
                country: 'Iceland',
                distance: '1332 km',
                duration: '7-10 days',
                coordinates: [[64.1466, -21.9426], [65.6835, -18.0878]],
                waypoints: [
                    [64.1466, -21.9426, 'Reykjavik'],
                    [64.3260, -20.1210, 'Geysir'],
                    [63.5320, -19.5110, 'Vik'],
                    [65.6835, -18.0878, 'Akureyri']
                ],
                tags: ['scenic', 'adventure', 'toll-free'],
                description: 'Circle Iceland through volcanoes, glaciers and waterfalls.',
                tips: 'F-roads need 4x4. Summer has 24hr daylight. Expensive but incredible!'
            },
            // ==================== ASIA ROAD TRIPS ====================
            {
                id: 'karakoram',
                name: 'Karakoram Highway',
                icon: 'üáµüá∞',
                country: 'Pakistan/China',
                distance: '1300 km',
                duration: '7-10 days',
                coordinates: [[35.9208, 74.3082], [39.4704, 75.9893]],
                waypoints: [
                    [35.9208, 74.3082, 'Gilgit'],
                    [36.3167, 74.6500, 'Karimabad (Hunza)'],
                    [36.4500, 74.8667, 'Passu'],
                    [36.8333, 75.4167, 'Khunjerab Pass (4693m)'],
                    [39.4704, 75.9893, 'Kashgar']
                ],
                tags: ['adventure', 'scenic', 'epic'],
                description: 'The 8th wonder of the world - highest paved international road crossing the Himalayas.',
                tips: 'Permits required. Best May-October. Altitude sickness possible at Khunjerab.'
            },
            {
                id: 'hai_van',
                name: 'Hai Van Pass & Coastal Vietnam',
                icon: 'üáªüá≥',
                country: 'Vietnam',
                distance: '1700 km',
                duration: '10-14 days',
                coordinates: [[10.7769, 106.7009], [21.0285, 105.8542]],
                waypoints: [
                    [10.7769, 106.7009, 'Ho Chi Minh City'],
                    [11.9404, 108.4583, 'Da Lat'],
                    [12.2388, 109.1967, 'Nha Trang'],
                    [13.7563, 109.2225, 'Quy Nhon'],
                    [15.8801, 108.3380, 'Hoi An'],
                    [16.0544, 108.2022, 'Da Nang'],
                    [16.4637, 107.5909, 'Hue'],
                    [21.0285, 105.8542, 'Hanoi']
                ],
                tags: ['scenic', 'adventure', 'toll-free'],
                description: 'Vietnam\'s legendary coastal route including the famous Hai Van Pass (Top Gear\'s best road).',
                tips: 'Rent motorbike in HCMC, sell in Hanoi. Rainy season varies by region.'
            },
            {
                id: 'hokkaido',
                name: 'Hokkaido Circuit',
                icon: 'üáØüáµ',
                country: 'Japan',
                distance: '1200 km',
                duration: '7-10 days',
                coordinates: [[43.0621, 141.3544], [43.7714, 142.3630]],
                waypoints: [
                    [43.0621, 141.3544, 'Sapporo'],
                    [43.0587, 141.3570, 'Otaru'],
                    [43.4564, 142.4847, 'Furano'],
                    [43.7714, 142.3630, 'Biei (Blue Pond)'],
                    [43.0618, 144.3589, 'Kushiro'],
                    [44.0206, 145.1370, 'Shiretoko Peninsula'],
                    [43.0621, 141.3544, 'Sapporo']
                ],
                tags: ['scenic', 'camping'],
                description: 'Japan\'s wild north - lavender fields, volcanic lakes, and untamed wilderness.',
                tips: 'Michi-no-Eki (road stations) allow overnight parking. Best July-September.'
            },
            {
                id: 'golden_triangle',
                name: 'Golden Triangle',
                icon: 'üáπüá≠',
                country: 'Thailand',
                distance: '1900 km',
                duration: '10-14 days',
                coordinates: [[13.7563, 100.5018], [20.3500, 100.0833]],
                waypoints: [
                    [13.7563, 100.5018, 'Bangkok'],
                    [14.3692, 99.9938, 'Kanchanaburi'],
                    [18.7883, 98.9853, 'Chiang Mai'],
                    [19.9071, 99.8309, 'Chiang Rai'],
                    [20.3500, 100.0833, 'Golden Triangle'],
                    [19.2966, 97.9684, 'Mae Hong Son Loop'],
                    [18.7883, 98.9853, 'Chiang Mai']
                ],
                tags: ['scenic', 'adventure', 'toll-free'],
                description: 'Northern Thailand loop through mountains, temples, and the legendary Mae Hong Son Loop.',
                tips: '762 curves in Mae Hong Son Loop! Rent big bike in Chiang Mai.'
            },
            {
                id: 'silk_road',
                name: 'Silk Road (Central Asia)',
                icon: 'üê™',
                country: 'Multi-country',
                distance: '4000 km',
                duration: '3-4 weeks',
                coordinates: [[41.2995, 69.2401], [39.6542, 66.9597]],
                waypoints: [
                    [41.2995, 69.2401, 'Tashkent'],
                    [39.6542, 66.9597, 'Samarkand'],
                    [39.7747, 64.4286, 'Bukhara'],
                    [41.3775, 60.3378, 'Khiva'],
                    [42.4602, 59.6035, 'Nukus'],
                    [37.9601, 58.3261, 'Mary (Merv)'],
                    [37.9509, 58.3794, 'Ashgabat']
                ],
                tags: ['adventure', 'epic', 'historic'],
                description: 'Follow the ancient trade route through Uzbekistan and Turkmenistan.',
                tips: 'Visas can be complex. Best spring/autumn. Incredible Islamic architecture.'
            },
            {
                id: 'rajasthan',
                name: 'Rajasthan Royal Route',
                icon: 'üáÆüá≥',
                country: 'India',
                distance: '1200 km',
                duration: '10-14 days',
                coordinates: [[28.6139, 77.2090], [26.9124, 70.9021]],
                waypoints: [
                    [28.6139, 77.2090, 'Delhi'],
                    [27.1767, 78.0081, 'Agra (Taj Mahal)'],
                    [26.9124, 75.7873, 'Jaipur'],
                    [26.4499, 74.6399, 'Pushkar'],
                    [26.2967, 73.0167, 'Jodhpur'],
                    [26.9124, 70.9021, 'Jaisalmer'],
                    [24.5854, 72.7125, 'Udaipur']
                ],
                tags: ['historic', 'scenic', 'adventure'],
                description: 'India\'s royal route through forts, palaces, and the Thar Desert.',
                tips: 'Chaotic traffic! Best October-March. Hire driver or be very experienced.'
            },
            {
                id: 'korea_coastal',
                name: 'Korea Coastal Road',
                icon: 'üá∞üá∑',
                country: 'South Korea',
                distance: '1700 km',
                duration: '7-10 days',
                coordinates: [[35.1796, 129.0756], [38.2070, 128.5918]],
                waypoints: [
                    [35.1796, 129.0756, 'Busan'],
                    [35.8714, 128.6014, 'Gyeongju'],
                    [36.0190, 129.3435, 'Pohang'],
                    [37.4563, 129.1658, 'Gangneung'],
                    [38.2070, 128.5918, 'Sokcho'],
                    [37.5665, 126.9780, 'Seoul']
                ],
                tags: ['scenic', 'toll-free', 'camping'],
                description: 'Korea\'s stunning east coast from Busan to the DMZ area.',
                tips: 'Excellent rest stops. Try the seafood! Camping at beaches possible.'
            },
            // ==================== AFRICA ROAD TRIPS ====================
            {
                id: 'morocco_atlas',
                name: 'Morocco Grand Tour',
                icon: 'üá≤üá¶',
                country: 'Morocco',
                distance: '2200 km',
                duration: '12-16 days',
                coordinates: [[33.5731, -7.5898], [31.6295, -7.9811]],
                waypoints: [
                    [33.5731, -7.5898, 'Casablanca'],
                    [33.9716, -6.8498, 'Rabat'],
                    [34.0181, -5.0078, 'Fes'],
                    [31.9314, -4.4288, 'Merzouga (Sahara)'],
                    [31.1649, -4.0004, 'Todra Gorge'],
                    [31.0482, -6.8388, 'Ait Benhaddou'],
                    [31.6295, -7.9811, 'Marrakech'],
                    [30.4278, -9.5981, 'Agadir'],
                    [31.5085, -9.7595, 'Essaouira']
                ],
                tags: ['adventure', 'scenic', 'camping'],
                description: 'From imperial cities to Sahara dunes, kasbahs and coastal charm.',
                tips: 'Wild camping easy outside cities. Negotiate everything! Best spring/autumn.'
            },
            {
                id: 'cape_town_kruger',
                name: 'Cape Town to Kruger',
                icon: 'üáøüá¶',
                country: 'South Africa',
                distance: '1800 km',
                duration: '14-18 days',
                coordinates: [[-33.9249, 18.4241], [-24.9916, 31.5430]],
                waypoints: [
                    [-33.9249, 18.4241, 'Cape Town'],
                    [-33.9580, 22.4610, 'Garden Route Start'],
                    [-33.4580, 26.5220, 'Addo Elephant Park'],
                    [-29.8587, 31.0218, 'Durban'],
                    [-25.7479, 28.2293, 'Pretoria'],
                    [-24.9916, 31.5430, 'Kruger National Park']
                ],
                tags: ['scenic', 'wildlife', 'adventure'],
                description: 'The ultimate South African road trip - coast, wildlife, and everything in between.',
                tips: 'Book Kruger camps months ahead. Garden Route doable year-round.'
            },
            {
                id: 'ethiopia_historic',
                name: 'Ethiopian Historic Route',
                icon: 'üá™üáπ',
                country: 'Ethiopia',
                distance: '1500 km',
                duration: '10-14 days',
                coordinates: [[9.0320, 38.7469], [14.1210, 38.7469]],
                waypoints: [
                    [9.0320, 38.7469, 'Addis Ababa'],
                    [11.5936, 37.3908, 'Bahir Dar (Blue Nile Falls)'],
                    [12.6000, 37.4667, 'Gondar'],
                    [13.4910, 39.4750, 'Axum'],
                    [12.0300, 39.0442, 'Lalibela'],
                    [9.0320, 38.7469, 'Addis Ababa']
                ],
                tags: ['historic', 'adventure', 'fourx4'],
                description: 'Ancient churches, castles, and the ark of the covenant route.',
                tips: 'Roads improving but still challenging. Best October-March (dry season).'
            },
            {
                id: 'tanzania_circuit',
                name: 'Tanzania Northern Circuit',
                icon: 'üáπüáø',
                country: 'Tanzania',
                distance: '800 km',
                duration: '7-10 days',
                coordinates: [[-3.3869, 36.6830], [-2.3333, 34.8333]],
                waypoints: [
                    [-3.3869, 36.6830, 'Arusha'],
                    [-3.0674, 37.3556, 'Moshi (Kilimanjaro)'],
                    [-2.3333, 34.8333, 'Serengeti'],
                    [-3.2400, 35.5320, 'Ngorongoro Crater'],
                    [-3.5000, 35.7500, 'Lake Manyara'],
                    [-4.0500, 35.7620, 'Tarangire'],
                    [-3.3869, 36.6830, 'Arusha']
                ],
                tags: ['wildlife', 'adventure', 'fourx4'],
                description: 'Safari paradise - Great Migration, Ngorongoro, and Kilimanjaro views.',
                tips: 'June-October for migration. Book camps well in advance!'
            },
            {
                id: 'senegal_dakar',
                name: 'Senegal Adventure',
                icon: 'üá∏üá≥',
                country: 'Senegal',
                distance: '1200 km',
                duration: '10-14 days',
                coordinates: [[14.6928, -17.4467], [12.5833, -16.2719]],
                waypoints: [
                    [14.6928, -17.4467, 'Dakar'],
                    [14.7500, -17.3600, 'Lac Rose'],
                    [15.6178, -16.4181, 'Saint-Louis'],
                    [13.4531, -16.5775, 'Sine-Saloum Delta'],
                    [12.5833, -16.2719, 'Casamance'],
                    [14.6928, -17.4467, 'Dakar']
                ],
                tags: ['adventure', 'scenic', 'toll-free'],
                description: 'West African adventure - colonial history, pink lake, and tropical south.',
                tips: 'Peugeot 504 sept-place for local experience! Casamance requires patience.'
            },
            {
                id: 'madagascar_rn7',
                name: 'Madagascar RN7',
                icon: 'üá≤üá¨',
                country: 'Madagascar',
                distance: '1000 km',
                duration: '10-14 days',
                coordinates: [[-18.8792, 47.5079], [-23.3516, 43.6854]],
                waypoints: [
                    [-18.8792, 47.5079, 'Antananarivo'],
                    [-19.8659, 47.0333, 'Antsirabe'],
                    [-20.5167, 46.5500, 'Ambositra'],
                    [-21.4419, 47.0856, 'Ranomafana'],
                    [-21.2500, 45.3667, 'Isalo'],
                    [-23.3516, 43.6854, 'Toliara']
                ],
                tags: ['adventure', 'wildlife', 'scenic'],
                description: 'Madagascar\'s most famous road - lemurs, baobabs, and otherworldly landscapes.',
                tips: 'Roads very rough! 4x4 recommended. Best April-November.'
            }
        ];

        // ==================== WORLD VIEWPOINTS & HISTORICAL SITES (UNESCO + FAMOUS) ====================
        const worldViewpoints = [
            // Africa
            { name: 'Pyramids of Giza', lat: 29.9792, lng: 31.1342, type: 'historic', icon: 'üèõÔ∏è', country: 'Egypt', unesco: true },
            { name: 'Victoria Falls', lat: -17.9243, lng: 25.8572, type: 'viewpoint', icon: 'üíß', country: 'Zambia/Zimbabwe', unesco: true },
            { name: 'Serengeti', lat: -2.3333, lng: 34.8333, type: 'nature', icon: 'ü¶Å', country: 'Tanzania', unesco: true },
            { name: 'Medina of Fes', lat: 34.0181, lng: -5.0078, type: 'historic', icon: 'üïå', country: 'Morocco', unesco: true },
            { name: 'Rock Churches of Lalibela', lat: 12.0300, lng: 39.0442, type: 'historic', icon: '‚õ™', country: 'Ethiopia', unesco: true },
            { name: 'Table Mountain', lat: -33.9628, lng: 18.4098, type: 'viewpoint', icon: '‚õ∞Ô∏è', country: 'South Africa' },
            { name: 'Ngorongoro Crater', lat: -3.2400, lng: 35.5320, type: 'nature', icon: 'üåã', country: 'Tanzania', unesco: true },
            { name: 'Sossusvlei Dunes', lat: -24.7275, lng: 15.7390, type: 'viewpoint', icon: 'üèúÔ∏è', country: 'Namibia' },
            // Asia
            { name: 'Taj Mahal', lat: 27.1751, lng: 78.0421, type: 'historic', icon: 'üïå', country: 'India', unesco: true },
            { name: 'Great Wall of China', lat: 40.4319, lng: 116.5704, type: 'historic', icon: 'üèØ', country: 'China', unesco: true },
            { name: 'Angkor Wat', lat: 13.4125, lng: 103.8670, type: 'historic', icon: 'üõï', country: 'Cambodia', unesco: true },
            { name: 'Mount Fuji', lat: 35.3606, lng: 138.7274, type: 'viewpoint', icon: 'üóª', country: 'Japan', unesco: true },
            { name: 'Ha Long Bay', lat: 20.9101, lng: 107.1839, type: 'nature', icon: 'üåä', country: 'Vietnam', unesco: true },
            { name: 'Petra', lat: 30.3285, lng: 35.4444, type: 'historic', icon: 'üèõÔ∏è', country: 'Jordan', unesco: true },
            { name: 'Bagan Temples', lat: 21.1717, lng: 94.8585, type: 'historic', icon: 'üõï', country: 'Myanmar', unesco: true },
            { name: 'Hagia Sophia', lat: 41.0086, lng: 28.9802, type: 'historic', icon: 'üïå', country: 'Turkey', unesco: true },
            { name: 'Borobudur', lat: -7.6079, lng: 110.2038, type: 'historic', icon: 'üõï', country: 'Indonesia', unesco: true },
            { name: 'Terracotta Army', lat: 34.3848, lng: 109.2785, type: 'historic', icon: 'üè∫', country: 'China', unesco: true },
            { name: 'Sigiriya Rock', lat: 7.9570, lng: 80.7603, type: 'historic', icon: 'üè∞', country: 'Sri Lanka', unesco: true },
            { name: 'Khajuraho', lat: 24.8318, lng: 79.9199, type: 'historic', icon: 'üõï', country: 'India', unesco: true },
            // Europe
            { name: 'Colosseum', lat: 41.8902, lng: 12.4922, type: 'historic', icon: 'üèüÔ∏è', country: 'Italy', unesco: true },
            { name: 'Acropolis', lat: 37.9715, lng: 23.7257, type: 'historic', icon: 'üèõÔ∏è', country: 'Greece', unesco: true },
            { name: 'Eiffel Tower', lat: 48.8584, lng: 2.2945, type: 'viewpoint', icon: 'üóº', country: 'France' },
            { name: 'Neuschwanstein Castle', lat: 47.5576, lng: 10.7498, type: 'historic', icon: 'üè∞', country: 'Germany' },
            { name: 'Santorini Caldera', lat: 36.3932, lng: 25.4615, type: 'viewpoint', icon: 'üåÖ', country: 'Greece' },
            { name: 'Stonehenge', lat: 51.1789, lng: -1.8262, type: 'historic', icon: 'ü™®', country: 'UK', unesco: true },
            { name: 'Alhambra', lat: 37.1760, lng: -3.5881, type: 'historic', icon: 'üè∞', country: 'Spain', unesco: true },
            { name: 'Dubrovnik Old Town', lat: 42.6507, lng: 18.0944, type: 'historic', icon: 'üè∞', country: 'Croatia', unesco: true },
            // Americas
            { name: 'Machu Picchu', lat: -13.1631, lng: -72.5450, type: 'historic', icon: 'üèîÔ∏è', country: 'Peru', unesco: true },
            { name: 'Grand Canyon', lat: 36.1069, lng: -112.1129, type: 'viewpoint', icon: 'üèúÔ∏è', country: 'USA', unesco: true },
            { name: 'Chichen Itza', lat: 20.6843, lng: -88.5678, type: 'historic', icon: 'üèõÔ∏è', country: 'Mexico', unesco: true },
            { name: 'Iguazu Falls', lat: -25.6953, lng: -54.4367, type: 'viewpoint', icon: 'üíß', country: 'Argentina/Brazil', unesco: true },
            { name: 'Monument Valley', lat: 36.9980, lng: -110.0985, type: 'viewpoint', icon: 'üèúÔ∏è', country: 'USA' },
            { name: 'Moai of Easter Island', lat: -27.1127, lng: -109.3497, type: 'historic', icon: 'üóø', country: 'Chile', unesco: true },
            // Oceania
            { name: 'Great Barrier Reef', lat: -18.2871, lng: 147.6992, type: 'nature', icon: 'üê†', country: 'Australia', unesco: true },
            { name: 'Uluru', lat: -25.3444, lng: 131.0369, type: 'nature', icon: 'ü™®', country: 'Australia', unesco: true },
            { name: 'Milford Sound', lat: -44.6414, lng: 167.8975, type: 'viewpoint', icon: '‚õ∞Ô∏è', country: 'New Zealand' }
        ];

        // ==================== VANLIFER COUNTRY INFO DATABASE ====================
        const vanliferInfo = {
            'United States of America': { tolls: 'Varies', tollClass: 'moderate', camping: 'BLM Land Free', campingClass: 'good', fuel: '$0.90/L', fuelClass: 'good', visa: '90 days ESTA', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Canada': { tolls: 'Few', tollClass: 'good', camping: 'Crown Land Free', campingClass: 'good', fuel: '$1.60/L', fuelClass: 'moderate', visa: '6 months eTA', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Mexico': { tolls: 'Expensive', tollClass: 'bad', camping: 'Informal OK', campingClass: 'moderate', fuel: '$1.20/L', fuelClass: 'good', visa: '180 days free', roadQuality: 'Variable', waterAccess: 'Moderate' },
            'France': { tolls: 'Very High', tollClass: 'bad', camping: 'Restricted', campingClass: 'bad', fuel: '$1.90/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Spain': { tolls: 'Moderate', tollClass: 'moderate', camping: 'Gray Area', campingClass: 'moderate', fuel: '$1.60/L', fuelClass: 'moderate', visa: 'EU/90 days', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Portugal': { tolls: 'Moderate', tollClass: 'moderate', camping: 'Tolerated', campingClass: 'moderate', fuel: '$1.70/L', fuelClass: 'moderate', visa: 'EU/90 days', roadQuality: 'Good', waterAccess: 'Easy' },
            'Germany': { tolls: 'Free (cars)', tollClass: 'good', camping: 'Restricted', campingClass: 'bad', fuel: '$1.80/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Italy': { tolls: 'Very High', tollClass: 'bad', camping: 'Restricted', campingClass: 'bad', fuel: '$1.85/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Good', waterAccess: 'Moderate' },
            'United Kingdom': { tolls: 'Few', tollClass: 'good', camping: 'Scotland OK', campingClass: 'moderate', fuel: '$1.95/L', fuelClass: 'bad', visa: '6 months', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Ireland': { tolls: 'Few', tollClass: 'good', camping: 'Tolerated', campingClass: 'good', fuel: '$1.80/L', fuelClass: 'bad', visa: '90 days', roadQuality: 'Good', waterAccess: 'Easy' },
            'Norway': { tolls: 'High', tollClass: 'bad', camping: 'Legal!', campingClass: 'good', fuel: '$2.20/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Sweden': { tolls: 'Few', tollClass: 'good', camping: 'Legal!', campingClass: 'good', fuel: '$1.90/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Iceland': { tolls: 'None', tollClass: 'good', camping: 'Designated', campingClass: 'moderate', fuel: '$2.30/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Variable', waterAccess: 'Moderate' },
            'Romania': { tolls: 'Cheap', tollClass: 'good', camping: 'Tolerated', campingClass: 'good', fuel: '$1.40/L', fuelClass: 'good', visa: 'EU/90 days', roadQuality: 'Variable', waterAccess: 'Moderate' },
            'Greece': { tolls: 'Moderate', tollClass: 'moderate', camping: 'Restricted', campingClass: 'bad', fuel: '$1.85/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Good', waterAccess: 'Moderate' },
            'Australia': { tolls: 'City Only', tollClass: 'good', camping: 'Outback Free', campingClass: 'good', fuel: '$1.50/L', fuelClass: 'moderate', visa: 'eVisitor', roadQuality: 'Excellent', waterAccess: 'Variable' },
            'New Zealand': { tolls: 'Very Few', tollClass: 'good', camping: 'Freedom OK', campingClass: 'good', fuel: '$1.70/L', fuelClass: 'moderate', visa: '3 months', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'South Africa': { tolls: 'Moderate', tollClass: 'moderate', camping: 'Variable', campingClass: 'moderate', fuel: '$1.10/L', fuelClass: 'good', visa: '90 days', roadQuality: 'Good', waterAccess: 'Variable' },
            'Morocco': { tolls: 'Cheap', tollClass: 'good', camping: 'Very Easy', campingClass: 'good', fuel: '$1.20/L', fuelClass: 'good', visa: '90 days', roadQuality: 'Variable', waterAccess: 'Moderate' },
            'Japan': { tolls: 'Very High', tollClass: 'bad', camping: 'Michi-no-Eki', campingClass: 'moderate', fuel: '$1.40/L', fuelClass: 'good', visa: '90 days', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Namibia': { tolls: 'None!', tollClass: 'good', camping: 'Excellent', campingClass: 'good', fuel: '~$1.10/L', fuelClass: 'good', visa: '90 days free', roadQuality: 'Gravel roads', waterAccess: 'Plan ahead', special: '4x4 + rooftop tent recommended. Book NWR camps early!' }
        };

        // Default vanlifer info
        const defaultVanliferInfo = { tolls: 'Unknown', tollClass: 'moderate', camping: 'Research needed', campingClass: 'moderate', fuel: 'Varies', fuelClass: 'moderate', visa: 'Check requirements', roadQuality: 'Variable', waterAccess: 'Variable' };

        // ==================== CONTINENT MAPPING ====================
        const continentMapping = {
            '840': 'North America', '124': 'North America', '484': 'North America',
            '76': 'South America', '32': 'South America', '152': 'South America', '170': 'South America', '604': 'South America',
            '250': 'Europe', '276': 'Europe', '380': 'Europe', '724': 'Europe', '620': 'Europe', '826': 'Europe', '372': 'Europe',
            '752': 'Europe', '578': 'Europe', '352': 'Europe', '642': 'Europe', '300': 'Europe', '756': 'Europe',
            '156': 'Asia', '392': 'Asia', '410': 'Asia', '764': 'Asia', '704': 'Asia', '356': 'Asia',
            '36': 'Oceania', '554': 'Oceania',
            '710': 'Africa', '504': 'Africa', '818': 'Africa', '404': 'Africa'
        };

        // ==================== INITIALIZE ====================
        async function initMap() {
            svg = d3.select("#worldMap");
            g = svg.append("g");

            projection = d3.geoMercator()
                .scale(320)
                .translate([1000, 650]);

            path = d3.geoPath().projection(projection);

            try {
                const world = await d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json");
                const countries = topojson.feature(world, world.objects.countries);
                
                g.selectAll("path")
                    .data(countries.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .style("fill", DEFAULT_COLOR)
                    .attr("id", d => "country_" + d.id)
                    .attr("data-id", d => d.id)
                    .attr("data-name", d => d.properties.name || "Unknown")
                    .on("click", function(event, d) {
                        event.stopPropagation();
                        selectCountry(this, d);
                    })
                    .append("title")
                    .text(d => d.properties.name || "Unknown");

                countriesData = countries.features;
                populateCountrySearch();
                setupZoom();
                loadFromStorage();
                updateStats();
                renderRoadTrips();
                renderAlerts();
                
            } catch (error) {
                console.error("Error loading map:", error);
            }
        }

        function initRoadMap() {
            if (roadMap) return;
            
            roadMap = L.map('roadMap', {
                center: [30, 0],
                zoom: 2,
                zoomControl: false
            });

            // Base dark layer
            const darkBase = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap, ¬© CARTO',
                maxZoom: 19
            });

            // Roads overlay - this shows highways prominently!
            const roadsOverlay = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            });

            // Alternative: OpenStreetMap style showing roads better
            const osmRoads = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19,
                className: 'osm-roads-layer'
            });

            // Stamen terrain for adventure feel
            const stamenTerrain = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}{r}.png', {
                attribution: '¬© Stadia Maps, ¬© OpenStreetMap',
                maxZoom: 18
            });

            // Default: Dark with roads
            darkBase.addTo(roadMap);
            roadsOverlay.addTo(roadMap);

            // Layer control
            const baseLayers = {
                "üåô Dark Mode": darkBase,
                "üó∫Ô∏è Terrain": stamenTerrain,
                "üõ£Ô∏è OpenStreetMap": osmRoads
            };
            L.control.layers(baseLayers, null, { position: 'topright' }).addTo(roadMap);

            // Add road trip routes
            roadTrips.forEach(trip => {
                if (trip.waypoints && trip.waypoints.length > 1) {
                    const coords = trip.waypoints.map(w => [w[0], w[1]]);
                    
                    // Draw route line - different color for personal trips
                    const routeColor = trip.personalTrip ? '#22c55e' : '#f472b6';
                    const routeLine = L.polyline(coords, {
                        color: routeColor,
                        weight: trip.personalTrip ? 4 : 3,
                        opacity: 0.9,
                        dashArray: trip.personalTrip ? null : '10, 5'
                    }).addTo(roadMap);

                    // Add markers for waypoints
                    trip.waypoints.forEach((wp, idx) => {
                        const isStart = idx === 0;
                        const isEnd = idx === trip.waypoints.length - 1;
                        const markerIcon = isStart ? 'üöó' : (isEnd ? 'üèÅ' : 'üìç');
                        
                        const marker = L.marker([wp[0], wp[1]], {
                            icon: L.divIcon({
                                className: `custom-marker ${trip.personalTrip ? 'poi-marker' : 'poi-marker'}`,
                                html: markerIcon,
                                iconSize: [30, 30]
                            })
                        }).addTo(roadMap);

                        marker.bindPopup(`
                            <div class="route-popup">
                                <h4>${wp[2]}</h4>
                                <p><strong>${trip.icon} ${trip.name}</strong></p>
                                ${trip.personalTrip ? '<div style="color: #22c55e; font-size: 0.8rem;">‚úì Visit√©</div>' : ''}
                                <div style="font-size: 0.8rem; color: #9494a8;">${trip.description}</div>
                            </div>
                        `);
                    });

                    // Add camping markers for trips that have them
                    if (trip.campingSites) {
                        trip.campingSites.forEach(camp => {
                            if (camp.coords) {
                                const campMarker = L.marker(camp.coords, {
                                    icon: L.divIcon({
                                        className: 'custom-marker',
                                        html: 'üèïÔ∏è',
                                        iconSize: [26, 26]
                                    })
                                }).addTo(roadMap);

                                campMarker.bindPopup(`
                                    <div class="route-popup">
                                        <h4>üèïÔ∏è ${camp.name}</h4>
                                        <p><strong>${camp.type}</strong> - ${camp.location}</p>
                                        <div style="color: #22c55e; font-weight: bold;">${camp.price}/nuit</div>
                                        <div style="font-size: 0.8rem; color: #9494a8; margin-top: 4px;">${camp.facilities}</div>
                                    </div>
                                `);
                            }
                        });
                    }

                    routeLine.bindPopup(`
                        <div class="route-popup">
                            <h4>${trip.icon} ${trip.name}</h4>
                            <p>${trip.distance} ‚Ä¢ ${trip.duration}</p>
                            ${trip.personalTrip ? '<div style="color: #22c55e;">‚úì Mon voyage - ' + trip.tripDate + '</div>' : ''}
                            <div style="font-size: 0.8rem; margin-top: 8px;">${trip.tips}</div>
                        </div>
                    `);
                }
            });

            // Add community alert markers
            communityAlerts.forEach(alert => {
                if (alert.lat && alert.lng) {
                    const alertIcon = L.divIcon({
                        className: `custom-marker ${alert.type === 'hazard' ? 'danger-marker' : 'alert-marker'}`,
                        html: getAlertIcon(alert.type),
                        iconSize: [30, 30]
                    });

                    L.marker([alert.lat, alert.lng], { icon: alertIcon })
                        .addTo(roadMap)
                        .bindPopup(`<div class="route-popup"><h4>${alert.title}</h4><p>${alert.description}</p></div>`);
                }
            });
        }

        // ==================== MODE SWITCHING ====================
        function switchMode(mode) {
            currentMode = mode;
            
            // Update tabs
            document.getElementById('diaryModeTab').classList.toggle('active', mode === 'diary');
            document.getElementById('serendipityModeTab').classList.toggle('active', mode === 'serendipity');
            
            // Update content visibility
            document.getElementById('diaryContent').classList.toggle('hidden', mode !== 'diary');
            document.getElementById('serendipityContent').classList.toggle('active', mode === 'serendipity');
            
            // Update logo
            const logoIcon = document.getElementById('logoIcon');
            const logoText = document.getElementById('logoText');
            
            if (mode === 'serendipity') {
                logoIcon.textContent = 'üõ£Ô∏è';
                logoIcon.classList.add('serendipity-mode');
                logoText.textContent = 'Serendipity';
                
                // Show road map
                document.getElementById('worldMap').style.display = 'none';
                document.getElementById('roadMap').classList.add('active');
                document.getElementById('zoomControls').style.display = 'none';
                
                initRoadMap();
                setTimeout(() => roadMap.invalidateSize(), 100);
            } else {
                logoIcon.textContent = 'üó∫Ô∏è';
                logoIcon.classList.remove('serendipity-mode');
                logoText.textContent = 'Travel Diary';
                
                // Show world map
                document.getElementById('worldMap').style.display = 'block';
                document.getElementById('roadMap').classList.remove('active');
                document.getElementById('zoomControls').style.display = 'flex';
            }
        }

        // ==================== COUNTRY SELECTION ====================
        function populateCountrySearch() {
            const select = document.getElementById('countrySearch');
            const sorted = countriesData
                .map(d => ({ id: d.id, name: d.properties.name || "Unknown" }))
                .sort((a, b) => a.name.localeCompare(b.name));

            sorted.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                select.appendChild(opt);
            });
        }

        function selectCountryByCode(id) {
            if (!id) return;
            const el = document.querySelector(`[data-id="${id}"]`);
            if (el) {
                const data = countriesData.find(d => d.id == id);
                selectCountry(el, data);
            }
        }

        function selectCountry(element, data) {
            if (selectedCountry) {
                d3.select(selectedCountry).classed("selected", false);
            }

            selectedCountry = element;
            currentCountryId = data.id;
            currentCountryName = data.properties.name || "Unknown";
            d3.select(selectedCountry).classed("selected", true);

            document.getElementById('selectedCountryName').textContent = currentCountryName;
            document.getElementById('selectedDisplay').classList.add('has-selection');
            document.getElementById('countrySearch').value = data.id;

            // Update vanlifer info if in serendipity mode
            if (currentMode === 'serendipity') {
                showVanliferInfo(currentCountryName);
            }
        }

        function showVanliferInfo(countryName) {
            const info = vanliferInfo[countryName] || defaultVanliferInfo;
            const panel = document.getElementById('vanliferCountryInfo');
            
            document.getElementById('vanliferCountryName').textContent = countryName;
            document.getElementById('tollInfo').textContent = info.tolls;
            document.getElementById('tollInfo').className = `detail-value ${info.tollClass}`;
            document.getElementById('campingInfo').textContent = info.camping;
            document.getElementById('campingInfo').className = `detail-value ${info.campingClass}`;
            document.getElementById('fuelInfo').textContent = info.fuel;
            document.getElementById('fuelInfo').className = `detail-value ${info.fuelClass}`;
            document.getElementById('visaInfo').textContent = info.visa;
            document.getElementById('roadQualityInfo').textContent = info.roadQuality;
            document.getElementById('waterInfo').textContent = info.waterAccess;
            
            panel.style.display = 'block';
        }

        // ==================== ROAD TRIPS ====================
        function renderRoadTrips() {
            const container = document.getElementById('roadTripsList');
            container.innerHTML = roadTrips.map(trip => `
                <div class="road-trip-card ${activeRoute === trip.id ? 'active' : ''} ${trip.personalTrip ? 'personal' : ''}" onclick="selectRoute('${trip.id}')">
                    <div class="road-trip-header">
                        <span class="road-trip-icon">${trip.icon}</span>
                        <span class="road-trip-name">${trip.name}</span>
                        ${trip.personalTrip ? `<span class="personal-badge">‚úì Mon voyage</span>` : ''}
                    </div>
                    <div class="road-trip-meta">
                        <span>üìç ${trip.country}</span>
                        <span>üìè ${trip.distance}</span>
                        <span>‚è±Ô∏è ${trip.duration}</span>
                    </div>
                    ${trip.tripDate ? `<div style="font-size: 0.7rem; color: var(--success); margin-top: 4px;">üìÖ ${trip.tripDate}</div>` : ''}
                    <div class="road-trip-tags">
                        ${trip.tags.map(t => `<span class="road-tag ${t}">${t === 'fourx4' ? '4x4' : t}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function selectRoute(routeId) {
            activeRoute = routeId;
            renderRoadTrips();
            
            const trip = roadTrips.find(t => t.id === routeId);
            if (trip && roadMap && trip.waypoints) {
                const bounds = L.latLngBounds(trip.waypoints.map(w => [w[0], w[1]]));
                roadMap.fitBounds(bounds, { padding: [50, 50] });
                
                // Show route details panel if route has rental/camping info
                const detailsPanel = document.getElementById('routeDetailsPanel');
                if (trip.rentalProviders || trip.campingSites) {
                    detailsPanel.style.display = 'block';
                    renderRouteDetails(trip);
                } else {
                    detailsPanel.style.display = 'none';
                }
            }
            
            updateStats();
        }

        function renderRouteDetails(trip) {
            // Render rental providers
            const rentalContainer = document.getElementById('rentalProvidersList');
            if (trip.rentalProviders && trip.rentalProviders.length > 0) {
                rentalContainer.innerHTML = trip.rentalProviders.map(r => `
                    <div class="rental-card">
                        <div class="rental-header">
                            <span class="rental-name"><a href="${r.url}" target="_blank">üöô ${r.name}</a></span>
                            <span class="rental-rating">${r.rating}</span>
                        </div>
                        <div class="rental-note">${r.note}</div>
                    </div>
                `).join('');
            } else {
                rentalContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.8rem;">Pas d\'info disponible</p>';
            }

            // Render camping sites
            const campingContainer = document.getElementById('campingSitesList');
            if (trip.campingSites && trip.campingSites.length > 0) {
                campingContainer.innerHTML = trip.campingSites.map(c => `
                    <div class="camping-card" onclick="focusOnCamping(${c.coords[0]}, ${c.coords[1]}, '${c.name}')">
                        <div class="camping-header">
                            <span class="camping-name">üèïÔ∏è ${c.name}</span>
                            <span class="camping-type ${c.type.toLowerCase()}">${c.type}</span>
                        </div>
                        <div class="camping-location">üìç ${c.location}</div>
                        <div class="camping-info">
                            <span class="camping-price">üí∞ ${c.price}/nuit</span>
                            <span class="camping-facilities">${c.facilities}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                campingContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.8rem;">Pas d\'info disponible</p>';
            }
        }

        function focusOnCamping(lat, lng, name) {
            if (roadMap) {
                roadMap.setView([lat, lng], 12);
                L.popup()
                    .setLatLng([lat, lng])
                    .setContent(`<div class="route-popup"><h4>üèïÔ∏è ${name}</h4></div>`)
                    .openOn(roadMap);
            }
        }

        // ==================== COMMUNITY ALERTS ====================
        function renderAlerts() {
            const container = document.getElementById('alertsList');
            
            // Default sample alerts
            if (communityAlerts.length === 0) {
                communityAlerts = [
                    { id: 1, type: 'tip', title: 'Dune 45 Lever du soleil', description: 'Arrivez avant 5h30 pour le lever de soleil sur Dune 45. Magique! Pr√©voir lampe frontale.', location: 'Sossusvlei, Namibie', date: '1 semaine', lat: -24.7275, lng: 15.4739 },
                    { id: 2, type: 'camping', title: 'Sesriem = Acc√®s prioritaire', description: 'Dormir au camp NWR Sesriem permet d\'entrer dans le parc 1h avant les autres visiteurs!', location: 'Sesriem, Namibie', date: '2 semaines', lat: -24.4800, lng: 15.8300 },
                    { id: 3, type: 'hazard', title: 'Piste sableuse D707', description: 'Route tr√®s sableuse entre Solitaire et Walvis Bay. 4x4 indispensable, r√©duire pression pneus.', location: 'D707, Namibie', date: '3 semaines', lat: -23.5500, lng: 15.2000 },
                    { id: 4, type: 'fuel', title: 'Derni√®re station avant Sossusvlei', description: 'Faites le plein √† Solitaire! Prochaine station √† 200km.', location: 'Solitaire, Namibie', date: '1 mois', lat: -23.8900, lng: 16.0100 },
                    { id: 5, type: 'tip', title: '√âl√©phants du d√©sert √† Palmwag', description: 'Game drive matinal √† Palmwag = quasi garanti de voir les √©l√©phants du d√©sert!', location: 'Palmwag, Namibie', date: '1 mois', lat: -19.8800, lng: 13.9500 },
                    { id: 6, type: 'camping', title: 'Okaukuejo Waterhole', description: 'Le waterhole d\'Okaukuejo est illumin√© la nuit. Rhinos noirs r√©guliers apr√®s 22h!', location: 'Etosha, Namibie', date: '1 mois', lat: -18.9000, lng: 15.9200 },
                    { id: 7, type: 'road_work', title: 'Road Construction', description: 'I-40 near Flagstaff, expect delays', location: 'Route 66, Arizona', date: '2 hours ago', lat: 35.2, lng: -111.6 },
                    { id: 8, type: 'hazard', title: 'Pothole Warning', description: 'Large potholes after km marker 245', location: 'TransfƒÉgƒÉrƒÉ»ôan, Romania', date: '3 days ago', lat: 45.6, lng: 24.6 }
                ];
            }

            container.innerHTML = communityAlerts.map(alert => `
                <div class="alert-item ${alert.type === 'hazard' ? 'danger' : (alert.type === 'camping' || alert.type === 'tip' ? 'success' : '')}">
                    <span class="alert-icon">${getAlertIcon(alert.type)}</span>
                    <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-desc">${alert.description}</div>
                        <div class="alert-meta">üìç ${alert.location} ‚Ä¢ ${alert.date}</div>
                    </div>
                </div>
            `).join('');
        }

        function getAlertIcon(type) {
            const icons = {
                'road_work': 'üöß',
                'hazard': '‚ö†Ô∏è',
                'police': 'üëÆ',
                'fuel': '‚õΩ',
                'camping': 'üèïÔ∏è',
                'tip': 'üí°'
            };
            return icons[type] || 'üìç';
        }

        function openAlertModal() {
            document.getElementById('alertModal').classList.add('active');
        }

        function closeAlertModal() {
            document.getElementById('alertModal').classList.remove('active');
        }

        function submitAlert() {
            const type = document.getElementById('alertType').value;
            const location = document.getElementById('alertLocation').value;
            const description = document.getElementById('alertDescription').value;

            if (!location || !description) {
                alert('Please fill in all fields');
                return;
            }

            const newAlert = {
                id: Date.now(),
                type: type,
                title: document.getElementById('alertType').options[document.getElementById('alertType').selectedIndex].text.replace(/[^\w\s]/g, '').trim(),
                description: description,
                location: location,
                date: 'Just now'
            };

            communityAlerts.unshift(newAlert);
            renderAlerts();
            closeAlertModal();
            saveToStorage();

            // Clear form
            document.getElementById('alertLocation').value = '';
            document.getElementById('alertDescription').value = '';
        }

        // ==================== MAP ACTIONS ====================
        function markAsVisited() {
            if (!selectedCountry) {
                alert('Please select a country first');
                return;
            }
            d3.select(selectedCountry).style('fill', VISITED_COLOR);
            countryColors[currentCountryId] = VISITED_COLOR;
            saveToStorage();
            updateStats();
        }

        function resetMap() {
            if (confirm('Reset all progress?')) {
                g.selectAll("path").style('fill', DEFAULT_COLOR);
                countryColors = {};
                selectedCountry = null;
                document.getElementById('selectedCountryName').textContent = 'Click a country';
                document.getElementById('selectedDisplay').classList.remove('has-selection');
                document.getElementById('countrySearch').value = '';
                saveToStorage();
                updateStats();
            }
        }

        function updateStats() {
            const visited = Object.keys(countryColors).length;
            document.getElementById('countriesVisited').textContent = visited;

            const continents = new Set();
            Object.keys(countryColors).forEach(id => {
                if (continentMapping[id]) continents.add(continentMapping[id]);
            });
            document.getElementById('continentsExplored').textContent = continents.size;

            // Update serendipity stats
            document.getElementById('routesExplored').textContent = activeRoute ? 1 : 0;
            document.getElementById('kmTraveled').textContent = activeRoute ? 
                roadTrips.find(r => r.id === activeRoute)?.distance.replace(' km', '') || '0' : '0';
        }

        // ==================== ZOOM ====================
        let zoom;

        function setupZoom() {
            zoom = d3.zoom()
                .scaleExtent([1, 8])
                .on("zoom", (event) => g.attr("transform", event.transform));
            svg.call(zoom);
        }

        function zoomIn() {
            if (currentMode === 'serendipity' && roadMap) {
                roadMap.zoomIn();
            } else {
                svg.transition().call(zoom.scaleBy, 1.5);
            }
        }

        function zoomOut() {
            if (currentMode === 'serendipity' && roadMap) {
                roadMap.zoomOut();
            } else {
                svg.transition().call(zoom.scaleBy, 0.67);
            }
        }

        function resetZoom() {
            if (currentMode === 'serendipity' && roadMap) {
                roadMap.setView([30, 0], 2);
            } else {
                svg.transition().call(zoom.transform, d3.zoomIdentity);
            }
        }

        // ==================== STORAGE ====================
        function saveToStorage() {
            const data = {
                countryColors,
                communityAlerts,
                activeRoute
            };
            localStorage.setItem('travelDiarySerendipity', JSON.stringify(data));
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('travelDiarySerendipity');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.countryColors) {
                        countryColors = data.countryColors;
                        Object.keys(countryColors).forEach(id => {
                            const el = document.querySelector(`[data-id="${id}"]`);
                            if (el) d3.select(el).style('fill', countryColors[id]);
                        });
                    }
                    if (data.communityAlerts) communityAlerts = data.communityAlerts;
                    if (data.activeRoute) activeRoute = data.activeRoute;
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        // ==================== EXPORT/IMPORT ====================
        function exportData() {
            const data = {
                countryColors,
                communityAlerts,
                activeRoute,
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'travel-diary-' + Date.now() + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.countryColors) {
                        countryColors = data.countryColors;
                        Object.keys(countryColors).forEach(id => {
                            const el = document.querySelector(`[data-id="${id}"]`);
                            if (el) d3.select(el).style('fill', countryColors[id]);
                        });
                    }
                    if (data.communityAlerts) {
                        communityAlerts = data.communityAlerts;
                        renderAlerts();
                    }
                    saveToStorage();
                    updateStats();
                    alert('Data imported successfully!');
                } catch (err) {
                    alert('Error importing file');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ==================== KEYBOARD ====================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAlertModal();
        });

        // ==================== INIT ====================
        initMap();
    </script>
</body>
</html>
