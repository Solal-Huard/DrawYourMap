<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw Your Map - Travel Diary & Road Trip Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Leaflet CSS for road maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0d0d12;
            --bg-panel: #151520;
            --bg-elevated: #1c1c2a;
            --bg-hover: #252538;
            --accent-primary: #6366f1;
            --accent-secondary: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --text-primary: #f1f1f4;
            --text-secondary: #9494a8;
            --text-muted: #5e5e72;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-accent: rgba(99, 102, 241, 0.5);
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --serendipity: #f472b6;
            --road-primary: #fbbf24;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            min-height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary), #8b5cf6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .logo-icon.serendipity-mode {
            background: linear-gradient(135deg, var(--serendipity), var(--road-primary));
        }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            padding: 12px;
            gap: 8px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .mode-tab {
            flex: 1;
            padding: 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .mode-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .mode-tab.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .mode-tab.serendipity.active {
            background: linear-gradient(135deg, var(--serendipity), var(--road-primary));
            border-color: var(--serendipity);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 3px;
        }

        /* Section */
        .section {
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 10px;
            padding-left: 4px;
        }

        /* Stats */
        .travel-stats {
            background: linear-gradient(135deg, var(--bg-elevated), var(--bg-hover));
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-box {
            text-align: center;
        }

        .stat-box .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-box .stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Buttons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), #8b5cf6);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-accent);
        }

        .btn-serendipity {
            background: linear-gradient(135deg, var(--serendipity), var(--road-primary));
            color: white;
            font-weight: 600;
        }

        .btn-serendipity:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(244, 114, 182, 0.4);
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Selected Display */
        .selected-display {
            background: linear-gradient(135deg, var(--bg-elevated), var(--bg-hover));
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .selected-display.has-selection {
            border-color: var(--border-accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .selected-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .selected-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Search */
        .search-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .search-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            background: var(--bg-dark);
            overflow: hidden;
        }

        #worldMap {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        #worldMap:active {
            cursor: grabbing;
        }

        #worldMap path {
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 0.5;
            transition: filter 0.15s, stroke 0.15s;
        }

        #worldMap path:hover {
            stroke: var(--accent-primary);
            stroke-width: 1;
            filter: brightness(1.3);
            cursor: pointer;
        }

        #worldMap path.selected {
            stroke: var(--accent-secondary);
            stroke-width: 2;
            filter: drop-shadow(0 0 8px var(--accent-glow));
        }

        /* Leaflet Road Map */
        #roadMap {
            width: 100%;
            height: 100%;
            display: none;
            background: #1a1a2e;
        }

        #roadMap.active {
            display: block;
        }

        .leaflet-container {
            background: #1a1a2e;
            font-family: 'DM Sans', sans-serif;
        }

        /* Leaflet control styling */
        .leaflet-control-layers {
            background: var(--bg-panel) !important;
            border: 1px solid var(--border-subtle) !important;
            border-radius: 10px !important;
            color: var(--text-primary) !important;
        }

        .leaflet-control-layers-expanded {
            padding: 10px 14px !important;
        }

        .leaflet-control-layers label {
            color: var(--text-primary) !important;
            font-size: 0.85rem;
        }

        .leaflet-popup-content-wrapper {
            background: var(--bg-panel) !important;
            border-radius: 12px !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5) !important;
        }

        .leaflet-popup-content {
            color: var(--text-primary) !important;
            margin: 12px 14px !important;
        }

        .leaflet-popup-tip {
            background: var(--bg-panel) !important;
        }

        .leaflet-control-attribution {
            background: rgba(21, 21, 32, 0.8) !important;
            color: var(--text-muted) !important;
            font-size: 0.65rem !important;
        }

        .leaflet-control-attribution a {
            color: var(--accent-secondary) !important;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 50;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* ==================== SERENDIPITY PANEL ==================== */
        .serendipity-content {
            display: none;
        }

        .serendipity-content.active {
            display: block;
        }

        .road-trip-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .road-trip-card:hover {
            border-color: var(--serendipity);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(244, 114, 182, 0.2);
        }

        .road-trip-card.active {
            border-color: var(--serendipity);
            background: rgba(244, 114, 182, 0.1);
        }

        .road-trip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .road-trip-icon {
            font-size: 1.5rem;
        }

        .road-trip-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .road-trip-meta {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .road-trip-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .road-trip-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .road-tag {
            padding: 4px 10px;
            background: var(--bg-dark);
            border-radius: 12px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .road-tag.toll-free { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .road-tag.scenic { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
        .road-tag.adventure { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .road-tag.camping { background: rgba(20, 184, 166, 0.2); color: #14b8a6; }
        .road-tag.fourx4 { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .road-tag.wildlife { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .road-tag.historic { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .road-tag.epic { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .road-tag.community { background: rgba(244, 114, 182, 0.2); color: #f472b6; }

        /* Enhanced Road Trip Card */
        .road-trip-card {
            position: relative;
            transition: all 0.3s ease;
        }

        .road-trip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .road-trip-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: #fbbf24;
            margin-top: 6px;
        }

        .road-trip-rating .rating-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .difficulty-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 500;
            margin-left: 8px;
        }

        .difficulty-badge.easy { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .difficulty-badge.moderate { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .difficulty-badge.challenging { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .difficulty-badge.extreme { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        .view-details-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            padding: 6px 12px;
            font-size: 0.7rem;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }

        .road-trip-card:hover .view-details-btn {
            opacity: 1;
        }

        /* Trip Fullscreen Modal - New Design */
        .trip-fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-dark);
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .trip-fullscreen-modal.active {
            display: flex;
        }

        /* Hero Header */
        .trip-hero {
            position: relative;
            min-height: 280px;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%);
            display: flex;
            align-items: flex-end;
            padding: 40px 60px;
            overflow: hidden;
        }

        .trip-hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.5;
        }

        .trip-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .trip-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .trip-hero-content {
            position: relative;
            z-index: 5;
        }

        .trip-hero-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 16px;
        }

        .hero-icon {
            font-size: 3rem;
        }

        .trip-hero-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            margin: 0 0 12px 0;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }

        .trip-hero-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 12px;
        }

        .hero-meta-divider {
            opacity: 0.4;
        }

        .trip-hero-rating {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .hero-stars {
            font-size: 1.1rem;
        }

        .hero-rating-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #fbbf24;
        }

        .hero-reviews-count {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .trip-hero-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .trip-hero-tags .tag {
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Navigation Tabs */
        .trip-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 60px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
        }

        .trip-nav-tabs {
            display: flex;
            gap: 0;
        }

        .trip-nav-tab {
            padding: 18px 28px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .trip-nav-tab:hover {
            color: var(--text-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .trip-nav-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .trip-nav-actions {
            display: flex;
            gap: 10px;
        }

        .trip-action-btn {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trip-action-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* Tab Content */
        .trip-content-container {
            flex: 1;
            overflow-y: auto;
            padding: 32px 60px;
        }

        .trip-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .trip-tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Grid Layouts */
        .trip-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 32px;
        }

        .trip-main-col, .trip-side-col {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Stats Row */
        .trip-stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .trip-stat-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
        }

        .trip-stat-card .stat-icon {
            font-size: 2rem;
        }

        .trip-stat-card .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .trip-stat-card .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Trip Cards */
        .trip-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
        }

        .trip-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 16px 0;
            color: var(--text-primary);
        }

        .trip-card.warning-card {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(249, 115, 22, 0.1));
            border-color: rgba(251, 191, 36, 0.3);
        }

        .trip-card.recommendations-card {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(20, 184, 166, 0.1));
            border-color: rgba(34, 197, 94, 0.3);
        }

        .trip-description {
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        /* Highlights */
        .trip-highlights {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .trip-highlights .highlight-tag {
            padding: 10px 18px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Must Know */
        .must-know-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .must-know-list li {
            padding: 12px 0;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .must-know-list li:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        /* Recommendations */
        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recommendation-item {
            display: flex;
            gap: 14px;
            padding: 14px;
            background: var(--bg-dark);
            border-radius: 12px;
        }

        .recommendation-item .rec-icon {
            font-size: 1.5rem;
        }

        .recommendation-item .rec-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .recommendation-item .rec-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Packing List */
        .packing-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .packing-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-dark);
            border-radius: 10px;
            font-size: 0.85rem;
        }

        .packing-item.essential {
            border-left: 3px solid var(--warning);
        }

        /* Route Tab */
        .route-card {
            max-width: 800px;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .route-header h3 {
            margin: 0;
        }

        .stops-count {
            padding: 6px 14px;
            background: var(--accent-primary);
            color: white;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .route-timeline {
            position: relative;
            padding-left: 40px;
        }

        .route-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--accent-primary), var(--serendipity));
            border-radius: 2px;
        }

        .waypoint-item {
            position: relative;
            padding: 20px;
            margin-bottom: 16px;
            background: var(--bg-dark);
            border-radius: 12px;
        }

        .waypoint-item::before {
            content: '';
            position: absolute;
            left: -32px;
            top: 24px;
            width: 16px;
            height: 16px;
            background: var(--accent-primary);
            border: 3px solid var(--bg-elevated);
            border-radius: 50%;
        }

        .waypoint-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .waypoint-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Budget Tab */
        .budget-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            max-width: 1000px;
        }

        .budget-breakdown, .budget-tips {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 28px;
        }

        .budget-breakdown h3, .budget-tips h3 {
            margin: 0 0 24px 0;
            font-size: 1.2rem;
        }

        .budget-items {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .budget-item {
            display: grid;
            grid-template-columns: 50px 1fr 120px;
            align-items: center;
            gap: 16px;
        }

        .budget-item-icon {
            font-size: 1.8rem;
        }

        .budget-item-label {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .budget-item-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--success);
            text-align: right;
        }

        .budget-item-bar {
            grid-column: 1 / -1;
            height: 6px;
            background: var(--bg-dark);
            border-radius: 3px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 3px;
        }

        .bar-fill.fuel { width: 25%; background: #f97316; }
        .bar-fill.tolls { width: 5%; background: #8b5cf6; }
        .bar-fill.accommodation { width: 45%; background: #3b82f6; }
        .bar-fill.food { width: 25%; background: #22c55e; }

        .budget-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-top: 24px;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(20, 184, 166, 0.2));
            border-radius: 12px;
            font-weight: 600;
        }

        .budget-total-value {
            font-size: 1.5rem;
            color: var(--success);
        }

        .budget-tips-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .budget-tip {
            padding: 14px 16px;
            background: var(--bg-dark);
            border-radius: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Planning Tab */
        .planning-steps-container {
            max-width: 800px;
        }

        .planning-steps-container h3 {
            margin-bottom: 24px;
        }

        .planning-timeline {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .planning-step {
            display: flex;
            gap: 20px;
            padding: 24px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
        }

        .step-number {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-primary), var(--serendipity));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .step-desc {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Community Tab */
        .community-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        .community-reviews, .community-chat {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
        }

        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .reviews-header h3 {
            margin: 0;
        }

        .reviews-summary {
            text-align: center;
        }

        .big-rating {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fbbf24;
        }

        .reviews-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .review-item {
            padding: 16px;
            background: var(--bg-dark);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .review-user {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .review-rating {
            color: #fbbf24;
        }

        .review-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .review-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .add-review-box {
            padding: 20px;
            background: var(--bg-dark);
            border-radius: 12px;
        }

        .add-review-box h4 {
            margin: 0 0 12px 0;
            font-size: 0.95rem;
        }

        .rating-input {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .rating-star {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .rating-star:hover, .rating-star.active {
            color: #fbbf24;
        }

        .review-textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: none;
            height: 80px;
            margin-bottom: 12px;
        }

        .review-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .submit-review-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-primary);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-review-btn:hover {
            background: var(--accent-secondary);
        }

        /* Chat in Community */
        .chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chat-header h3 {
            margin: 0;
        }

        .online-badge {
            padding: 6px 12px;
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .chat-messages {
            flex: 1;
            max-height: 280px;
            overflow-y: auto;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .chat-message {
            padding: 12px 14px;
            margin-bottom: 10px;
            background: var(--bg-elevated);
            border-radius: 12px;
            border-left: 3px solid var(--border-subtle);
        }

        .chat-message.question { border-left-color: var(--accent-primary); }
        .chat-message.tip { border-left-color: var(--success); }
        .chat-message.experience { border-left-color: var(--warning); }

        .chat-msg-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .chat-msg-user {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--accent-primary);
        }

        .chat-msg-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--bg-dark);
        }

        .chat-msg-badge.verified { background: var(--success); color: white; }
        .chat-msg-badge.expert { background: var(--warning); color: var(--bg-dark); }

        .chat-msg-text {
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .chat-msg-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .chat-msg-reactions {
            display: flex;
            gap: 8px;
        }

        .chat-reaction {
            cursor: pointer;
            padding: 2px 8px;
            background: var(--bg-dark);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .chat-reaction:hover {
            background: rgba(99, 102, 241, 0.3);
        }

        .chat-replies {
            margin-top: 10px;
            padding-left: 12px;
            border-left: 2px solid var(--border-subtle);
        }

        .chat-reply {
            padding: 8px 12px;
            margin-top: 8px;
            background: var(--bg-dark);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .chat-input-section {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 12px;
        }

        .chat-type-pills {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .chat-pill {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-pill:hover {
            border-color: var(--accent-primary);
        }

        .chat-pill.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .chat-input-row {
            display: flex;
            gap: 10px;
        }

        .chat-text-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .chat-text-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .chat-submit-btn {
            padding: 12px 24px;
            background: var(--accent-primary);
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-submit-btn:hover {
            background: var(--accent-secondary);
        }

        .highlight-tag {
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--accent-primary), var(--serendipity));
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .waypoints-timeline {
            position: relative;
            padding-left: 30px;
        }

        .waypoints-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--accent-primary), var(--serendipity));
        }

        .waypoint-item {
            position: relative;
            padding: 12px 0;
            padding-left: 20px;
        }

        .waypoint-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--accent-primary);
            border-radius: 50%;
            border: 2px solid var(--bg-panel);
        }

        .waypoint-item:first-child::before { background: #22c55e; }
        .waypoint-item:last-child::before { background: #ef4444; }

        .waypoint-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .waypoint-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Reviews */
        .reviews-section {
            flex: 1;
            margin-bottom: 16px;
        }

        .reviews-section h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .reviews-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .review-item {
            padding: 14px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .review-item.owner-review {
            border-left: 3px solid var(--success);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), transparent);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .review-user {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .review-rating {
            color: #fbbf24;
            font-size: 0.8rem;
        }

        .review-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .review-date {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .add-review-section {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 14px;
            margin-top: 16px;
        }

        .add-review-section h5 {
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        .rating-input {
            display: flex;
            gap: 4px;
            margin-bottom: 10px;
        }

        .rating-star {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
        }

        .rating-star:hover,
        .rating-star.active {
            color: #fbbf24;
        }

        .trip-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn-success {
            background: var(--success);
            color: white;
            border: none;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        /* Cost Section */
        .cost-section {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(20, 184, 166, 0.1));
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 12px;
            padding: 16px;
        }

        .cost-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .cost-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 10px;
        }

        .cost-icon {
            font-size: 1.5rem;
        }

        .cost-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .cost-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--success);
        }

        .cost-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-dark);
            border-radius: 10px;
            font-weight: 600;
        }

        .total-value {
            font-size: 1.2rem;
            color: var(--success);
        }

        /* Planning Section */
        .planning-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 16px;
        }

        .planning-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .planning-step {
            display: flex;
            gap: 14px;
            padding: 14px;
            background: var(--bg-dark);
            border-radius: 10px;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: var(--accent-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .step-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Recommendations Section */
        .recommendations-section {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(249, 115, 22, 0.1));
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 12px;
            padding: 16px;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .recommendation-card {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 10px;
        }

        .recommendation-icon {
            font-size: 1.3rem;
        }

        .recommendation-content {
            flex: 1;
        }

        .recommendation-title {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        .recommendation-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Packing Section */
        .packing-section {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
        }

        .packing-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .packing-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: var(--bg-dark);
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .packing-item.essential {
            border-left: 3px solid var(--warning);
        }

        /* Double-click hint */
        .dblclick-hint {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 8px;
            font-style: italic;
        }

        /* Trip Chat Section */
        .trip-chat-section {
            background: var(--bg-dark);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            margin-top: 16px;
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            border-bottom: 1px solid var(--border-subtle);
        }

        .chat-header h4 {
            margin: 0;
            font-size: 0.9rem;
        }

        .online-count {
            font-size: 0.75rem;
            color: var(--success);
        }

        .chat-messages {
            height: 280px;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            padding: 10px 12px;
            border-radius: 12px;
            background: var(--bg-elevated);
            max-width: 90%;
        }

        .chat-message.question {
            border-left: 3px solid var(--accent-primary);
        }

        .chat-message.tip {
            border-left: 3px solid var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .chat-message.experience {
            border-left: 3px solid var(--warning);
            background: rgba(251, 191, 36, 0.1);
        }

        .chat-message.own {
            margin-left: auto;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
        }

        .chat-msg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .chat-msg-user {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--accent-primary);
        }

        .chat-msg-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 8px;
            background: var(--bg-dark);
        }

        .chat-msg-badge.verified {
            background: var(--success);
            color: white;
        }

        .chat-msg-badge.expert {
            background: var(--warning);
            color: var(--bg-dark);
        }

        .chat-msg-text {
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .chat-msg-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .chat-msg-reactions {
            display: flex;
            gap: 8px;
        }

        .chat-reaction {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 10px;
            background: var(--bg-dark);
            transition: all 0.2s;
        }

        .chat-reaction:hover {
            background: var(--bg-elevated);
            transform: scale(1.1);
        }

        .chat-reaction.active {
            background: rgba(99, 102, 241, 0.3);
        }

        .chat-reply-btn {
            cursor: pointer;
            color: var(--accent-primary);
        }

        .chat-reply-btn:hover {
            text-decoration: underline;
        }

        .chat-replies {
            margin-top: 10px;
            padding-left: 12px;
            border-left: 2px solid var(--border-subtle);
        }

        .chat-reply {
            padding: 6px 10px;
            margin-top: 6px;
            background: var(--bg-dark);
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .chat-input-area {
            padding: 12px;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-elevated);
        }

        .chat-type-selector {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .chat-type-btn {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-dark);
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-type-btn:hover {
            border-color: var(--accent-primary);
        }

        .chat-type-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-dark);
            color: var(--text-primary);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-primary);
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            background: var(--accent-secondary);
            transform: scale(1.05);
        }

        .road-trip-card.personal {
            border-left: 3px solid var(--success);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), transparent);
        }

        .personal-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--success);
            color: white;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Rental Provider Card */
        .rental-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .rental-card:hover {
            border-color: var(--accent-primary);
        }

        .rental-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .rental-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .rental-name a {
            color: var(--accent-secondary);
            text-decoration: none;
        }

        .rental-name a:hover {
            text-decoration: underline;
        }

        .rental-rating {
            font-size: 0.75rem;
        }

        .rental-note {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Camping Site Card */
        .camping-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .camping-card:hover {
            border-color: var(--serendipity);
            transform: translateX(4px);
        }

        .camping-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .camping-name {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .camping-type {
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 500;
        }

        .camping-type.nwr {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .camping-type.private {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
        }

        .camping-location {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .camping-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
        }

        .camping-price {
            color: var(--success);
            font-weight: 500;
        }

        .camping-facilities {
            color: var(--text-muted);
            font-style: italic;
        }

        /* League System Styles */
        .league-section {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(244, 114, 182, 0.1));
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 12px;
            padding: 15px;
        }

        .league-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .league-stat-card {
            flex: 1;
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }

        .league-stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--road-primary);
        }

        .league-stat-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .league-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 10px 15px;
        }

        .badge-icon {
            font-size: 1.5rem;
        }

        .badge-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Leaderboard */
        .leaderboard-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .leaderboard-item.current-user {
            border: 2px solid var(--road-primary);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), transparent);
        }

        .leaderboard-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .leaderboard-rank.gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
        .leaderboard-rank.silver { background: linear-gradient(135deg, #9ca3af, #6b7280); color: #000; }
        .leaderboard-rank.bronze { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .leaderboard-stats {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .leaderboard-badge {
            font-size: 1.2rem;
        }

        .league-tiers {
            border-top: 1px solid var(--border-subtle);
            padding-top: 15px;
            margin-top: 15px;
        }

        .tier-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .tier-item span {
            font-size: 1.2rem;
        }

        /* Create Trip Modal */
        .form-row {
            display: flex;
            gap: 15px;
        }

        .tag-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 10px;
            background: var(--bg-elevated);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .tag-checkbox:has(input:checked) {
            background: var(--accent-primary);
            color: white;
        }

        .tag-checkbox input {
            display: none;
        }

        .waypoint-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .waypoint-row .waypoint-name {
            flex: 2;
        }

        .waypoint-row .waypoint-lat,
        .waypoint-row .waypoint-lng {
            flex: 1;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* Country Roads Card */
        .country-roads-card {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 12px;
        }

        .country-roads-card h4 {
            margin-bottom: 10px;
            color: var(--serendipity);
        }

        /* Road Trip Completed Badge */
        .trip-completed-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
        }

        .road-trip-card {
            position: relative;
        }

        .road-trip-card.completed {
            border-left: 3px solid var(--success);
        }

        .road-trip-card .complete-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            padding: 4px 8px;
            font-size: 0.65rem;
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-hover);
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }

        .road-trip-card:hover .complete-btn {
            opacity: 1;
        }

        .road-trip-card .complete-btn:hover {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        /* User-created trip badge */
        .user-created-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--serendipity);
            color: white;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* External Links Grid */
        .external-links-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .ext-link-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .ext-link-card:hover {
            border-color: var(--accent-primary);
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .ext-icon {
            font-size: 1.4rem;
        }

        .ext-name {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        /* Plan Trip Section */
        .plan-trip-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(244, 114, 182, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            padding: 15px;
        }

        .mini-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        #plannedTripsList .planned-trip-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #plannedTripsList .planned-trip-item:hover {
            background: var(--bg-hover);
        }

        .planned-trip-item .trip-icon {
            font-size: 1.2rem;
        }

        .planned-trip-item .trip-info {
            flex: 1;
        }

        .planned-trip-item .trip-name {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .planned-trip-item .trip-meta {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        /* Trip Planner Modal */
        .trip-planner-modal {
            display: flex;
            flex-direction: column;
        }

        .planner-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .planner-sidebar {
            width: 320px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .planner-tools {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .tool-section {
            margin-bottom: 20px;
        }

        .tool-section h4 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .tool-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .stop-type-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .stop-type-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stop-type-btn:hover {
            border-color: var(--accent-primary);
        }

        .stop-type-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .stop-type-btn span {
            font-size: 1rem;
        }

        .route-stops-list {
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .route-stops-list .empty-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            padding: 20px;
        }

        .route-stop-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--bg-elevated);
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .route-stop-item .stop-icon {
            font-size: 1rem;
        }

        .route-stop-item .stop-name {
            flex: 1;
        }

        .route-stop-item .stop-delete {
            width: 20px;
            height: 20px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
        }

        .route-stop-item .stop-delete:hover {
            background: var(--danger);
            color: white;
        }

        .route-stats {
            display: flex;
            gap: 15px;
        }

        .route-stat {
            font-size: 0.75rem;
        }

        .route-stat .stat-label {
            color: var(--text-muted);
        }

        .route-stat .stat-value {
            font-weight: 600;
            color: var(--accent-secondary);
        }

        .nearby-links {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .nearby-btn {
            padding: 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nearby-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
        }

        .planner-actions {
            padding: 16px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .planner-map-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .planner-map {
            flex: 1;
            background: #1a1a2e;
        }

        .map-instructions {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(21, 21, 32, 0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
        }

        /* Satellite View Modal */
        .satellite-view-modal {
            display: flex;
            flex-direction: column;
        }

        .satellite-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(135deg, #1a365d, #0f172a);
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
        }

        .satellite-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .satellite-title h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .satellite-icon {
            font-size: 1.5rem;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .satellite-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .layer-toggle-group {
            display: flex;
            gap: 4px;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px;
            border-radius: 10px;
        }

        .layer-btn {
            padding: 8px 14px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .layer-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .layer-btn.active {
            background: var(--accent-primary);
            color: white;
        }

        .satellite-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .satellite-map {
            flex: 1;
            background: #0a0a12;
        }

        .satellite-info-panel {
            width: 280px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border-subtle);
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .country-quick-facts h4,
        .country-landmarks h4,
        .satellite-legend h4 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .quick-fact-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.8rem;
        }

        .quick-fact-item .fact-label {
            color: var(--text-secondary);
        }

        .quick-fact-item .fact-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .landmark-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .landmark-item:hover {
            background: var(--bg-hover);
            transform: translateX(4px);
        }

        .landmark-icon {
            font-size: 1.2rem;
        }

        .landmark-name {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .landmark-type {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .satellite-actions {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Vanlifer Info Panel */
        .vanlifer-info {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .vanlifer-info h4 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .info-item {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .info-item .icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .info-item .label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .info-item .value {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .info-item.good .value { color: var(--success); }
        .info-item.warning .value { color: var(--warning); }
        .info-item.bad .value { color: var(--danger); }

        /* Community Alerts */
        .community-alerts {
            margin-top: 16px;
        }

        .alert-item {
            display: flex;
            gap: 10px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--warning);
        }

        .alert-item.danger { border-left-color: var(--danger); }
        .alert-item.info { border-left-color: var(--accent-primary); }
        .alert-item.success { border-left-color: var(--success); }

        .alert-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .alert-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .alert-meta {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Add Alert Button */
        .add-alert-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px dashed var(--border-subtle);
            border-radius: 10px;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-alert-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Alert Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            width: 450px;
            max-width: 95vw;
            max-height: 90vh;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
        }

        textarea.form-input {
            min-height: 80px;
            resize: vertical;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Route Info Popup */
        .route-popup {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 16px;
            min-width: 280px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .route-popup h4 {
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .route-popup p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        /* Marker Icons */
        .custom-marker {
            background: var(--bg-panel);
            border: 2px solid var(--serendipity);
            border-radius: 50%;
            width: 30px !important;
            height: 30px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .custom-marker.alert-marker {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.2);
        }

        .custom-marker.danger-marker {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.2);
        }

        .custom-marker.poi-marker {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.2);
        }

        /* Reddit Tips */
        .reddit-tips {
            background: linear-gradient(135deg, #ff4500, #ff6b35);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .reddit-tips h4 {
            color: white;
            font-size: 0.85rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reddit-tip {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            color: white;
        }

        .reddit-tip:last-child {
            margin-bottom: 0;
        }

        .reddit-tip .tip-text {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .reddit-tip .tip-source {
            font-size: 0.65rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* Country Info for Vanlifers */
        .country-vanlifer-info {
            background: var(--bg-elevated);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .country-vanlifer-header {
            padding: 14px;
            background: linear-gradient(135deg, var(--bg-hover), var(--bg-elevated));
            border-bottom: 1px solid var(--border-subtle);
        }

        .country-vanlifer-header h4 {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vanlifer-details {
            padding: 14px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-value {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .detail-value.good { color: var(--success); }
        .detail-value.moderate { color: var(--warning); }
        .detail-value.bad { color: var(--danger); }

        /* Hidden content */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 45vh;
            }

            .mode-tabs {
                padding: 8px;
            }

            .mode-tab {
                padding: 8px;
                font-size: 0.7rem;
            }
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.3s ease;
        }

        /* File input */
        .hidden-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon" id="logoIcon"></div>
                    <span id="logoText">Travel Diary</span>
                </div>
            </div>

            <!-- Mode Tabs -->
            <div class="mode-tabs">
                <button class="mode-tab active" onclick="switchMode('diary')" id="diaryModeTab"> Diary</button>
                <button class="mode-tab serendipity" onclick="switchMode('serendipity')" id="serendipityModeTab"> Serendipity</button>
            </div>

            <div class="sidebar-content">
                <!-- ==================== DIARY MODE CONTENT ==================== -->
                <div id="diaryContent" class="mode-content">
                    <!-- Travel Stats -->
                    <div class="travel-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="countriesVisited">0</div>
                            <div class="stat-label">Countries</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="continentsExplored">0</div>
                            <div class="stat-label">Continents</div>
                        </div>
                    </div>

                    <!-- Selected Country -->
                    <div class="selected-display" id="selectedDisplay">
                        <div class="selected-label">Selected</div>
                        <div class="selected-name" id="selectedCountryName">Click a country</div>
                    </div>

                    <!-- Search -->
                    <div class="section">
                        <div class="section-title"> Search</div>
                        <select class="search-select" id="countrySearch" onchange="selectCountryByCode(this.value)">
                            <option value="">-- Select country --</option>
                        </select>
                    </div>

                    <!-- Quick Actions -->
                    <div class="section">
                        <div class="section-title"> Quick Actions</div>
                        <button class="btn btn-primary" onclick="markAsVisited()" style="margin-bottom: 8px;"> Mark Visited</button>
                        <button class="btn btn-secondary" onclick="resetMap()"> Reset All</button>
                    </div>

                    <!-- Plan Road Trip (NEW FEATURE) -->
                    <div class="section plan-trip-section">
                        <div class="section-title"> Plan Your Road Trip</div>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 10px;">
                            Select a country above, then draw your route on the map!
                        </p>
                        <button class="btn btn-serendipity" onclick="openTripPlannerModal()" id="planTripBtn" disabled>
                             Draw Route on Map
                        </button>
                        
                        <!-- My Planned Trips -->
                        <div id="myPlannedTrips" style="margin-top: 12px;">
                            <div class="mini-title"> My Planned Trips</div>
                            <div id="plannedTripsList"></div>
                        </div>
                    </div>

                    <!-- Quick External Links -->
                    <div class="section">
                        <div class="section-title"> Useful Travel Apps</div>
                        <div class="external-links-grid">
                            <a href="https://www.google.com/maps" target="_blank" class="ext-link-card">
                                <span class="ext-icon"></span>
                                <span class="ext-name">Google Maps</span>
                            </a>
                            <a href="https://www.ioverlander.com" target="_blank" class="ext-link-card">
                                <span class="ext-icon"></span>
                                <span class="ext-name">iOverlander</span>
                            </a>
                            <a href="https://park4night.com" target="_blank" class="ext-link-card">
                                <span class="ext-icon"></span>
                                <span class="ext-name">Park4Night</span>
                            </a>
                            <a href="https://www.gasbuddy.com" target="_blank" class="ext-link-card">
                                <span class="ext-icon"></span>
                                <span class="ext-name">GasBuddy</span>
                            </a>
                            <a href="https://www.booking.com" target="_blank" class="ext-link-card">
                                <span class="ext-icon"></span>
                                <span class="ext-name">Booking</span>
                            </a>
                            <a href="https://maps.me" target="_blank" class="ext-link-card">
                                <span class="ext-icon"></span>
                                <span class="ext-name">Maps.me</span>
                            </a>
                        </div>
                    </div>

                    <!-- Export -->
                    <div class="section">
                        <div class="section-title"> Save/Load</div>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="exportData()"> Export</button>
                            <button class="btn btn-secondary" onclick="importData()"> Import</button>
                        </div>
                        <input type="file" id="fileInput" class="hidden-input" accept=".json" onchange="handleImport(event)">
                    </div>
                </div>

                <!-- ==================== SERENDIPITY MODE CONTENT ==================== -->
                <div id="serendipityContent" class="mode-content serendipity-content">
                    <!-- Serendipity Stats -->
                    <div class="travel-stats" style="background: linear-gradient(135deg, rgba(244, 114, 182, 0.2), rgba(251, 191, 36, 0.2));">
                        <div class="stat-box">
                            <div class="stat-value" id="routesExplored">0</div>
                            <div class="stat-label">Routes</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="kmTraveled">0</div>
                            <div class="stat-label">KM Planned</div>
                        </div>
                    </div>

                    <!-- Reddit Tips -->
                    <div class="reddit-tips">
                        <h4> Hot from r/roadtrip</h4>
                        <div class="reddit-tip">
                            <div class="tip-text">"The Wild Atlantic Way in Ireland is absolutely breathtaking. Skip the Ring of Kerry crowds!"</div>
                            <div class="tip-source">u/wanderlust_adventures  2.4k upvotes</div>
                        </div>
                        <div class="reddit-tip">
                            <div class="tip-text">"Pro tip: iOverlander app is essential for finding free camping spots in Europe"</div>
                            <div class="tip-source">u/vanlife_europe  1.8k upvotes</div>
                        </div>
                    </div>

                    <!-- Iconic Road Trips -->
                    <div class="section">
                        <div class="section-title"> Iconic Road Trips</div>
                        <div id="roadTripsList">
                            <!-- Populated dynamically -->
                        </div>
                        <p class="dblclick-hint"> Double-click any trip for complete guide</p>
                    </div>

                    <!-- Vanlifer Country Info -->
                    <div class="country-vanlifer-info" id="vanliferCountryInfo" style="display: none;">
                        <div class="country-vanlifer-header">
                            <h4> <span id="vanliferCountryName">Country</span> - Vanlifer Info</h4>
                        </div>
                        <div class="vanlifer-details">
                            <div class="detail-row">
                                <span class="detail-label"> Tolls</span>
                                <span class="detail-value" id="tollInfo">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label"> Wild Camping</span>
                                <span class="detail-value" id="campingInfo">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label"> Fuel Cost</span>
                                <span class="detail-value" id="fuelInfo">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label"> Visa (EU)</span>
                                <span class="detail-value" id="visaInfo">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label"> Road Quality</span>
                                <span class="detail-value" id="roadQualityInfo">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label"> Water Access</span>
                                <span class="detail-value" id="waterInfo">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Route Details Panel (for selected route) -->
                    <div id="routeDetailsPanel" style="display: none;">
                        <div class="section">
                            <div class="section-title"> Location 4x4 avec tente de toit</div>
                            <div id="rentalProvidersList"></div>
                        </div>
                        <div class="section">
                            <div class="section-title"> Campings sur la route</div>
                            <div id="campingSitesList"></div>
                        </div>
                    </div>

                    <!-- Road Trip League -->
                    <div class="section league-section">
                        <div class="section-title"> Road Trip League</div>
                        <div class="league-stats">
                            <div class="league-stat-card">
                                <div class="league-stat-value" id="completedTripsCount">0</div>
                                <div class="league-stat-label">Completed</div>
                            </div>
                            <div class="league-stat-card">
                                <div class="league-stat-value" id="totalKmCount">0</div>
                                <div class="league-stat-label">Total km</div>
                            </div>
                            <div class="league-stat-card">
                                <div class="league-stat-value" id="userRank">-</div>
                                <div class="league-stat-label">Rank</div>
                            </div>
                        </div>
                        <div class="league-badge" id="leagueBadge">
                            <span class="badge-icon"></span>
                            <span class="badge-title">Beginner Explorer</span>
                        </div>
                        <button class="btn btn-secondary" style="margin-top: 10px; font-size: 0.8rem;" onclick="openLeaderboardModal()"> View Leaderboard</button>
                    </div>

                    <!-- Create Road Trip -->
                    <div class="section">
                        <div class="section-title"> Create Road Trip</div>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 10px;">Share your own adventure with the community!</p>
                        <button class="btn btn-serendipity" onclick="openCreateTripModal()">+ Create New Trip</button>
                    </div>

                    <!-- Country Roads Viewer -->
                    <div class="section">
                        <div class="section-title"> Explore Country Roads</div>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 10px;">Click any country on the map to zoom in and see main highways.</p>
                        <div id="countryRoadsInfo" style="display: none;">
                            <div class="country-roads-card">
                                <h4 id="selectedRoadsCountry">-</h4>
                                <button class="btn btn-secondary" style="font-size: 0.75rem;" onclick="resetRoadMapView()"> Back to World View</button>
                            </div>
                        </div>
                    </div>

                    <!-- Community Alerts -->
                    <div class="section community-alerts">
                        <div class="section-title"> Community Alerts</div>
                        <div id="alertsList">
                            <!-- Populated dynamically -->
                        </div>
                        <button class="add-alert-btn" onclick="openAlertModal()">+ Add Road Alert</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container" id="mapContainer">
            <div class="zoom-controls" id="zoomControls">
                <button class="zoom-btn" onclick="zoomIn()" title="Zoom in">+</button>
                <button class="zoom-btn" onclick="zoomOut()" title="Zoom out"></button>
                <button class="zoom-btn" onclick="resetZoom()" title="Reset"></button>
            </div>
            <!-- D3 World Map -->
            <svg id="worldMap" viewBox="0 0 2000 1000" preserveAspectRatio="xMidYMid meet"></svg>
            <!-- Leaflet Road Map -->
            <div id="roadMap"></div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal-overlay" id="alertModal">
        <div class="modal">
            <div class="modal-header">
                <h3> Report Road Alert</h3>
                <button class="modal-close" onclick="closeAlertModal()"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Alert Type</label>
                    <select class="form-select" id="alertType">
                        <option value="road_work"> Road Work / Closure</option>
                        <option value="hazard"> Road Hazard</option>
                        <option value="police"> Police Control</option>
                        <option value="fuel"> Fuel Station Issue</option>
                        <option value="camping"> Camping Spot Update</option>
                        <option value="tip"> Helpful Tip</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Location / Route</label>
                    <input type="text" class="form-input" id="alertLocation" placeholder="e.g., Route 66, near Flagstaff">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-input" id="alertDescription" placeholder="Describe the situation..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" style="width: auto;" onclick="closeAlertModal()">Cancel</button>
                <button class="btn btn-serendipity" style="width: auto;" onclick="submitAlert()">Submit Alert</button>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div class="modal-overlay" id="leaderboardModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3> Road Trip Leaderboard</h3>
                <button class="modal-close" onclick="closeLeaderboardModal()"></button>
            </div>
            <div class="modal-body">
                <div class="leaderboard-list" id="leaderboardList">
                    <!-- Populated dynamically -->
                </div>
                <div class="league-tiers">
                    <h4 style="margin: 15px 0 10px; color: var(--text-secondary);">League Tiers</h4>
                    <div class="tier-item"><span></span> Beginner Explorer (0-2 trips)</div>
                    <div class="tier-item"><span></span> Road Warrior (3-5 trips)</div>
                    <div class="tier-item"><span></span> Adventure Seeker (6-10 trips)</div>
                    <div class="tier-item"><span></span> World Traveler (11-15 trips)</div>
                    <div class="tier-item"><span></span> Legendary Explorer (16+ trips)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Road Trip Modal -->
    <div class="modal-overlay" id="createTripModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3> Create New Road Trip</h3>
                <button class="modal-close" onclick="closeCreateTripModal()"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="form-group">
                    <label>Trip Name *</label>
                    <input type="text" class="form-input" id="newTripName" placeholder="e.g., Costa Brava Coastal Adventure">
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Country *</label>
                        <input type="text" class="form-input" id="newTripCountry" placeholder="e.g., Spain">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Distance (km) *</label>
                        <input type="number" class="form-input" id="newTripDistance" placeholder="e.g., 500">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Duration *</label>
                        <input type="text" class="form-input" id="newTripDuration" placeholder="e.g., 3-5 days">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Icon (emoji)</label>
                        <input type="text" class="form-input" id="newTripIcon" placeholder="" maxlength="4">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description *</label>
                    <textarea class="form-input" id="newTripDescription" placeholder="Describe what makes this road trip special..."></textarea>
                </div>
                <div class="form-group">
                    <label>Tips for travelers</label>
                    <textarea class="form-input" id="newTripTips" placeholder="Best time to visit, what to pack, warnings..."></textarea>
                </div>
                <div class="form-group">
                    <label>Tags</label>
                    <div class="tag-selector">
                        <label class="tag-checkbox"><input type="checkbox" value="scenic">  Scenic</label>
                        <label class="tag-checkbox"><input type="checkbox" value="adventure">  Adventure</label>
                        <label class="tag-checkbox"><input type="checkbox" value="historic">  Historic</label>
                        <label class="tag-checkbox"><input type="checkbox" value="camping">  Camping</label>
                        <label class="tag-checkbox"><input type="checkbox" value="toll-free">  Toll-Free</label>
                        <label class="tag-checkbox"><input type="checkbox" value="fourx4">  4x4</label>
                        <label class="tag-checkbox"><input type="checkbox" value="wildlife">  Wildlife</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Waypoints / Milestones *</label>
                    <p style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px;">Add key stops on your route (minimum 2)</p>
                    <div id="waypointsList">
                        <div class="waypoint-row">
                            <input type="text" class="form-input waypoint-name" placeholder="Place name (e.g., Barcelona)">
                            <input type="number" class="form-input waypoint-lat" placeholder="Latitude" step="0.0001">
                            <input type="number" class="form-input waypoint-lng" placeholder="Longitude" step="0.0001">
                            <button class="btn-icon" onclick="removeWaypoint(this)" title="Remove"></button>
                        </div>
                        <div class="waypoint-row">
                            <input type="text" class="form-input waypoint-name" placeholder="Place name">
                            <input type="number" class="form-input waypoint-lat" placeholder="Latitude" step="0.0001">
                            <input type="number" class="form-input waypoint-lng" placeholder="Longitude" step="0.0001">
                            <button class="btn-icon" onclick="removeWaypoint(this)" title="Remove"></button>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="font-size: 0.75rem; margin-top: 8px;" onclick="addWaypoint()">+ Add Waypoint</button>
                    <p style="font-size: 0.65rem; color: var(--text-muted); margin-top: 5px;"> Tip: Get coordinates from Google Maps (right-click  "What's here?")</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" style="width: auto;" onclick="closeCreateTripModal()">Cancel</button>
                <button class="btn btn-serendipity" style="width: auto;" onclick="submitNewTrip()"> Submit Trip</button>
            </div>
        </div>
    </div>

    <!-- Road Trip Detail Modal - Full Screen Experience -->
    <div class="trip-fullscreen-modal" id="tripDetailModal">
        <!-- Hero Header -->
        <div class="trip-hero" id="tripHero">
            <div class="trip-hero-overlay"></div>
            <button class="trip-close-btn" onclick="closeTripDetailModal()">
                <span></span>
            </button>
            <div class="trip-hero-content">
                <div class="trip-hero-badge" id="tripHeroBadge">
                    <span class="hero-icon" id="tripDetailIcon"></span>
                </div>
                <h1 class="trip-hero-title" id="tripDetailName">Road Trip Name</h1>
                <div class="trip-hero-meta">
                    <span class="hero-meta-item"> <span id="tripDetailCountry">Country</span></span>
                    <span class="hero-meta-divider">|</span>
                    <span class="hero-meta-item"> <span id="tripDetailDistance">0 km</span></span>
                    <span class="hero-meta-divider">|</span>
                    <span class="hero-meta-item"> <span id="tripDetailDuration">0 days</span></span>
                </div>
                <div class="trip-hero-rating">
                    <span class="hero-stars" id="tripHeroStars"></span>
                    <span class="hero-rating-value" id="tripDetailRating">4.8</span>
                    <span class="hero-reviews-count">(<span id="tripReviewsCount">0</span> reviews)</span>
                </div>
                <div class="trip-hero-tags" id="tripHeroTags"></div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="trip-nav">
            <div class="trip-nav-tabs">
                <button class="trip-nav-tab active" data-tab="overview" onclick="switchTripTab('overview')">
                     Overview
                </button>
                <button class="trip-nav-tab" data-tab="route" onclick="switchTripTab('route')">
                     Route
                </button>
                <button class="trip-nav-tab" data-tab="budget" onclick="switchTripTab('budget')">
                     Budget
                </button>
                <button class="trip-nav-tab" data-tab="planning" onclick="switchTripTab('planning')">
                     Planning
                </button>
                <button class="trip-nav-tab" data-tab="community" onclick="switchTripTab('community')">
                     Community
                </button>
            </div>
            <div class="trip-nav-actions">
                <button class="trip-action-btn" onclick="viewTripOnMap()" title="View on Map"></button>
                <button class="trip-action-btn" onclick="markCurrentTripCompleted()" title="Mark Done"></button>
                <button class="trip-action-btn" onclick="shareTripLink()" title="Share"></button>
            </div>
        </div>

        <!-- Tab Content Container -->
        <div class="trip-content-container">
            <!-- Overview Tab -->
            <div class="trip-tab-content active" id="tab-overview">
                <div class="trip-grid">
                    <!-- Left Column -->
                    <div class="trip-main-col">
                        <!-- Quick Stats -->
                        <div class="trip-stats-row">
                            <div class="trip-stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-info">
                                    <div class="stat-value" id="tripDetailDifficulty">Moderate</div>
                                    <div class="stat-label">Difficulty</div>
                                </div>
                            </div>
                            <div class="trip-stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-info">
                                    <div class="stat-value" id="tripDetailSeason">Spring</div>
                                    <div class="stat-label">Best Season</div>
                                </div>
                            </div>
                            <div class="trip-stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-info">
                                    <div class="stat-value" id="tripDetailBudget">$2000</div>
                                    <div class="stat-label">Est. Budget</div>
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="trip-card">
                            <h3> About This Trip</h3>
                            <p class="trip-description" id="tripDetailDescription"></p>
                        </div>

                        <!-- Highlights -->
                        <div class="trip-card">
                            <h3> Trip Highlights</h3>
                            <div class="trip-highlights" id="tripDetailHighlights"></div>
                        </div>

                        <!-- Must Know -->
                        <div class="trip-card warning-card">
                            <h3> Must Know Before You Go</h3>
                            <ul class="must-know-list" id="tripDetailMustKnow"></ul>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="trip-side-col">
                        <!-- Top Recommendations -->
                        <div class="trip-card recommendations-card">
                            <h3> Top Recommendations</h3>
                            <div class="recommendations-list" id="tripRecommendations"></div>
                        </div>

                        <!-- Packing Essentials -->
                        <div class="trip-card">
                            <h3> Packing Essentials</h3>
                            <div class="packing-list" id="tripPackingList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Route Tab -->
            <div class="trip-tab-content" id="tab-route">
                <div class="trip-card route-card">
                    <div class="route-header">
                        <h3> Route & Stops</h3>
                        <span class="stops-count"><span id="waypointsCount">0</span> stops</span>
                    </div>
                    <div class="route-timeline" id="tripDetailWaypoints"></div>
                </div>
            </div>

            <!-- Budget Tab -->
            <div class="trip-tab-content" id="tab-budget">
                <div class="budget-grid">
                    <div class="budget-breakdown">
                        <h3> Cost Breakdown</h3>
                        <div class="budget-items">
                            <div class="budget-item">
                                <div class="budget-item-icon"></div>
                                <div class="budget-item-info">
                                    <span class="budget-item-label">Fuel</span>
                                    <span class="budget-item-value" id="tripFuelCost">~$300</span>
                                </div>
                                <div class="budget-item-bar"><div class="bar-fill fuel"></div></div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-item-icon"></div>
                                <div class="budget-item-info">
                                    <span class="budget-item-label">Tolls</span>
                                    <span class="budget-item-value" id="tripTollCost">~$50</span>
                                </div>
                                <div class="budget-item-bar"><div class="bar-fill tolls"></div></div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-item-icon"></div>
                                <div class="budget-item-info">
                                    <span class="budget-item-label">Accommodation</span>
                                    <span class="budget-item-value" id="tripAccomCost">~$800</span>
                                </div>
                                <div class="budget-item-bar"><div class="bar-fill accommodation"></div></div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-item-icon"></div>
                                <div class="budget-item-info">
                                    <span class="budget-item-label">Food & Drinks</span>
                                    <span class="budget-item-value" id="tripFoodCost">~$400</span>
                                </div>
                                <div class="budget-item-bar"><div class="bar-fill food"></div></div>
                            </div>
                        </div>
                        <div class="budget-total">
                            <span>Total Estimated Budget</span>
                            <span class="budget-total-value" id="tripTotalCost">~$1,550</span>
                        </div>
                    </div>
                    <div class="budget-tips">
                        <h3> Budget Tips</h3>
                        <div class="budget-tips-list" id="budgetTips">
                            <div class="budget-tip"> Book accommodations in advance for 20-30% savings</div>
                            <div class="budget-tip"> Use fuel apps like GasBuddy to find cheapest stations</div>
                            <div class="budget-tip"> Save money by cooking at campsites when possible</div>
                            <div class="budget-tip"> Look for combination tickets for attractions</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Planning Tab -->
            <div class="trip-tab-content" id="tab-planning">
                <div class="planning-grid">
                    <div class="planning-steps-container">
                        <h3> Step-by-Step Planning Guide</h3>
                        <div class="planning-timeline" id="tripPlanningSteps"></div>
                    </div>
                </div>
            </div>

            <!-- Community Tab -->
            <div class="trip-tab-content" id="tab-community">
                <div class="community-grid">
                    <!-- Reviews Section -->
                    <div class="community-reviews">
                        <div class="reviews-header">
                            <h3> Reviews & Ratings</h3>
                            <div class="reviews-summary">
                                <span class="big-rating" id="tripBigRating">4.8</span>
                                <div class="rating-breakdown" id="ratingBreakdown"></div>
                            </div>
                        </div>
                        <div class="reviews-list" id="tripDetailReviews"></div>
                        <div class="add-review-box">
                            <h4>Share Your Experience</h4>
                            <div class="rating-input">
                                <span class="rating-star" data-rating="1"></span>
                                <span class="rating-star" data-rating="2"></span>
                                <span class="rating-star" data-rating="3"></span>
                                <span class="rating-star" data-rating="4"></span>
                                <span class="rating-star" data-rating="5"></span>
                            </div>
                            <textarea class="review-textarea" id="newReviewText" placeholder="Tell others about your experience..."></textarea>
                            <button class="submit-review-btn" onclick="submitTripReview()">Submit Review</button>
                        </div>
                    </div>

                    <!-- Chat Section -->
                    <div class="community-chat">
                        <div class="chat-container">
                            <div class="chat-header">
                                <h3> Live Discussion</h3>
                                <span class="online-badge" id="chatOnlineCount"> 12 online</span>
                            </div>
                            <div class="chat-messages" id="tripChatMessages"></div>
                            <div class="chat-input-section">
                                <div class="chat-type-pills">
                                    <button class="chat-pill active" data-type="question" onclick="setChatType('question')"> Question</button>
                                    <button class="chat-pill" data-type="tip" onclick="setChatType('tip')"> Tip</button>
                                    <button class="chat-pill" data-type="experience" onclick="setChatType('experience')"> Story</button>
                                </div>
                                <div class="chat-input-row">
                                    <input type="text" class="chat-text-input" id="chatMessageInput" placeholder="Ask the community...">
                                    <button class="chat-submit-btn" onclick="sendChatMessage()">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Country Satellite View Modal (Double-click) -->
    <div class="modal-overlay" id="satelliteViewModal">
        <div class="modal satellite-view-modal" style="max-width: 95vw; width: 1400px; height: 90vh;">
            <div class="modal-header satellite-header">
                <div class="satellite-title">
                    <span class="satellite-icon"></span>
                    <h3><span id="satelliteCountryName">Country</span> - Satellite View</h3>
                </div>
                <div class="satellite-controls">
                    <div class="layer-toggle-group">
                        <button class="layer-btn active" data-layer="satellite" onclick="setSatelliteLayer('satellite')">
                             Satellite
                        </button>
                        <button class="layer-btn" data-layer="terrain" onclick="setSatelliteLayer('terrain')">
                             Terrain
                        </button>
                        <button class="layer-btn" data-layer="roads" onclick="setSatelliteLayer('roads')">
                             Roads
                        </button>
                        <button class="layer-btn" data-layer="hybrid" onclick="setSatelliteLayer('hybrid')">
                             Hybrid
                        </button>
                    </div>
                    <button class="modal-close" onclick="closeSatelliteViewModal()"></button>
                </div>
            </div>
            <div class="satellite-container">
                <div id="satelliteMap" class="satellite-map"></div>
                <div class="satellite-info-panel" id="satelliteInfoPanel">
                    <div class="country-quick-facts">
                        <h4> Quick Facts</h4>
                        <div id="countryQuickFacts">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                    <div class="country-landmarks">
                        <h4> Key Landmarks</h4>
                        <div id="countryLandmarks">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                    <div class="satellite-legend">
                        <h4> What You're Seeing</h4>
                        <div class="legend-items">
                            <div class="legend-item"><span class="legend-color" style="background: #2d5016;"></span> Forests</div>
                            <div class="legend-item"><span class="legend-color" style="background: #c4a35a;"></span> Desert/Arid</div>
                            <div class="legend-item"><span class="legend-color" style="background: #4a7c59;"></span> Grasslands</div>
                            <div class="legend-item"><span class="legend-color" style="background: #1a5276;"></span> Water</div>
                            <div class="legend-item"><span class="legend-color" style="background: #808080;"></span> Urban Areas</div>
                            <div class="legend-item"><span class="legend-color" style="background: #ffffff;"></span> Snow/Ice</div>
                        </div>
                    </div>
                    <div class="satellite-actions">
                        <button class="btn btn-primary" onclick="planTripFromSatellite()"> Plan Trip Here</button>
                        <button class="btn btn-secondary" onclick="openInGoogleEarth()"> Google Earth</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trip Planner Modal (Draw on Map) -->
    <div class="modal-overlay" id="tripPlannerModal">
        <div class="modal trip-planner-modal" style="max-width: 95vw; width: 1200px; height: 85vh;">
            <div class="modal-header">
                <h3> Plan Your Road Trip in <span id="plannerCountryName">Country</span></h3>
                <button class="modal-close" onclick="closeTripPlannerModal()"></button>
            </div>
            <div class="planner-container">
                <!-- Left Panel - Tools -->
                <div class="planner-sidebar">
                    <div class="planner-tools">
                        <div class="tool-section">
                            <h4> Add Stops</h4>
                            <p class="tool-hint">Click on map to add waypoints</p>
                            <div class="stop-type-selector">
                                <button class="stop-type-btn active" data-type="waypoint" onclick="setStopType('waypoint')">
                                    <span></span> Waypoint
                                </button>
                                <button class="stop-type-btn" data-type="camping" onclick="setStopType('camping')">
                                    <span></span> Camping
                                </button>
                                <button class="stop-type-btn" data-type="fuel" onclick="setStopType('fuel')">
                                    <span></span> Fuel
                                </button>
                                <button class="stop-type-btn" data-type="hotel" onclick="setStopType('hotel')">
                                    <span></span> Hotel
                                </button>
                                <button class="stop-type-btn" data-type="atm" onclick="setStopType('atm')">
                                    <span></span> ATM
                                </button>
                                <button class="stop-type-btn" data-type="viewpoint" onclick="setStopType('viewpoint')">
                                    <span></span> Viewpoint
                                </button>
                                <button class="stop-type-btn" data-type="restaurant" onclick="setStopType('restaurant')">
                                    <span></span> Restaurant
                                </button>
                            </div>
                        </div>

                        <div class="tool-section">
                            <h4> Your Route</h4>
                            <div id="routeStopsList" class="route-stops-list">
                                <p class="empty-hint">Click on map to add stops...</p>
                            </div>
                            <div class="route-stats">
                                <div class="route-stat">
                                    <span class="stat-label">Stops:</span>
                                    <span class="stat-value" id="plannerStopsCount">0</span>
                                </div>
                                <div class="route-stat">
                                    <span class="stat-label">Est. Distance:</span>
                                    <span class="stat-value" id="plannerDistance">0 km</span>
                                </div>
                            </div>
                        </div>

                        <div class="tool-section">
                            <h4> Find Nearby</h4>
                            <div class="nearby-links">
                                <button class="nearby-btn" onclick="searchNearby('fuel station')"> Fuel Stations</button>
                                <button class="nearby-btn" onclick="searchNearby('atm')"> ATMs</button>
                                <button class="nearby-btn" onclick="searchNearby('hotel')"> Hotels</button>
                                <button class="nearby-btn" onclick="searchNearby('camping')"> Camping</button>
                                <button class="nearby-btn" onclick="searchNearby('restaurant')"> Restaurants</button>
                                <button class="nearby-btn" onclick="searchNearby('viewpoint')"> Viewpoints</button>
                            </div>
                        </div>

                        <div class="tool-section">
                            <h4> Trip Details</h4>
                            <input type="text" class="form-input" id="plannedTripName" placeholder="Trip name...">
                            <textarea class="form-input" id="plannedTripNotes" placeholder="Notes, tips..."></textarea>
                        </div>
                    </div>

                    <div class="planner-actions">
                        <button class="btn btn-secondary" onclick="clearPlannerRoute()"> Clear All</button>
                        <button class="btn btn-primary" onclick="savePlannedTrip()"> Save Trip</button>
                        <button class="btn btn-serendipity" onclick="shareToCommunnity()"> Share</button>
                    </div>
                </div>

                <!-- Right Panel - Map -->
                <div class="planner-map-container">
                    <div id="tripPlannerMap" class="planner-map"></div>
                    <div class="map-instructions">
                        <span> Click anywhere on the map to add stops. Drag markers to adjust.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ==================== GLOBAL STATE ====================
        let currentMode = 'diary';
        let selectedCountry = null;
        let currentCountryId = null;
        let currentCountryName = '';
        let countryColors = {};
        let svg, g, projection, path;
        let countriesData = [];
        let roadMap = null;
        let activeRoute = null;
        let communityAlerts = [];
        let completedTrips = [];  // Track completed road trips
        let userCreatedTrips = []; // User-created road trips
        let userName = 'Anonymous Explorer'; // User's display name
        let plannedTrips = []; // User's planned trips from diary mode
        let tripPlannerMap = null; // Leaflet map for trip planner
        let plannerMarkers = []; // Markers on planner map
        let plannerRoute = null; // Polyline for route
        let currentStopType = 'waypoint'; // Current stop type being added
        let plannerStops = []; // Stops in current planning session
        let satelliteMap = null; // Leaflet map for satellite view
        let currentSatelliteLayer = 'satellite'; // Current layer type
        let satelliteLayers = {}; // Store layer references
        const DEFAULT_COLOR = '#3a3a4d';
        const VISITED_COLOR = '#22c55e';
        
        // Country center coordinates for zooming
        const countryCoordinates = {
            'France': [46.2276, 2.2137, 6],
            'Germany': [51.1657, 10.4515, 6],
            'Spain': [40.4637, -3.7492, 6],
            'Italy': [41.8719, 12.5674, 6],
            'United Kingdom': [55.3781, -3.4360, 6],
            'Portugal': [39.3999, -8.2245, 7],
            'Norway': [60.4720, 8.4689, 5],
            'Sweden': [60.1282, 18.6435, 5],
            'Iceland': [64.9631, -19.0208, 6],
            'Romania': [45.9432, 24.9668, 7],
            'Greece': [39.0742, 21.8243, 7],
            'Croatia': [45.1000, 15.2000, 7],
            'Austria': [47.5162, 14.5501, 7],
            'Switzerland': [46.8182, 8.2275, 8],
            'Morocco': [31.7917, -7.0926, 6],
            'South Africa': [-30.5595, 22.9375, 5],
            'Namibia': [-22.9576, 18.4904, 6],
            'Tanzania': [-6.3690, 34.8888, 6],
            'Ethiopia': [9.1450, 40.4897, 6],
            'Senegal': [14.4974, -14.4524, 7],
            'Madagascar': [-18.7669, 46.8691, 6],
            'Egypt': [26.8206, 30.8025, 6],
            'Kenya': [-0.0236, 37.9062, 6],
            'India': [20.5937, 78.9629, 5],
            'Vietnam': [14.0583, 108.2772, 6],
            'Thailand': [15.8700, 100.9925, 6],
            'Japan': [36.2048, 138.2529, 6],
            'Pakistan': [30.3753, 69.3451, 6],
            'China': [35.8617, 104.1954, 4],
            'South Korea': [35.9078, 127.7669, 7],
            'Uzbekistan': [41.3775, 64.5853, 6],
            'Australia': [-25.2744, 133.7751, 4],
            'New Zealand': [-40.9006, 174.8860, 6],
            'United States of America': [37.0902, -95.7129, 4],
            'Canada': [56.1304, -106.3468, 4],
            'Mexico': [23.6345, -102.5528, 5],
            'Brazil': [-14.2350, -51.9253, 4],
            'Argentina': [-38.4161, -63.6167, 4],
            'Peru': [-9.1900, -75.0152, 6],
            'Chile': [-35.6751, -71.5430, 4]
        };

        // ==================== ICONIC ROAD TRIPS DATABASE ====================
        const roadTrips = [
            {
                id: 'namibia_highlights',
                name: 'Namibia Highlights',
                icon: '',
                country: 'Namibia',
                distance: '3500 km',
                duration: '12-16 days',
                coordinates: [[-22.5609, 17.0658], [-24.7275, 15.7390]],
                waypoints: [
                    [-22.5609, 17.0658, 'Windhoek'],
                    [-22.6792, 14.5272, 'Swakopmund'],
                    [-23.1061, 14.4361, 'Walvis Bay'],
                    [-24.7275, 15.7390, 'Sossusvlei'],
                    [-24.4628, 15.9446, 'Sesriem Canyon'],
                    [-23.3425, 15.9369, 'Solitaire'],
                    [-19.1738, 15.9494, 'Twyfelfontein'],
                    [-19.5833, 13.1000, 'Skeleton Coast'],
                    [-19.0154, 15.9150, 'Palmwag'],
                    [-18.8558, 16.1568, 'Etosha (Okaukuejo)'],
                    [-18.7878, 16.9306, 'Etosha (Halali)'],
                    [-18.8111, 17.0667, 'Etosha (Namutoni)'],
                    [-22.5609, 17.0658, 'Windhoek']
                ],
                tags: ['fourx4', 'adventure', 'camping', 'wildlife'],
                description: 'L\'aventure ultime en Namibie: dunes rouges de Sossusvlei, cte des squelettes, faune d\'Etosha.',
                tips: 'Location 4x4 avec tente de toit obligatoire. Rserver les campings NWR  l\'avance!',
                personalTrip: true,
                tripDate: 'Il y a 3 mois',
                rating: 4.9,
                difficulty: 'moderate',
                bestSeason: 'May-October (dry season, best wildlife)',
                budget: '2500-4000',
                mustKnow: [
                    ' 4x4 with rooftop tent is THE way to do Namibia',
                    ' Fill up at EVERY station - distances are huge',
                    ' Sossusvlei gate opens 1hr before sunrise for NWR guests only',
                    ' No cell service in most areas - download offline maps',
                    ' Carry 20+ liters of water at all times',
                    ' Etosha waterholes at night = guaranteed rhino sightings',
                    ' Gravel roads are excellent but require reduced speed',
                    ' Temperature swings are extreme - freezing nights, hot days'
                ],
                reviews: [
                    { user: 'SafariSol', rating: 5, text: 'Mon road trip! Sossusvlei au lever du soleil = moment inoubliable. La tente de toit sous les toiles d\'Etosha, magique!', date: '3 months ago', isOwner: true },
                    { user: 'OverlandAfrica', rating: 5, text: 'Did this route exactly. Palmwag for desert elephants was the highlight!', date: '1 month ago' },
                    { user: 'CoupleOnTheRoad', rating: 5, text: 'Best self-drive safari in Africa. NWR camps are basic but the locations are unbeatable.', date: '2 months ago' }
                ],
                highlights: ['Dune 45 sunrise', 'Deadvlei', 'Etosha waterholes', 'Skeleton Coast', 'Desert elephants'],
                costs: {
                    fuel: '300-400',
                    tolls: '0 (no tolls!)',
                    accommodation: '600-1000',
                    food: '300-500',
                    total: '2,500-4,000 (incl. 4x4 rental)'
                },
                planningSteps: [
                    { title: 'Book 4x4 with Rooftop Tent', desc: 'Essential! Book 3-6 months ahead with ASCO, Britz or Namibia2Go. Toyota Hilux recommended.' },
                    { title: 'Reserve NWR Camps', desc: 'Sesriem and Etosha camps book out fast. NWR website: nwr.com.na - book 2-3 months ahead!' },
                    { title: 'Plan Your Route', desc: 'Clockwise or counter-clockwise both work. Allow 2+ nights at Etosha for wildlife.' },
                    { title: 'Get Travel Insurance', desc: 'Medical evacuation coverage essential. Nearest hospital can be 500km away.' },
                    { title: 'Download Tracks4Africa', desc: 'Best offline GPS app for Namibia. Includes campsites, fuel stations, distances.' }
                ],
                recommendations: [
                    { icon: '', title: 'Dune 45 at Sunrise', desc: 'Arrive 5:30am. Climb for best photos. Magical!' },
                    { icon: '', title: 'Okaukuejo Night Waterhole', desc: 'Rhinos visit 10pm-2am. Bring chair & patience!' },
                    { icon: '', title: 'Solitaire Apfelstrudel', desc: 'Best apple cake in Africa. Seriously!' },
                    { icon: '', title: 'Palmwag Desert Elephants', desc: 'Morning game drive - desert-adapted elephants unique here' },
                    { icon: '', title: 'Skeleton Coast', desc: 'Shipwrecks, seal colonies, eerie beauty' },
                    { icon: '', title: 'Stargazing at Sesriem', desc: 'Some of the darkest skies on Earth. Unforgettable!' }
                ],
                packingList: [
                    { item: ' 20L water reserve', essential: true },
                    { item: ' Know fuel distances', essential: true },
                    { item: ' Headlamp (camp nights)', essential: true },
                    { item: ' SPF50 sunscreen', essential: true },
                    { item: ' Warm fleece (cold nights)', essential: true },
                    { item: ' Camera + zoom lens', essential: false },
                    { item: ' Car charger', essential: true },
                    { item: ' Tracks4Africa app', essential: true },
                    { item: ' First aid kit', essential: true },
                    { item: ' Polarized sunglasses', essential: true },
                    { item: ' Sun hat', essential: false },
                    { item: ' Basic tools', essential: false }
                ],
                rentalProviders: [
                    { name: 'ASCO Car Hire', url: 'https://ascocarhire.com', rating: '', note: 'Excellent, vhicules bien entretenus' },
                    { name: 'Namibia2Go', url: 'https://namibia2go.com', rating: '', note: 'Bon rapport qualit/prix' },
                    { name: 'Britz Namibia', url: 'https://britz.co.za', rating: '', note: 'Grande flotte, pro' },
                    { name: 'Camping Car Hire', url: 'https://campingcarhire.com', rating: '', note: 'Spcialiste camping' },
                    { name: 'Safari Car Rental', url: 'https://safaricarrental.com', rating: '', note: 'Service client top' }
                ],
                campingSites: [
                    { name: 'Urban Camp Windhoek', location: 'Windhoek', type: 'Priv', price: '~250 NAD', facilities: 'Piscine, bar, wifi', coords: [-22.5700, 17.0800] },
                    { name: 'Alte Brcke', location: 'Swakopmund', type: 'Priv', price: '~300 NAD', facilities: 'Prs centre-ville, propre', coords: [-22.6850, 14.5350] },
                    { name: 'Sesriem Campsite (NWR)', location: 'Sossusvlei', type: 'NWR', price: '~350 NAD', facilities: 'Accs dunes au lever du soleil!', coords: [-24.4800, 15.8300] },
                    { name: 'Sossus Oasis', location: 'Sesriem', type: 'Priv', price: '~400 NAD', facilities: 'Piscine, restaurant', coords: [-24.4700, 15.8200] },
                    { name: 'Solitaire Guest Farm', location: 'Solitaire', type: 'Priv', price: '~350 NAD', facilities: 'Apfelstrudel lgendaire!', coords: [-23.8900, 16.0100] },
                    { name: 'Palmwag Lodge Camp', location: 'Palmwag', type: 'Priv', price: '~400 NAD', facilities: 'Rhinos, lphants', coords: [-19.8800, 13.9500] },
                    { name: 'Okaukuejo (NWR)', location: 'Etosha', type: 'NWR', price: '~450 NAD', facilities: 'Waterhole illumin la nuit!', coords: [-18.9000, 15.9200] },
                    { name: 'Halali (NWR)', location: 'Etosha', type: 'NWR', price: '~400 NAD', facilities: 'Central, waterhole', coords: [-18.7600, 16.5000] },
                    { name: 'Namutoni (NWR)', location: 'Etosha', type: 'NWR', price: '~450 NAD', facilities: 'Fort historique, waterhole', coords: [-18.8100, 16.9300] }
                ]
            },
            {
                id: 'route66',
                name: 'Route 66',
                icon: '',
                country: 'USA',
                distance: '3940 km',
                duration: '2-3 weeks',
                coordinates: [[34.0522, -118.2437], [41.8781, -87.6298]],
                waypoints: [
                    [34.0522, -118.2437, 'Los Angeles', 'Start at Santa Monica Pier'],
                    [34.1425, -118.2551, 'Pasadena', 'Route 66 Mother Road Museum'],
                    [35.1983, -114.0533, 'Kingman', 'Historic downtown, great diners'],
                    [35.2226, -101.8313, 'Amarillo', 'Cadillac Ranch art installation'],
                    [35.0844, -106.6504, 'Albuquerque', 'Old Town, Breaking Bad locations'],
                    [35.6870, -105.9378, 'Santa Fe', 'Art galleries, adobe architecture'],
                    [37.2753, -107.8801, 'Durango', 'Steam train, mountain scenery'],
                    [39.7392, -104.9903, 'Denver', 'Mile High City'],
                    [38.6270, -90.1994, 'St. Louis', 'Gateway Arch'],
                    [41.8781, -87.6298, 'Chicago', 'End at Grant Park']
                ],
                tags: ['scenic', 'adventure', 'historic'],
                description: 'The quintessential American road trip from Chicago to LA through the heart of America.',
                tips: 'Best in spring or fall. Many original motels and diners still open.',
                rating: 4.8,
                difficulty: 'easy',
                bestSeason: 'Spring (Apr-May) or Fall (Sep-Oct)',
                budget: '$2000-4000',
                mustKnow: [
                    ' Gas stations can be 100+ miles apart in desert sections',
                    ' Book iconic motels like Wigwam Motel in advance',
                    ' Download offline maps - cell service spotty in rural areas',
                    ' Any car works but classic American muscle adds to the vibe',
                    ' Cadillac Ranch is free and open 24/7 - bring spray paint!',
                    ' Must-try: Big Texan Steak Ranch in Amarillo (free 72oz steak challenge)'
                ],
                reviews: [
                    { user: 'RoadTripKing', rating: 5, text: 'Did this in a vintage Mustang. Best 2 weeks of my life!', date: '2 months ago' },
                    { user: 'WanderlustMom', rating: 5, text: 'Perfect family trip. Kids loved Cadillac Ranch and the quirky roadside attractions.', date: '3 months ago' },
                    { user: 'SoloTraveler22', rating: 4, text: 'Amazing but some sections are quite desolate. Make sure your car is reliable!', date: '5 months ago' }
                ],
                highlights: ['Cadillac Ranch', 'Grand Canyon detour', 'Santa Fe art scene', 'Gateway Arch', 'Petrified Forest'],
                costs: {
                    fuel: '$350-500',
                    tolls: '$0 (toll-free!)',
                    accommodation: '$800-1500',
                    food: '$400-700',
                    total: '$1,550-2,700'
                },
                planningSteps: [
                    { title: 'Book Your Car', desc: 'Rent from Chicago or LA. Consider a one-way rental. Classic car rentals available for the ultimate experience!' },
                    { title: 'Plan Your Route', desc: 'The original Route 66 is now fragmented. Download Route 66 Navigation app for authentic routing.' },
                    { title: 'Book Key Accommodations', desc: 'Reserve iconic spots like Wigwam Motel, Blue Swallow Motel 2-3 months ahead in peak season.' },
                    { title: 'Budget for Attractions', desc: 'Grand Canyon detour ($35/vehicle), Petrified Forest ($25), plus countless free roadside attractions.' },
                    { title: 'Check Your Vehicle', desc: 'Full service before departure. Carry spare tire, jumper cables, extra water for desert sections.' }
                ],
                recommendations: [
                    { icon: '', title: 'Wigwam Motel', desc: 'Sleep in a concrete teepee - iconic Route 66!' },
                    { icon: '', title: 'Big Texan Steak Ranch', desc: 'Free 72oz steak if eaten in 1 hour!' },
                    { icon: '', title: 'Cadillac Ranch', desc: 'Bring spray paint and leave your mark' },
                    { icon: '', title: 'Grand Canyon', desc: '1-hour detour - absolutely worth it!' },
                    { icon: '', title: 'Blue Whale of Catoosa', desc: 'Quirky Oklahoma landmark, great photos' },
                    { icon: '', title: 'Santa Fe Plaza', desc: 'Best New Mexican food on the route' }
                ],
                packingList: [
                    { item: ' Offline maps', essential: true },
                    { item: ' 2L water per person', essential: true },
                    { item: ' Sunscreen SPF50+', essential: true },
                    { item: ' Sunglasses', essential: true },
                    { item: ' Cooler for drinks', essential: false },
                    { item: ' Camera', essential: false },
                    { item: ' Car phone charger', essential: true },
                    { item: ' Light jacket (desert nights)', essential: false },
                    { item: ' Road trip playlist', essential: false }
                ]
            },
            {
                id: 'panamerican',
                name: 'Pan-American Highway',
                icon: '',
                country: 'Multi',
                distance: '30000 km',
                duration: '6-12 months',
                coordinates: [[-54.8019, -68.3030], [64.8378, -147.7164]],
                waypoints: [
                    [-54.8019, -68.3030, 'Ushuaia'],
                    [-33.4489, -70.6693, 'Santiago'],
                    [-12.0464, -77.0428, 'Lima'],
                    [19.4326, -99.1332, 'Mexico City'],
                    [64.8378, -147.7164, 'Fairbanks']
                ],
                tags: ['adventure', 'epic'],
                description: 'The ultimate road trip spanning the Americas from Argentina to Alaska.',
                tips: 'Darien Gap requires shipping vehicle. Plan border crossings carefully.'
            },
            {
                id: 'wildatlantic',
                name: 'Wild Atlantic Way',
                icon: '',
                country: 'Ireland',
                distance: '2500 km',
                duration: '10-14 days',
                coordinates: [[51.8985, -8.4756], [55.2408, -7.3074]],
                waypoints: [
                    [51.8985, -8.4756, 'Cork', 'Start point, English Market'],
                    [51.9001, -8.4731, 'Kinsale', 'Foodie paradise, colorful harbor'],
                    [51.7044, -9.7686, 'Mizen Head', 'Ireland\'s most southwesterly point'],
                    [51.9419, -10.2418, 'Skellig Ring', 'Star Wars filming location'],
                    [52.2593, -9.7066, 'Dingle', 'Traditional pubs, dolphins'],
                    [52.9715, -9.4309, 'Cliffs of Moher', 'Iconic 200m sea cliffs'],
                    [53.2707, -9.0568, 'Galway', 'Vibrant city, live music every night'],
                    [53.5239, -10.0600, 'Connemara', 'Wild mountains, lakes, sheep'],
                    [53.8075, -9.6316, 'Westport', 'Charming Georgian town'],
                    [54.2766, -8.4761, 'Sligo', 'Yeats country, surfing'],
                    [55.2408, -7.3074, 'Malin Head', 'Ireland\'s most northerly point']
                ],
                tags: ['scenic', 'toll-free', 'camping'],
                description: 'Stunning 2,500km coastal route along Ireland\'s rugged Atlantic coast - the world\'s longest defined coastal touring route.',
                tips: 'Wild camping legal. Weather unpredictable - pack layers!',
                rating: 4.9,
                difficulty: 'easy',
                bestSeason: 'May-September (longest days, mildest weather)',
                budget: '1500-3000',
                mustKnow: [
                    ' Rain is guaranteed - waterproof everything!',
                    ' Narrow roads require confidence - locals drive fast',
                    ' Pubs are the social hub - strike up conversations!',
                    ' Wild camping allowed but ask landowners if near homes',
                    ' Sheep on roads are common - drive carefully',
                    ' Golden hour is magical - days are very long in summer'
                ],
                reviews: [
                    { user: 'IrishExplorer', rating: 5, text: 'As an Irish person, this still blew me away. Cliffs of Moher at sunset is unreal.', date: '1 month ago' },
                    { user: 'CamperVanDave', rating: 5, text: 'Did this in a campervan. So many amazing free camping spots!', date: '2 months ago' },
                    { user: 'PhotoNomad', rating: 5, text: 'Best photography road trip I\'ve ever done. Light is incredible.', date: '4 months ago' }
                ],
                highlights: ['Cliffs of Moher', 'Skellig Michael', 'Connemara', 'Dingle Peninsula', 'Galway nightlife'],
                costs: {
                    fuel: '200-300',
                    tolls: '0 (toll-free!)',
                    accommodation: '600-1200',
                    food: '300-500',
                    total: '1,100-2,000'
                },
                planningSteps: [
                    { title: 'Fly into Shannon or Cork', desc: 'These airports offer the best access to the WAW. Dublin adds 3+ hours driving.' },
                    { title: 'Rent the Right Vehicle', desc: 'Compact car recommended. Roads are narrow! Manual transmission cheaper.' },
                    { title: 'Book B&Bs Early', desc: 'Irish B&Bs are the best experience. Book 1-2 months ahead for summer.' },
                    { title: 'Get a Rain Jacket', desc: 'It WILL rain. Good waterproof gear essential. Layers for changeable weather.' },
                    { title: 'Download the WAW App', desc: 'Official app has all discovery points, audio guides, and offline maps.' }
                ],
                recommendations: [
                    { icon: '', title: 'Cliffs of Moher at Sunset', desc: 'Arrive 2hrs before sunset, stay until dark' },
                    { icon: '', title: 'Tigh Neachtain, Galway', desc: 'Best traditional pub atmosphere in Ireland' },
                    { icon: '', title: 'Skellig Michael', desc: 'Book boat trip 3+ months ahead - Star Wars fame!' },
                    { icon: '', title: 'Fungie the Dolphin', desc: 'Dingle\'s famous dolphin - boat trips daily' },
                    { icon: '', title: 'Galway Pubs', desc: 'Live trad music every night - free!' },
                    { icon: '', title: 'Connemara National Park', desc: 'Free entry, Diamond Hill hike is unmissable' }
                ],
                packingList: [
                    { item: ' Waterproof jacket', essential: true },
                    { item: ' Hiking boots', essential: true },
                    { item: ' Warm layers', essential: true },
                    { item: ' Umbrella (compact)', essential: false },
                    { item: ' Camera (the light!)', essential: false },
                    { item: ' EU adapter', essential: true },
                    { item: ' Cash for pubs', essential: true },
                    { item: ' Offline maps', essential: true },
                    { item: ' Irish music playlist', essential: false }
                ]
            },
            {
                id: 'nc500',
                name: 'North Coast 500',
                icon: '',
                country: 'Scotland',
                distance: '830 km',
                duration: '5-7 days',
                coordinates: [[57.4778, -4.2247], [58.6373, -3.0689]],
                waypoints: [
                    [57.4778, -4.2247, 'Inverness'],
                    [57.8690, -5.0960, 'Applecross'],
                    [58.4374, -4.9943, 'Durness'],
                    [58.4397, -3.0943, 'John o\' Groats'],
                    [57.4778, -4.2247, 'Inverness']
                ],
                tags: ['scenic', 'toll-free', 'camping'],
                description: 'Scotland\'s answer to Route 66. Breathtaking Highland scenery.',
                tips: 'Single track roads require patience. Book accommodation in summer.'
            },
            {
                id: 'greatocean',
                name: 'Great Ocean Road',
                icon: '',
                country: 'Australia',
                distance: '243 km',
                duration: '2-3 days',
                coordinates: [[-38.1499, 144.3617], [-38.6805, 143.1051]],
                waypoints: [
                    [-38.1499, 144.3617, 'Torquay'],
                    [-38.4089, 144.0033, 'Lorne'],
                    [-38.6639, 143.1044, '12 Apostles'],
                    [-38.7833, 143.0833, 'Port Campbell']
                ],
                tags: ['scenic', 'toll-free'],
                description: 'One of the world\'s most scenic coastal drives.',
                tips: 'Best light for 12 Apostles at sunrise/sunset. Watch for koalas!'
            },
            {
                id: 'transfagarasan',
                name: 'Transfgran',
                icon: '',
                country: 'Romania',
                distance: '151 km',
                duration: '1-2 days',
                coordinates: [[45.5989, 24.6224], [45.3523, 24.6189]],
                waypoints: [
                    [45.5989, 24.6224, 'Curtea de Arge'],
                    [45.6042, 24.6150, 'Balea Lake'],
                    [45.3523, 24.6189, 'Sibiu']
                ],
                tags: ['scenic', 'adventure', 'toll-free'],
                description: 'Called "the best road in the world" by Top Gear.',
                tips: 'Only open June-October. Arrive early to avoid crowds.'
            },
            // ==================== MORE EUROPE ROAD TRIPS ====================
            {
                id: 'amalfi_coast',
                name: 'Amalfi Coast',
                icon: '',
                country: 'Italy',
                distance: '50 km',
                duration: '2-3 days',
                coordinates: [[40.6333, 14.6029], [40.8518, 14.2681]],
                waypoints: [
                    [40.6333, 14.6029, 'Salerno'],
                    [40.6340, 14.6027, 'Vietri sul Mare'],
                    [40.6492, 14.4844, 'Amalfi'],
                    [40.6262, 14.3749, 'Positano'],
                    [40.7262, 14.4867, 'Ravello'],
                    [40.8518, 14.2681, 'Sorrento']
                ],
                tags: ['scenic', 'historic'],
                description: 'Italy\'s most glamorous coastal drive - cliffside villages and Mediterranean views.',
                tips: 'Drive early morning or late afternoon. Very narrow roads, honk at curves!'
            },
            {
                id: 'trollstigen',
                name: 'Norwegian Fjords & Trollstigen',
                icon: '',
                country: 'Norway',
                distance: '1500 km',
                duration: '7-10 days',
                coordinates: [[60.3913, 5.3221], [69.6489, 18.9551]],
                waypoints: [
                    [60.3913, 5.3221, 'Bergen'],
                    [61.9047, 6.7091, 'Geirangerfjord'],
                    [62.4574, 7.6817, 'Trollstigen'],
                    [62.4722, 6.1549, 'lesund'],
                    [63.4305, 10.3951, 'Trondheim'],
                    [68.4385, 17.4278, 'Lofoten Islands'],
                    [69.6489, 18.9551, 'Troms']
                ],
                tags: ['scenic', 'adventure', 'camping'],
                description: 'Dramatic fjords, serpentine mountain roads, and the midnight sun.',
                tips: 'Expensive! Wild camping legal (Allemannsretten). Best June-August.'
            },
            {
                id: 'romantic_road',
                name: 'Romantic Road',
                icon: '',
                country: 'Germany',
                distance: '460 km',
                duration: '3-5 days',
                coordinates: [[49.8988, 10.9028], [47.5576, 10.7498]],
                waypoints: [
                    [49.8988, 10.9028, 'Wrzburg'],
                    [49.3795, 10.1807, 'Rothenburg ob der Tauber'],
                    [48.9260, 10.6996, 'Nrdlingen'],
                    [48.3705, 10.8978, 'Augsburg'],
                    [47.5576, 10.7498, 'Neuschwanstein Castle'],
                    [47.5667, 10.6833, 'Fssen']
                ],
                tags: ['scenic', 'historic', 'toll-free'],
                description: 'Medieval towns, castles, and the fairytale Neuschwanstein.',
                tips: 'Christmas markets amazing in December. Book Neuschwanstein tickets online!'
            },
            {
                id: 'grossglockner',
                name: 'Grossglockner High Alpine Road',
                icon: '',
                country: 'Austria',
                distance: '48 km',
                duration: '1 day',
                coordinates: [[47.0744, 12.8428], [47.1167, 12.8500]],
                waypoints: [
                    [47.0744, 12.8428, 'Bruck an der Groglocknerstrae'],
                    [47.0833, 12.8167, 'Fuscher Trl'],
                    [47.0742, 12.7514, 'Kaiser-Franz-Josefs-Hhe'],
                    [47.1167, 12.8500, 'Heiligenblut']
                ],
                tags: ['scenic', 'adventure'],
                description: 'Austria\'s highest paved road with 36 hairpin turns and glacier views.',
                tips: 'Toll road (~40). Open May-October. Stop at Edelweissspitze viewpoint!'
            },
            {
                id: 'stelvio_pass',
                name: 'Stelvio Pass',
                icon: '',
                country: 'Italy',
                distance: '25 km',
                duration: '1 day',
                coordinates: [[46.5290, 10.4534], [46.5285, 10.5353]],
                waypoints: [
                    [46.5290, 10.4534, 'Prato allo Stelvio'],
                    [46.5285, 10.5353, 'Stelvio Pass Summit (2757m)'],
                    [46.5404, 10.5902, 'Bormio']
                ],
                tags: ['scenic', 'adventure', 'toll-free'],
                description: '48 hairpin bends - the most challenging alpine pass in the Alps.',
                tips: 'Open June-September. Early morning = no traffic. Great for motorcycles!'
            },
            {
                id: 'costa_brava',
                name: 'Costa Brava Coastal',
                icon: '',
                country: 'Spain',
                distance: '200 km',
                duration: '3-4 days',
                coordinates: [[41.3851, 2.1734], [42.3154, 3.1836]],
                waypoints: [
                    [41.3851, 2.1734, 'Barcelona'],
                    [41.6986, 2.8453, 'Tossa de Mar'],
                    [41.9688, 3.2147, 'Cadaqus'],
                    [42.1209, 3.1212, 'Dal Museum Figueres'],
                    [42.3154, 3.1836, 'Portbou (France border)']
                ],
                tags: ['scenic', 'toll-free', 'camping'],
                description: 'Rugged Catalan coastline, hidden coves, and Dal country.',
                tips: 'Wild camping tolerated on beaches. Avoid August crowds!'
            },
            {
                id: 'balkan_adventure',
                name: 'Balkan Adventure',
                icon: '',
                country: 'Multi-country',
                distance: '2000 km',
                duration: '10-14 days',
                coordinates: [[45.8150, 15.9819], [42.6507, 18.0944]],
                waypoints: [
                    [45.8150, 15.9819, 'Zagreb'],
                    [44.8176, 15.8714, 'Plitvice Lakes'],
                    [43.5081, 16.4402, 'Split'],
                    [42.6507, 18.0944, 'Dubrovnik'],
                    [42.4411, 19.2636, 'Kotor (Montenegro)'],
                    [41.3275, 19.8187, 'Tirana (Albania)']
                ],
                tags: ['scenic', 'adventure', 'toll-free'],
                description: 'Croatia, Montenegro, Albania - stunning coastline and affordable adventure.',
                tips: 'Very affordable! Green Card insurance for Albania. Incredible value.'
            },
            {
                id: 'portugal_atlantic',
                name: 'Portugal Atlantic Coast',
                icon: '',
                country: 'Portugal',
                distance: '850 km',
                duration: '7-10 days',
                coordinates: [[41.1579, -8.6291], [37.0179, -7.9308]],
                waypoints: [
                    [41.1579, -8.6291, 'Porto'],
                    [40.2033, -8.4103, 'Coimbra'],
                    [39.5000, -8.8833, 'Nazar (Big Waves!)'],
                    [38.7223, -9.1393, 'Lisbon'],
                    [38.6916, -9.4163, 'Sintra'],
                    [37.0941, -8.2478, 'Lagos'],
                    [37.0179, -7.9308, 'Sagres (End of Europe)']
                ],
                tags: ['scenic', 'camping', 'toll-free'],
                description: 'From Porto to the dramatic cliffs of Sagres - surf, wine, and history.',
                tips: 'Tolls avoidable on N-roads. Best surf spots: Nazar, Ericeira, Peniche.'
            },
            {
                id: 'swiss_alpine',
                name: 'Swiss Grand Tour',
                icon: '',
                country: 'Switzerland',
                distance: '1600 km',
                duration: '7-10 days',
                coordinates: [[46.9480, 7.4474], [46.2044, 6.1432]],
                waypoints: [
                    [46.9480, 7.4474, 'Bern'],
                    [46.6863, 7.8632, 'Interlaken'],
                    [46.0207, 7.7491, 'Zermatt (Matterhorn)'],
                    [46.2044, 6.1432, 'Geneva'],
                    [46.8182, 8.2275, 'Lucerne'],
                    [46.4908, 9.8355, 'St. Moritz'],
                    [47.3769, 8.5417, 'Zrich']
                ],
                tags: ['scenic', 'adventure'],
                description: 'Mountain passes, pristine lakes, and Alpine perfection.',
                tips: 'Very expensive! Get Swiss Vignette (40 CHF). Free camping difficult.'
            },
            {
                id: 'scottish_highlands',
                name: 'Scottish Highlands & Islands',
                icon: '',
                country: 'Scotland',
                distance: '1500 km',
                duration: '10-14 days',
                coordinates: [[55.9533, -3.1883], [57.4778, -4.2247]],
                waypoints: [
                    [55.9533, -3.1883, 'Edinburgh'],
                    [56.8198, -5.1052, 'Fort William'],
                    [57.2760, -5.5160, 'Isle of Skye'],
                    [58.4397, -3.0943, 'John o\' Groats'],
                    [57.4778, -4.2247, 'Inverness'],
                    [56.4907, -4.2026, 'Loch Ness']
                ],
                tags: ['scenic', 'adventure', 'camping'],
                description: 'Mystical highlands, dramatic castles, and the Isle of Skye.',
                tips: 'Wild camping legal! Single track roads - use passing places. Midges in summer!'
            },
            {
                id: 'garden_route',
                name: 'Garden Route',
                icon: '',
                country: 'South Africa',
                distance: '300 km',
                duration: '5-7 days',
                coordinates: [[-34.0373, 23.0471], [-33.9580, 22.4610]],
                waypoints: [
                    [-34.0373, 23.0471, 'Storms River'],
                    [-34.0355, 23.3695, 'Plettenberg Bay'],
                    [-33.9580, 22.4610, 'George']
                ],
                tags: ['scenic', 'adventure', 'camping'],
                description: 'Lush forests, lagoons, and stunning coastline.',
                tips: 'Great for wildlife. Bungee jump at Bloukrans Bridge!'
            },
            {
                id: 'ring_road',
                name: 'Ring Road',
                icon: '',
                country: 'Iceland',
                distance: '1332 km',
                duration: '7-10 days',
                coordinates: [[64.1466, -21.9426], [65.6835, -18.0878]],
                waypoints: [
                    [64.1466, -21.9426, 'Reykjavik'],
                    [64.3260, -20.1210, 'Geysir'],
                    [63.5320, -19.5110, 'Vik'],
                    [65.6835, -18.0878, 'Akureyri']
                ],
                tags: ['scenic', 'adventure', 'toll-free'],
                description: 'Circle Iceland through volcanoes, glaciers and waterfalls.',
                tips: 'F-roads need 4x4. Summer has 24hr daylight. Expensive but incredible!'
            },
            // ==================== ASIA ROAD TRIPS ====================
            {
                id: 'karakoram',
                name: 'Karakoram Highway',
                icon: '',
                country: 'Pakistan/China',
                distance: '1300 km',
                duration: '7-10 days',
                coordinates: [[35.9208, 74.3082], [39.4704, 75.9893]],
                waypoints: [
                    [35.9208, 74.3082, 'Gilgit'],
                    [36.3167, 74.6500, 'Karimabad (Hunza)'],
                    [36.4500, 74.8667, 'Passu'],
                    [36.8333, 75.4167, 'Khunjerab Pass (4693m)'],
                    [39.4704, 75.9893, 'Kashgar']
                ],
                tags: ['adventure', 'scenic', 'epic'],
                description: 'The 8th wonder of the world - highest paved international road crossing the Himalayas.',
                tips: 'Permits required. Best May-October. Altitude sickness possible at Khunjerab.'
            },
            {
                id: 'hai_van',
                name: 'Hai Van Pass & Coastal Vietnam',
                icon: '',
                country: 'Vietnam',
                distance: '1700 km',
                duration: '10-14 days',
                coordinates: [[10.7769, 106.7009], [21.0285, 105.8542]],
                waypoints: [
                    [10.7769, 106.7009, 'Ho Chi Minh City'],
                    [11.9404, 108.4583, 'Da Lat'],
                    [12.2388, 109.1967, 'Nha Trang'],
                    [13.7563, 109.2225, 'Quy Nhon'],
                    [15.8801, 108.3380, 'Hoi An'],
                    [16.0544, 108.2022, 'Da Nang'],
                    [16.4637, 107.5909, 'Hue'],
                    [21.0285, 105.8542, 'Hanoi']
                ],
                tags: ['scenic', 'adventure', 'toll-free'],
                description: 'Vietnam\'s legendary coastal route including the famous Hai Van Pass (Top Gear\'s best road).',
                tips: 'Rent motorbike in HCMC, sell in Hanoi. Rainy season varies by region.'
            },
            {
                id: 'hokkaido',
                name: 'Hokkaido Circuit',
                icon: '',
                country: 'Japan',
                distance: '1200 km',
                duration: '7-10 days',
                coordinates: [[43.0621, 141.3544], [43.7714, 142.3630]],
                waypoints: [
                    [43.0621, 141.3544, 'Sapporo'],
                    [43.0587, 141.3570, 'Otaru'],
                    [43.4564, 142.4847, 'Furano'],
                    [43.7714, 142.3630, 'Biei (Blue Pond)'],
                    [43.0618, 144.3589, 'Kushiro'],
                    [44.0206, 145.1370, 'Shiretoko Peninsula'],
                    [43.0621, 141.3544, 'Sapporo']
                ],
                tags: ['scenic', 'camping'],
                description: 'Japan\'s wild north - lavender fields, volcanic lakes, and untamed wilderness.',
                tips: 'Michi-no-Eki (road stations) allow overnight parking. Best July-September.'
            },
            {
                id: 'golden_triangle',
                name: 'Golden Triangle',
                icon: '',
                country: 'Thailand',
                distance: '1900 km',
                duration: '10-14 days',
                coordinates: [[13.7563, 100.5018], [20.3500, 100.0833]],
                waypoints: [
                    [13.7563, 100.5018, 'Bangkok'],
                    [14.3692, 99.9938, 'Kanchanaburi'],
                    [18.7883, 98.9853, 'Chiang Mai'],
                    [19.9071, 99.8309, 'Chiang Rai'],
                    [20.3500, 100.0833, 'Golden Triangle'],
                    [19.2966, 97.9684, 'Mae Hong Son Loop'],
                    [18.7883, 98.9853, 'Chiang Mai']
                ],
                tags: ['scenic', 'adventure', 'toll-free'],
                description: 'Northern Thailand loop through mountains, temples, and the legendary Mae Hong Son Loop.',
                tips: '762 curves in Mae Hong Son Loop! Rent big bike in Chiang Mai.'
            },
            {
                id: 'silk_road',
                name: 'Silk Road (Central Asia)',
                icon: '',
                country: 'Multi-country',
                distance: '4000 km',
                duration: '3-4 weeks',
                coordinates: [[41.2995, 69.2401], [39.6542, 66.9597]],
                waypoints: [
                    [41.2995, 69.2401, 'Tashkent'],
                    [39.6542, 66.9597, 'Samarkand'],
                    [39.7747, 64.4286, 'Bukhara'],
                    [41.3775, 60.3378, 'Khiva'],
                    [42.4602, 59.6035, 'Nukus'],
                    [37.9601, 58.3261, 'Mary (Merv)'],
                    [37.9509, 58.3794, 'Ashgabat']
                ],
                tags: ['adventure', 'epic', 'historic'],
                description: 'Follow the ancient trade route through Uzbekistan and Turkmenistan.',
                tips: 'Visas can be complex. Best spring/autumn. Incredible Islamic architecture.'
            },
            {
                id: 'rajasthan',
                name: 'Rajasthan Royal Route',
                icon: '',
                country: 'India',
                distance: '1200 km',
                duration: '10-14 days',
                coordinates: [[28.6139, 77.2090], [26.9124, 70.9021]],
                waypoints: [
                    [28.6139, 77.2090, 'Delhi'],
                    [27.1767, 78.0081, 'Agra (Taj Mahal)'],
                    [26.9124, 75.7873, 'Jaipur'],
                    [26.4499, 74.6399, 'Pushkar'],
                    [26.2967, 73.0167, 'Jodhpur'],
                    [26.9124, 70.9021, 'Jaisalmer'],
                    [24.5854, 72.7125, 'Udaipur']
                ],
                tags: ['historic', 'scenic', 'adventure'],
                description: 'India\'s royal route through forts, palaces, and the Thar Desert.',
                tips: 'Chaotic traffic! Best October-March. Hire driver or be very experienced.'
            },
            {
                id: 'korea_coastal',
                name: 'Korea Coastal Road',
                icon: '',
                country: 'South Korea',
                distance: '1700 km',
                duration: '7-10 days',
                coordinates: [[35.1796, 129.0756], [38.2070, 128.5918]],
                waypoints: [
                    [35.1796, 129.0756, 'Busan'],
                    [35.8714, 128.6014, 'Gyeongju'],
                    [36.0190, 129.3435, 'Pohang'],
                    [37.4563, 129.1658, 'Gangneung'],
                    [38.2070, 128.5918, 'Sokcho'],
                    [37.5665, 126.9780, 'Seoul']
                ],
                tags: ['scenic', 'toll-free', 'camping'],
                description: 'Korea\'s stunning east coast from Busan to the DMZ area.',
                tips: 'Excellent rest stops. Try the seafood! Camping at beaches possible.'
            },
            // ==================== AFRICA ROAD TRIPS ====================
            {
                id: 'morocco_atlas',
                name: 'Morocco Grand Tour',
                icon: '',
                country: 'Morocco',
                distance: '2200 km',
                duration: '12-16 days',
                coordinates: [[33.5731, -7.5898], [31.6295, -7.9811]],
                waypoints: [
                    [33.5731, -7.5898, 'Casablanca'],
                    [33.9716, -6.8498, 'Rabat'],
                    [34.0181, -5.0078, 'Fes'],
                    [31.9314, -4.4288, 'Merzouga (Sahara)'],
                    [31.1649, -4.0004, 'Todra Gorge'],
                    [31.0482, -6.8388, 'Ait Benhaddou'],
                    [31.6295, -7.9811, 'Marrakech'],
                    [30.4278, -9.5981, 'Agadir'],
                    [31.5085, -9.7595, 'Essaouira']
                ],
                tags: ['adventure', 'scenic', 'camping'],
                description: 'From imperial cities to Sahara dunes, kasbahs and coastal charm.',
                tips: 'Wild camping easy outside cities. Negotiate everything! Best spring/autumn.'
            },
            {
                id: 'cape_town_kruger',
                name: 'Cape Town to Kruger',
                icon: '',
                country: 'South Africa',
                distance: '1800 km',
                duration: '14-18 days',
                coordinates: [[-33.9249, 18.4241], [-24.9916, 31.5430]],
                waypoints: [
                    [-33.9249, 18.4241, 'Cape Town'],
                    [-33.9580, 22.4610, 'Garden Route Start'],
                    [-33.4580, 26.5220, 'Addo Elephant Park'],
                    [-29.8587, 31.0218, 'Durban'],
                    [-25.7479, 28.2293, 'Pretoria'],
                    [-24.9916, 31.5430, 'Kruger National Park']
                ],
                tags: ['scenic', 'wildlife', 'adventure'],
                description: 'The ultimate South African road trip - coast, wildlife, and everything in between.',
                tips: 'Book Kruger camps months ahead. Garden Route doable year-round.'
            },
            {
                id: 'ethiopia_historic',
                name: 'Ethiopian Historic Route',
                icon: '',
                country: 'Ethiopia',
                distance: '1500 km',
                duration: '10-14 days',
                coordinates: [[9.0320, 38.7469], [14.1210, 38.7469]],
                waypoints: [
                    [9.0320, 38.7469, 'Addis Ababa'],
                    [11.5936, 37.3908, 'Bahir Dar (Blue Nile Falls)'],
                    [12.6000, 37.4667, 'Gondar'],
                    [13.4910, 39.4750, 'Axum'],
                    [12.0300, 39.0442, 'Lalibela'],
                    [9.0320, 38.7469, 'Addis Ababa']
                ],
                tags: ['historic', 'adventure', 'fourx4'],
                description: 'Ancient churches, castles, and the ark of the covenant route.',
                tips: 'Roads improving but still challenging. Best October-March (dry season).'
            },
            {
                id: 'tanzania_circuit',
                name: 'Tanzania Northern Circuit',
                icon: '',
                country: 'Tanzania',
                distance: '800 km',
                duration: '7-10 days',
                coordinates: [[-3.3869, 36.6830], [-2.3333, 34.8333]],
                waypoints: [
                    [-3.3869, 36.6830, 'Arusha'],
                    [-3.0674, 37.3556, 'Moshi (Kilimanjaro)'],
                    [-2.3333, 34.8333, 'Serengeti'],
                    [-3.2400, 35.5320, 'Ngorongoro Crater'],
                    [-3.5000, 35.7500, 'Lake Manyara'],
                    [-4.0500, 35.7620, 'Tarangire'],
                    [-3.3869, 36.6830, 'Arusha']
                ],
                tags: ['wildlife', 'adventure', 'fourx4'],
                description: 'Safari paradise - Great Migration, Ngorongoro, and Kilimanjaro views.',
                tips: 'June-October for migration. Book camps well in advance!'
            },
            {
                id: 'senegal_dakar',
                name: 'Senegal Adventure',
                icon: '',
                country: 'Senegal',
                distance: '1200 km',
                duration: '10-14 days',
                coordinates: [[14.6928, -17.4467], [12.5833, -16.2719]],
                waypoints: [
                    [14.6928, -17.4467, 'Dakar'],
                    [14.7500, -17.3600, 'Lac Rose'],
                    [15.6178, -16.4181, 'Saint-Louis'],
                    [13.4531, -16.5775, 'Sine-Saloum Delta'],
                    [12.5833, -16.2719, 'Casamance'],
                    [14.6928, -17.4467, 'Dakar']
                ],
                tags: ['adventure', 'scenic', 'toll-free'],
                description: 'West African adventure - colonial history, pink lake, and tropical south.',
                tips: 'Peugeot 504 sept-place for local experience! Casamance requires patience.'
            },
            {
                id: 'madagascar_rn7',
                name: 'Madagascar RN7',
                icon: '',
                country: 'Madagascar',
                distance: '1000 km',
                duration: '10-14 days',
                coordinates: [[-18.8792, 47.5079], [-23.3516, 43.6854]],
                waypoints: [
                    [-18.8792, 47.5079, 'Antananarivo'],
                    [-19.8659, 47.0333, 'Antsirabe'],
                    [-20.5167, 46.5500, 'Ambositra'],
                    [-21.4419, 47.0856, 'Ranomafana'],
                    [-21.2500, 45.3667, 'Isalo'],
                    [-23.3516, 43.6854, 'Toliara']
                ],
                tags: ['adventure', 'wildlife', 'scenic'],
                description: 'Madagascar\'s most famous road - lemurs, baobabs, and otherworldly landscapes.',
                tips: 'Roads very rough! 4x4 recommended. Best April-November.'
            }
        ];

        // ==================== WORLD VIEWPOINTS & HISTORICAL SITES (UNESCO + FAMOUS) ====================
        const worldViewpoints = [
            // Africa
            { name: 'Pyramids of Giza', lat: 29.9792, lng: 31.1342, type: 'historic', icon: '', country: 'Egypt', unesco: true },
            { name: 'Victoria Falls', lat: -17.9243, lng: 25.8572, type: 'viewpoint', icon: '', country: 'Zambia/Zimbabwe', unesco: true },
            { name: 'Serengeti', lat: -2.3333, lng: 34.8333, type: 'nature', icon: '', country: 'Tanzania', unesco: true },
            { name: 'Medina of Fes', lat: 34.0181, lng: -5.0078, type: 'historic', icon: '', country: 'Morocco', unesco: true },
            { name: 'Rock Churches of Lalibela', lat: 12.0300, lng: 39.0442, type: 'historic', icon: '', country: 'Ethiopia', unesco: true },
            { name: 'Table Mountain', lat: -33.9628, lng: 18.4098, type: 'viewpoint', icon: '', country: 'South Africa' },
            { name: 'Ngorongoro Crater', lat: -3.2400, lng: 35.5320, type: 'nature', icon: '', country: 'Tanzania', unesco: true },
            { name: 'Sossusvlei Dunes', lat: -24.7275, lng: 15.7390, type: 'viewpoint', icon: '', country: 'Namibia' },
            // Asia
            { name: 'Taj Mahal', lat: 27.1751, lng: 78.0421, type: 'historic', icon: '', country: 'India', unesco: true },
            { name: 'Great Wall of China', lat: 40.4319, lng: 116.5704, type: 'historic', icon: '', country: 'China', unesco: true },
            { name: 'Angkor Wat', lat: 13.4125, lng: 103.8670, type: 'historic', icon: '', country: 'Cambodia', unesco: true },
            { name: 'Mount Fuji', lat: 35.3606, lng: 138.7274, type: 'viewpoint', icon: '', country: 'Japan', unesco: true },
            { name: 'Ha Long Bay', lat: 20.9101, lng: 107.1839, type: 'nature', icon: '', country: 'Vietnam', unesco: true },
            { name: 'Petra', lat: 30.3285, lng: 35.4444, type: 'historic', icon: '', country: 'Jordan', unesco: true },
            { name: 'Bagan Temples', lat: 21.1717, lng: 94.8585, type: 'historic', icon: '', country: 'Myanmar', unesco: true },
            { name: 'Hagia Sophia', lat: 41.0086, lng: 28.9802, type: 'historic', icon: '', country: 'Turkey', unesco: true },
            { name: 'Borobudur', lat: -7.6079, lng: 110.2038, type: 'historic', icon: '', country: 'Indonesia', unesco: true },
            { name: 'Terracotta Army', lat: 34.3848, lng: 109.2785, type: 'historic', icon: '', country: 'China', unesco: true },
            { name: 'Sigiriya Rock', lat: 7.9570, lng: 80.7603, type: 'historic', icon: '', country: 'Sri Lanka', unesco: true },
            { name: 'Khajuraho', lat: 24.8318, lng: 79.9199, type: 'historic', icon: '', country: 'India', unesco: true },
            // Europe
            { name: 'Colosseum', lat: 41.8902, lng: 12.4922, type: 'historic', icon: '', country: 'Italy', unesco: true },
            { name: 'Acropolis', lat: 37.9715, lng: 23.7257, type: 'historic', icon: '', country: 'Greece', unesco: true },
            { name: 'Eiffel Tower', lat: 48.8584, lng: 2.2945, type: 'viewpoint', icon: '', country: 'France' },
            { name: 'Neuschwanstein Castle', lat: 47.5576, lng: 10.7498, type: 'historic', icon: '', country: 'Germany' },
            { name: 'Santorini Caldera', lat: 36.3932, lng: 25.4615, type: 'viewpoint', icon: '', country: 'Greece' },
            { name: 'Stonehenge', lat: 51.1789, lng: -1.8262, type: 'historic', icon: '', country: 'UK', unesco: true },
            { name: 'Alhambra', lat: 37.1760, lng: -3.5881, type: 'historic', icon: '', country: 'Spain', unesco: true },
            { name: 'Dubrovnik Old Town', lat: 42.6507, lng: 18.0944, type: 'historic', icon: '', country: 'Croatia', unesco: true },
            // Americas
            { name: 'Machu Picchu', lat: -13.1631, lng: -72.5450, type: 'historic', icon: '', country: 'Peru', unesco: true },
            { name: 'Grand Canyon', lat: 36.1069, lng: -112.1129, type: 'viewpoint', icon: '', country: 'USA', unesco: true },
            { name: 'Chichen Itza', lat: 20.6843, lng: -88.5678, type: 'historic', icon: '', country: 'Mexico', unesco: true },
            { name: 'Iguazu Falls', lat: -25.6953, lng: -54.4367, type: 'viewpoint', icon: '', country: 'Argentina/Brazil', unesco: true },
            { name: 'Monument Valley', lat: 36.9980, lng: -110.0985, type: 'viewpoint', icon: '', country: 'USA' },
            { name: 'Moai of Easter Island', lat: -27.1127, lng: -109.3497, type: 'historic', icon: '', country: 'Chile', unesco: true },
            // Oceania
            { name: 'Great Barrier Reef', lat: -18.2871, lng: 147.6992, type: 'nature', icon: '', country: 'Australia', unesco: true },
            { name: 'Uluru', lat: -25.3444, lng: 131.0369, type: 'nature', icon: '', country: 'Australia', unesco: true },
            { name: 'Milford Sound', lat: -44.6414, lng: 167.8975, type: 'viewpoint', icon: '', country: 'New Zealand' }
        ];

        // ==================== VANLIFER COUNTRY INFO DATABASE ====================
        const vanliferInfo = {
            'United States of America': { tolls: 'Varies', tollClass: 'moderate', camping: 'BLM Land Free', campingClass: 'good', fuel: '$0.90/L', fuelClass: 'good', visa: '90 days ESTA', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Canada': { tolls: 'Few', tollClass: 'good', camping: 'Crown Land Free', campingClass: 'good', fuel: '$1.60/L', fuelClass: 'moderate', visa: '6 months eTA', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Mexico': { tolls: 'Expensive', tollClass: 'bad', camping: 'Informal OK', campingClass: 'moderate', fuel: '$1.20/L', fuelClass: 'good', visa: '180 days free', roadQuality: 'Variable', waterAccess: 'Moderate' },
            'France': { tolls: 'Very High', tollClass: 'bad', camping: 'Restricted', campingClass: 'bad', fuel: '$1.90/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Spain': { tolls: 'Moderate', tollClass: 'moderate', camping: 'Gray Area', campingClass: 'moderate', fuel: '$1.60/L', fuelClass: 'moderate', visa: 'EU/90 days', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Portugal': { tolls: 'Moderate', tollClass: 'moderate', camping: 'Tolerated', campingClass: 'moderate', fuel: '$1.70/L', fuelClass: 'moderate', visa: 'EU/90 days', roadQuality: 'Good', waterAccess: 'Easy' },
            'Germany': { tolls: 'Free (cars)', tollClass: 'good', camping: 'Restricted', campingClass: 'bad', fuel: '$1.80/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Italy': { tolls: 'Very High', tollClass: 'bad', camping: 'Restricted', campingClass: 'bad', fuel: '$1.85/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Good', waterAccess: 'Moderate' },
            'United Kingdom': { tolls: 'Few', tollClass: 'good', camping: 'Scotland OK', campingClass: 'moderate', fuel: '$1.95/L', fuelClass: 'bad', visa: '6 months', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Ireland': { tolls: 'Few', tollClass: 'good', camping: 'Tolerated', campingClass: 'good', fuel: '$1.80/L', fuelClass: 'bad', visa: '90 days', roadQuality: 'Good', waterAccess: 'Easy' },
            'Norway': { tolls: 'High', tollClass: 'bad', camping: 'Legal!', campingClass: 'good', fuel: '$2.20/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Sweden': { tolls: 'Few', tollClass: 'good', camping: 'Legal!', campingClass: 'good', fuel: '$1.90/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Iceland': { tolls: 'None', tollClass: 'good', camping: 'Designated', campingClass: 'moderate', fuel: '$2.30/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Variable', waterAccess: 'Moderate' },
            'Romania': { tolls: 'Cheap', tollClass: 'good', camping: 'Tolerated', campingClass: 'good', fuel: '$1.40/L', fuelClass: 'good', visa: 'EU/90 days', roadQuality: 'Variable', waterAccess: 'Moderate' },
            'Greece': { tolls: 'Moderate', tollClass: 'moderate', camping: 'Restricted', campingClass: 'bad', fuel: '$1.85/L', fuelClass: 'bad', visa: 'EU/90 days', roadQuality: 'Good', waterAccess: 'Moderate' },
            'Australia': { tolls: 'City Only', tollClass: 'good', camping: 'Outback Free', campingClass: 'good', fuel: '$1.50/L', fuelClass: 'moderate', visa: 'eVisitor', roadQuality: 'Excellent', waterAccess: 'Variable' },
            'New Zealand': { tolls: 'Very Few', tollClass: 'good', camping: 'Freedom OK', campingClass: 'good', fuel: '$1.70/L', fuelClass: 'moderate', visa: '3 months', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'South Africa': { tolls: 'Moderate', tollClass: 'moderate', camping: 'Variable', campingClass: 'moderate', fuel: '$1.10/L', fuelClass: 'good', visa: '90 days', roadQuality: 'Good', waterAccess: 'Variable' },
            'Morocco': { tolls: 'Cheap', tollClass: 'good', camping: 'Very Easy', campingClass: 'good', fuel: '$1.20/L', fuelClass: 'good', visa: '90 days', roadQuality: 'Variable', waterAccess: 'Moderate' },
            'Japan': { tolls: 'Very High', tollClass: 'bad', camping: 'Michi-no-Eki', campingClass: 'moderate', fuel: '$1.40/L', fuelClass: 'good', visa: '90 days', roadQuality: 'Excellent', waterAccess: 'Easy' },
            'Namibia': { tolls: 'None!', tollClass: 'good', camping: 'Excellent', campingClass: 'good', fuel: '~$1.10/L', fuelClass: 'good', visa: '90 days free', roadQuality: 'Gravel roads', waterAccess: 'Plan ahead', special: '4x4 + rooftop tent recommended. Book NWR camps early!' }
        };

        // Default vanlifer info
        const defaultVanliferInfo = { tolls: 'Unknown', tollClass: 'moderate', camping: 'Research needed', campingClass: 'moderate', fuel: 'Varies', fuelClass: 'moderate', visa: 'Check requirements', roadQuality: 'Variable', waterAccess: 'Variable' };

        // ==================== CONTINENT MAPPING ====================
        const continentMapping = {
            '840': 'North America', '124': 'North America', '484': 'North America',
            '76': 'South America', '32': 'South America', '152': 'South America', '170': 'South America', '604': 'South America',
            '250': 'Europe', '276': 'Europe', '380': 'Europe', '724': 'Europe', '620': 'Europe', '826': 'Europe', '372': 'Europe',
            '752': 'Europe', '578': 'Europe', '352': 'Europe', '642': 'Europe', '300': 'Europe', '756': 'Europe',
            '156': 'Asia', '392': 'Asia', '410': 'Asia', '764': 'Asia', '704': 'Asia', '356': 'Asia',
            '36': 'Oceania', '554': 'Oceania',
            '710': 'Africa', '504': 'Africa', '818': 'Africa', '404': 'Africa'
        };

        // ==================== INITIALIZE ====================
        async function initMap() {
            svg = d3.select("#worldMap");
            g = svg.append("g");

            projection = d3.geoMercator()
                .scale(320)
                .translate([1000, 650]);

            path = d3.geoPath().projection(projection);

            try {
                const world = await d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json");
                const countries = topojson.feature(world, world.objects.countries);
                
                g.selectAll("path")
                    .data(countries.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .style("fill", DEFAULT_COLOR)
                    .attr("id", d => "country_" + d.id)
                    .attr("data-id", d => d.id)
                    .attr("data-name", d => d.properties.name || "Unknown")
                    .on("click", function(event, d) {
                        event.stopPropagation();
                        selectCountry(this, d);
                    })
                    .on("dblclick", function(event, d) {
                        event.stopPropagation();
                        event.preventDefault();
                        openCountrySatelliteView(d.properties.name || "Unknown");
                    })
                    .append("title")
                    .text(d => d.properties.name || "Unknown");

                countriesData = countries.features;
                populateCountrySearch();
                setupZoom();
                loadFromStorage();
                updateStats();
                renderRoadTrips();
                renderAlerts();
                
            } catch (error) {
                console.error("Error loading map:", error);
            }
        }

        function initRoadMap() {
            if (roadMap) return;
            
            roadMap = L.map('roadMap', {
                center: [30, 0],
                zoom: 2,
                zoomControl: false
            });

            // Base dark layer
            const darkBase = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: ' OpenStreetMap,  CARTO',
                maxZoom: 19
            });

            // Roads overlay - this shows highways prominently!
            const roadsOverlay = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            });

            // Alternative: OpenStreetMap style showing roads better
            const osmRoads = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap',
                maxZoom: 19,
                className: 'osm-roads-layer'
            });

            // Stamen terrain for adventure feel
            const stamenTerrain = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}{r}.png', {
                attribution: ' Stadia Maps,  OpenStreetMap',
                maxZoom: 18
            });

            // Default: Dark with roads
            darkBase.addTo(roadMap);
            roadsOverlay.addTo(roadMap);

            // Layer control
            const baseLayers = {
                " Dark Mode": darkBase,
                " Terrain": stamenTerrain,
                " OpenStreetMap": osmRoads
            };
            L.control.layers(baseLayers, null, { position: 'topright' }).addTo(roadMap);

            // Add road trip routes
            roadTrips.forEach(trip => {
                if (trip.waypoints && trip.waypoints.length > 1) {
                    const coords = trip.waypoints.map(w => [w[0], w[1]]);
                    
                    // Draw route line - different color for personal trips
                    const routeColor = trip.personalTrip ? '#22c55e' : '#f472b6';
                    const routeLine = L.polyline(coords, {
                        color: routeColor,
                        weight: trip.personalTrip ? 4 : 3,
                        opacity: 0.9,
                        dashArray: trip.personalTrip ? null : '10, 5'
                    }).addTo(roadMap);

                    // Add markers for waypoints
                    trip.waypoints.forEach((wp, idx) => {
                        const isStart = idx === 0;
                        const isEnd = idx === trip.waypoints.length - 1;
                        const markerIcon = isStart ? '' : (isEnd ? '' : '');
                        
                        const marker = L.marker([wp[0], wp[1]], {
                            icon: L.divIcon({
                                className: `custom-marker ${trip.personalTrip ? 'poi-marker' : 'poi-marker'}`,
                                html: markerIcon,
                                iconSize: [30, 30]
                            })
                        }).addTo(roadMap);

                        marker.bindPopup(`
                            <div class="route-popup">
                                <h4>${wp[2]}</h4>
                                <p><strong>${trip.icon} ${trip.name}</strong></p>
                                ${trip.personalTrip ? '<div style="color: #22c55e; font-size: 0.8rem;"> Visit</div>' : ''}
                                <div style="font-size: 0.8rem; color: #9494a8;">${trip.description}</div>
                            </div>
                        `);
                    });

                    // Add camping markers for trips that have them
                    if (trip.campingSites) {
                        trip.campingSites.forEach(camp => {
                            if (camp.coords) {
                                const campMarker = L.marker(camp.coords, {
                                    icon: L.divIcon({
                                        className: 'custom-marker',
                                        html: '',
                                        iconSize: [26, 26]
                                    })
                                }).addTo(roadMap);

                                campMarker.bindPopup(`
                                    <div class="route-popup">
                                        <h4> ${camp.name}</h4>
                                        <p><strong>${camp.type}</strong> - ${camp.location}</p>
                                        <div style="color: #22c55e; font-weight: bold;">${camp.price}/nuit</div>
                                        <div style="font-size: 0.8rem; color: #9494a8; margin-top: 4px;">${camp.facilities}</div>
                                    </div>
                                `);
                            }
                        });
                    }

                    routeLine.bindPopup(`
                        <div class="route-popup">
                            <h4>${trip.icon} ${trip.name}</h4>
                            <p>${trip.distance}  ${trip.duration}</p>
                            ${trip.personalTrip ? '<div style="color: #22c55e;"> Mon voyage - ' + trip.tripDate + '</div>' : ''}
                            <div style="font-size: 0.8rem; margin-top: 8px;">${trip.tips}</div>
                        </div>
                    `);
                }
            });

            // Add community alert markers
            communityAlerts.forEach(alert => {
                if (alert.lat && alert.lng) {
                    const alertIcon = L.divIcon({
                        className: `custom-marker ${alert.type === 'hazard' ? 'danger-marker' : 'alert-marker'}`,
                        html: getAlertIcon(alert.type),
                        iconSize: [30, 30]
                    });

                    L.marker([alert.lat, alert.lng], { icon: alertIcon })
                        .addTo(roadMap)
                        .bindPopup(`<div class="route-popup"><h4>${alert.title}</h4><p>${alert.description}</p></div>`);
                }
            });
        }

        // ==================== MODE SWITCHING ====================
        function switchMode(mode) {
            currentMode = mode;
            
            // Update tabs
            document.getElementById('diaryModeTab').classList.toggle('active', mode === 'diary');
            document.getElementById('serendipityModeTab').classList.toggle('active', mode === 'serendipity');
            
            // Update content visibility
            document.getElementById('diaryContent').classList.toggle('hidden', mode !== 'diary');
            document.getElementById('serendipityContent').classList.toggle('active', mode === 'serendipity');
            
            // Update logo
            const logoIcon = document.getElementById('logoIcon');
            const logoText = document.getElementById('logoText');
            
            if (mode === 'serendipity') {
                logoIcon.textContent = '';
                logoIcon.classList.add('serendipity-mode');
                logoText.textContent = 'Serendipity';
                
                // Show road map
                document.getElementById('worldMap').style.display = 'none';
                document.getElementById('roadMap').classList.add('active');
                document.getElementById('zoomControls').style.display = 'none';
                
                initRoadMap();
                setTimeout(() => roadMap.invalidateSize(), 100);
            } else {
                logoIcon.textContent = '';
                logoIcon.classList.remove('serendipity-mode');
                logoText.textContent = 'Travel Diary';
                
                // Show world map
                document.getElementById('worldMap').style.display = 'block';
                document.getElementById('roadMap').classList.remove('active');
                document.getElementById('zoomControls').style.display = 'flex';
            }
        }

        // ==================== COUNTRY SELECTION ====================
        function populateCountrySearch() {
            const select = document.getElementById('countrySearch');
            const sorted = countriesData
                .map(d => ({ id: d.id, name: d.properties.name || "Unknown" }))
                .sort((a, b) => a.name.localeCompare(b.name));

            sorted.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                select.appendChild(opt);
            });
        }

        function selectCountryByCode(id) {
            if (!id) return;
            const el = document.querySelector(`[data-id="${id}"]`);
            if (el) {
                const data = countriesData.find(d => d.id == id);
                selectCountry(el, data);
            }
        }

        function selectCountry(element, data) {
            if (selectedCountry) {
                d3.select(selectedCountry).classed("selected", false);
            }

            selectedCountry = element;
            currentCountryId = data.id;
            currentCountryName = data.properties.name || "Unknown";
            d3.select(selectedCountry).classed("selected", true);

            document.getElementById('selectedCountryName').textContent = currentCountryName;
            document.getElementById('selectedDisplay').classList.add('has-selection');
            document.getElementById('countrySearch').value = data.id;

            // Update vanlifer info and zoom to roads if in serendipity mode
            if (currentMode === 'serendipity') {
                showVanliferInfo(currentCountryName);
                zoomToCountryRoads(currentCountryName);
            }
            
            // Enable plan trip button in diary mode
            updatePlanTripButton();
        }

        function showVanliferInfo(countryName) {
            const info = vanliferInfo[countryName] || defaultVanliferInfo;
            const panel = document.getElementById('vanliferCountryInfo');
            
            document.getElementById('vanliferCountryName').textContent = countryName;
            document.getElementById('tollInfo').textContent = info.tolls;
            document.getElementById('tollInfo').className = `detail-value ${info.tollClass}`;
            document.getElementById('campingInfo').textContent = info.camping;
            document.getElementById('campingInfo').className = `detail-value ${info.campingClass}`;
            document.getElementById('fuelInfo').textContent = info.fuel;
            document.getElementById('fuelInfo').className = `detail-value ${info.fuelClass}`;
            document.getElementById('visaInfo').textContent = info.visa;
            document.getElementById('roadQualityInfo').textContent = info.roadQuality;
            document.getElementById('waterInfo').textContent = info.waterAccess;
            
            panel.style.display = 'block';
        }

        // ==================== ROAD TRIPS ====================
        function getAllTrips() {
            return [...roadTrips, ...userCreatedTrips];
        }

        function renderRoadTrips() {
            const container = document.getElementById('roadTripsList');
            const allTrips = getAllTrips();
            
            container.innerHTML = allTrips.map(trip => {
                const isCompleted = completedTrips.includes(trip.id);
                const ratingStars = trip.rating ? ''.repeat(Math.floor(trip.rating)) : '';
                const difficultyClass = trip.difficulty || 'moderate';
                
                return `
                <div class="road-trip-card ${activeRoute === trip.id ? 'active' : ''} ${trip.personalTrip ? 'personal' : ''} ${isCompleted ? 'completed' : ''} ${trip.userCreated ? 'user-created' : ''}" onclick="selectRoute('${trip.id}')" ondblclick="event.stopPropagation(); openTripDetail('${trip.id}')">
                    ${isCompleted ? '<div class="trip-completed-badge"></div>' : ''}
                    <div class="road-trip-header">
                        <span class="road-trip-icon">${trip.icon}</span>
                        <span class="road-trip-name">${trip.name}</span>
                        ${trip.personalTrip ? `<span class="personal-badge"> Mon voyage</span>` : ''}
                        ${trip.userCreated ? `<span class="user-created-badge"> Community</span>` : ''}
                        ${trip.difficulty ? `<span class="difficulty-badge ${difficultyClass}">${difficultyClass}</span>` : ''}
                    </div>
                    <div class="road-trip-meta">
                        <span> ${trip.country}</span>
                        <span> ${trip.distance}</span>
                        <span> ${trip.duration}</span>
                    </div>
                    ${trip.rating ? `
                        <div class="road-trip-rating">
                            <span>${ratingStars}</span>
                            <span class="rating-value">${trip.rating}</span>
                            <span style="color: var(--text-muted);">(${trip.reviews ? trip.reviews.length : 0} reviews)</span>
                        </div>
                    ` : ''}
                    ${trip.tripDate ? `<div style="font-size: 0.7rem; color: var(--success); margin-top: 4px;"> ${trip.tripDate}</div>` : ''}
                    <div class="road-trip-tags">
                        ${trip.tags.map(t => `<span class="road-tag ${t}">${t === 'fourx4' ? '4x4' : t}</span>`).join('')}
                    </div>
                    <button class="view-details-btn" onclick="event.stopPropagation(); openTripDetail('${trip.id}')">View Details </button>
                    ${!isCompleted ? `<button class="complete-btn" onclick="event.stopPropagation(); markTripCompleted('${trip.id}')"> Done</button>` : ''}
                </div>
            `}).join('');
            
            updateLeagueStats();
        }

        function selectRoute(routeId) {
            activeRoute = routeId;
            renderRoadTrips();
            
            const allTrips = getAllTrips();
            const trip = allTrips.find(t => t.id === routeId);
            if (trip && roadMap && trip.waypoints) {
                const bounds = L.latLngBounds(trip.waypoints.map(w => [w[0], w[1]]));
                roadMap.fitBounds(bounds, { padding: [50, 50] });
                
                // Show route details panel if route has rental/camping info
                const detailsPanel = document.getElementById('routeDetailsPanel');
                if (trip.rentalProviders || trip.campingSites) {
                    detailsPanel.style.display = 'block';
                    renderRouteDetails(trip);
                } else {
                    detailsPanel.style.display = 'none';
                }
            }
            
            updateStats();
        }

        // ==================== TRIP DETAIL MODAL ====================
        let currentDetailTrip = null;
        let userRating = 0;

        // Tab switching for trip detail modal
        function switchTripTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.trip-nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            // Update tab content
            document.querySelectorAll('.trip-tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabName}`);
            });
        }

        function openTripDetail(tripId) {
            const allTrips = getAllTrips();
            const trip = allTrips.find(t => t.id === tripId);
            if (!trip) return;

            currentDetailTrip = trip;
            document.getElementById('tripDetailModal').classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scroll
            
            // Reset to overview tab
            switchTripTab('overview');
            
            // Populate Hero Header
            document.getElementById('tripDetailIcon').textContent = trip.icon;
            document.getElementById('tripDetailName').textContent = trip.name;
            document.getElementById('tripDetailCountry').textContent = trip.country;
            document.getElementById('tripDetailDistance').textContent = trip.distance;
            document.getElementById('tripDetailDuration').textContent = trip.duration;
            
            // Rating in hero
            const rating = trip.rating || 4.0;
            document.getElementById('tripDetailRating').textContent = rating.toFixed(1);
            document.getElementById('tripHeroStars').textContent = ''.repeat(Math.round(rating));
            document.getElementById('tripReviewsCount').textContent = trip.reviews ? trip.reviews.length : 0;
            document.getElementById('tripBigRating').textContent = rating.toFixed(1);
            
            // Tags in hero
            const tagsContainer = document.getElementById('tripHeroTags');
            if (trip.tags && trip.tags.length > 0) {
                tagsContainer.innerHTML = trip.tags.map(t => `<span class="tag">${t === 'fourx4' ? '4x4' : t}</span>`).join('');
            } else {
                tagsContainer.innerHTML = '';
            }

            // Populate Stats
            document.getElementById('tripDetailDifficulty').textContent = (trip.difficulty || 'moderate').charAt(0).toUpperCase() + (trip.difficulty || 'moderate').slice(1);
            document.getElementById('tripDetailSeason').textContent = trip.bestSeason || 'Year-round';
            document.getElementById('tripDetailBudget').textContent = trip.budget || 'Varies';

            // Description
            document.getElementById('tripDetailDescription').textContent = trip.description || 'An amazing road trip adventure awaits!';

            // Highlights
            const highlightsGrid = document.getElementById('tripDetailHighlights');
            if (trip.highlights && trip.highlights.length > 0) {
                highlightsGrid.innerHTML = trip.highlights.map(h => `<span class="highlight-tag">${h}</span>`).join('');
            } else {
                highlightsGrid.innerHTML = '<span style="color: var(--text-muted);">No highlights listed yet</span>';
            }

            // Must Know
            const mustKnowList = document.getElementById('tripDetailMustKnow');
            if (trip.mustKnow && trip.mustKnow.length > 0) {
                mustKnowList.innerHTML = trip.mustKnow.map(item => `<li>${item}</li>`).join('');
            } else {
                mustKnowList.innerHTML = '<li> No specific tips available yet. Check the community tab for discussions!</li>';
            }

            // Recommendations
            const recommendationsContainer = document.getElementById('tripRecommendations');
            if (trip.recommendations && trip.recommendations.length > 0) {
                recommendationsContainer.innerHTML = trip.recommendations.map(rec => `
                    <div class="recommendation-item">
                        <div class="rec-icon">${rec.icon}</div>
                        <div>
                            <div class="rec-title">${rec.title}</div>
                            <div class="rec-desc">${rec.desc}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                recommendationsContainer.innerHTML = '<p style="color: var(--text-muted);">No recommendations yet. Share yours in the community!</p>';
            }

            // Packing List
            const packingContainer = document.getElementById('tripPackingList');
            if (trip.packingList && trip.packingList.length > 0) {
                packingContainer.innerHTML = trip.packingList.map(item => `
                    <div class="packing-item ${item.essential ? 'essential' : ''}">
                        <span>${item.item}</span>
                    </div>
                `).join('');
            } else {
                packingContainer.innerHTML = `
                    <div class="packing-item essential"> Offline maps</div>
                    <div class="packing-item essential"> Water bottles</div>
                    <div class="packing-item"> Camera</div>
                    <div class="packing-item essential"> Phone charger</div>
                `;
            }

            // Waypoints (Route Tab)
            const waypointsList = document.getElementById('tripDetailWaypoints');
            if (trip.waypoints && trip.waypoints.length > 0) {
                document.getElementById('waypointsCount').textContent = trip.waypoints.length;
                waypointsList.innerHTML = trip.waypoints.map((wp, idx) => `
                    <div class="waypoint-item">
                        <div class="waypoint-name">${wp[2] || 'Stop ' + (idx + 1)}</div>
                        ${wp[3] ? `<div class="waypoint-desc">${wp[3]}</div>` : ''}
                    </div>
                `).join('');
            } else {
                document.getElementById('waypointsCount').textContent = '0';
                waypointsList.innerHTML = '<p style="color: var(--text-muted); padding: 20px;">No detailed waypoints available. Check the map view for the route.</p>';
            }

            // Costs (Budget Tab)
            if (trip.costs) {
                document.getElementById('tripFuelCost').textContent = trip.costs.fuel || 'N/A';
                document.getElementById('tripTollCost').textContent = trip.costs.tolls || 'N/A';
                document.getElementById('tripAccomCost').textContent = trip.costs.accommodation || 'N/A';
                document.getElementById('tripFoodCost').textContent = trip.costs.food || 'N/A';
                document.getElementById('tripTotalCost').textContent = trip.costs.total || 'Varies';
            } else {
                // Estimate costs based on distance
                const distKm = parseInt(trip.distance) || 1000;
                const days = parseInt(trip.duration) || 7;
                const estFuel = Math.round(distKm * 0.12);
                const estAccom = days * 80;
                const estFood = days * 50;
                document.getElementById('tripFuelCost').textContent = `~$${estFuel}`;
                document.getElementById('tripTollCost').textContent = 'Varies';
                document.getElementById('tripAccomCost').textContent = `~$${estAccom}`;
                document.getElementById('tripFoodCost').textContent = `~$${estFood}`;
                document.getElementById('tripTotalCost').textContent = `~$${estFuel + estAccom + estFood}`;
            }

            // Planning Steps (Planning Tab)
            const planningStepsContainer = document.getElementById('tripPlanningSteps');
            if (trip.planningSteps && trip.planningSteps.length > 0) {
                planningStepsContainer.innerHTML = trip.planningSteps.map((step, idx) => `
                    <div class="planning-step">
                        <div class="step-number">${idx + 1}</div>
                        <div class="step-content">
                            <div class="step-title">${step.title}</div>
                            <div class="step-desc">${step.desc}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                planningStepsContainer.innerHTML = `
                    <div class="planning-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">Research the Route</div>
                            <div class="step-desc">Study the waypoints, check road conditions, and plan your daily distances.</div>
                        </div>
                    </div>
                    <div class="planning-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">Book Accommodations</div>
                            <div class="step-desc">Reserve hotels, campsites, or B&Bs along the route, especially in peak season.</div>
                        </div>
                    </div>
                    <div class="planning-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Prepare Your Vehicle</div>
                            <div class="step-desc">Service your car, check tires, and ensure you have emergency supplies.</div>
                        </div>
                    </div>
                    <div class="planning-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <div class="step-title">Download Offline Maps</div>
                            <div class="step-desc">Ensure you have offline access to navigation - cell service may be spotty.</div>
                        </div>
                    </div>
                `;
            }

            // Reviews (Community Tab)
            renderTripReviews(trip);
            
            // Reset rating input
            userRating = 0;
            updateRatingStars();

            // Load chat (Community Tab)
            renderTripChat(tripId);
            setChatType('question');
        }

        function closeTripDetailModal() {
            document.getElementById('tripDetailModal').classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
            currentDetailTrip = null;
        }

        function renderTripReviews(trip) {
            const reviewsList = document.getElementById('tripDetailReviews');
            
            if (trip.reviews && trip.reviews.length > 0) {
                reviewsList.innerHTML = trip.reviews.map(review => `
                    <div class="review-item ${review.isOwner ? 'owner-review' : ''}">
                        <div class="review-header">
                            <span class="review-user">${review.isOwner ? ' ' : ''}${review.user}</span>
                            <span class="review-rating">${''.repeat(review.rating)}</span>
                        </div>
                        <div class="review-text">${review.text}</div>
                        <div class="review-date">${review.date}</div>
                    </div>
                `).join('');
            } else {
                reviewsList.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No reviews yet. Be the first!</p>';
            }
        }

        function updateRatingStars() {
            document.querySelectorAll('.rating-star').forEach((star, idx) => {
                star.textContent = idx < userRating ? '' : '';
                star.classList.toggle('active', idx < userRating);
            });
        }

        // Rating star click handler
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('rating-star')) {
                userRating = parseInt(e.target.dataset.rating);
                updateRatingStars();
            }
        });

        function submitTripReview() {
            if (!currentDetailTrip) return;
            
            const reviewText = document.getElementById('newReviewText').value.trim();
            if (!reviewText) {
                alert('Please write a review');
                return;
            }
            if (userRating === 0) {
                alert('Please select a rating');
                return;
            }

            const newReview = {
                user: userName,
                rating: userRating,
                text: reviewText,
                date: 'Just now'
            };

            // Add to trip's reviews
            if (!currentDetailTrip.reviews) {
                currentDetailTrip.reviews = [];
            }
            currentDetailTrip.reviews.unshift(newReview);

            // Update average rating
            const avgRating = currentDetailTrip.reviews.reduce((acc, r) => acc + r.rating, 0) / currentDetailTrip.reviews.length;
            currentDetailTrip.rating = Math.round(avgRating * 10) / 10;

            // Refresh display
            renderTripReviews(currentDetailTrip);
            document.getElementById('tripDetailRating').textContent = currentDetailTrip.rating.toFixed(1);
            renderRoadTrips();
            saveToStorage();

            // Clear form
            document.getElementById('newReviewText').value = '';
            userRating = 0;
            updateRatingStars();

            alert('Thank you for your review! ');
        }

        function viewTripOnMap() {
            if (!currentDetailTrip) return;
            closeTripDetailModal();
            selectRoute(currentDetailTrip.id);
        }

        function markCurrentTripCompleted() {
            if (!currentDetailTrip) return;
            markTripCompleted(currentDetailTrip.id);
            closeTripDetailModal();
        }

        function shareTripLink() {
            if (!currentDetailTrip) return;
            const shareText = `Check out this road trip: ${currentDetailTrip.name} (${currentDetailTrip.distance}) - ${currentDetailTrip.description}`;
            
            if (navigator.share) {
                navigator.share({
                    title: currentDetailTrip.name,
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Trip details copied to clipboard! ');
                });
            }
        }

        // ==================== TRIP COMMUNITY CHAT ====================
        let tripChatMessages = JSON.parse(localStorage.getItem('tripChatMessages')) || {};
        let currentChatType = 'question';

        // Pre-populated chat messages for key trips
        const defaultChatMessages = {
            'route66': [
                { id: 1, user: 'RoadWarrior88', badge: 'verified', type: 'tip', text: 'Pro tip: Don\'t skip Seligman, AZ - it\'s the inspiration for the movie Cars and has amazing diners! The Angel\'s barber shop is a must-visit.', time: '2 hours ago', reactions: { '': 12, '': 5 }, replies: [
                    { user: 'TravelJunkie', text: 'Second this! Best pie on the whole route.', time: '1 hour ago' }
                ]},
                { id: 2, user: 'DesertExplorer', badge: 'expert', type: 'experience', text: 'Just finished the route last week! The Painted Desert blew my mind. Make sure you have at least 2-3 hours there - sunset is incredible.', time: '5 hours ago', reactions: { '': 8, '': 3 }, replies: [] },
                { id: 3, user: 'FirstTimer2024', badge: null, type: 'question', text: 'Planning to do this in March - is the weather good? Also, any recommendations for a reliable car rental in Chicago?', time: '1 day ago', reactions: { '': 2 }, replies: [
                    { user: 'RoadWarrior88', text: 'March is perfect! Not too hot yet. Budget or Enterprise are reliable in Chicago.', time: '20 hours ago' },
                    { user: 'LocalGuide', text: 'Watch for wind in New Mexico/Arizona in March. Can be dusty!', time: '18 hours ago' }
                ]},
                { id: 4, user: 'VanlifeKing', badge: 'verified', type: 'tip', text: ' IMPORTANT: Between Kingman and Needles, gas stations are 100+ miles apart. Fill up every chance you get in the desert sections!', time: '2 days ago', reactions: { '': 24, '': 8 }, replies: [] }
            ],
            'wildatlantic': [
                { id: 1, user: 'IrishRoads', badge: 'expert', type: 'tip', text: 'Drive CLOCKWISE! This keeps you on the ocean side and the views are 10x better. Trust me on this one.', time: '3 hours ago', reactions: { '': 18, '': 7 }, replies: [
                    { user: 'WanderlustSara', text: 'This is THE best advice. Counter-clockwise means you\'re looking at hedges instead of cliffs!', time: '2 hours ago' }
                ]},
                { id: 2, user: 'CamperVanDan', badge: 'verified', type: 'experience', text: 'Wild camped at Malin Head last night - the most northwestern point of Ireland. Northern lights appeared at 2am! Magical experience.', time: '1 day ago', reactions: { '': 15, '': 12, '': 8 }, replies: [] },
                { id: 3, user: 'TravelNewbie', badge: null, type: 'question', text: 'Is it true you need to book Skellig Michael months in advance? We\'re going in July...', time: '2 days ago', reactions: { '': 3 }, replies: [
                    { user: 'IrishRoads', text: 'Yes! Boats are limited and weather-dependent. Book 3-4 months ahead for summer. Check skelligs.com', time: '1 day ago' },
                    { user: 'StarWarsFan', text: 'We got lucky with a cancellation. Check daily for openings!', time: '1 day ago' }
                ]},
                { id: 4, user: 'PhotoNomad', badge: 'expert', type: 'tip', text: ' Golden hour at Cliffs of Moher is around 8-9pm in summer. Stay after the crowds leave - totally different experience!', time: '3 days ago', reactions: { '': 22, '': 15 }, replies: [] }
            ],
            'namibia_highlights': [
                { id: 1, user: 'SafariSol', badge: 'verified', type: 'experience', text: 'Just did this exact route! Dune 45 at sunrise was the highlight. Get there by 5:30am - the colors changing on the dunes are unreal. Worth the early wake up!', time: '1 week ago', reactions: { '': 20, '': 12, '': 8 }, replies: [
                    { user: 'OverlandAfrica', text: 'The climb is harder than it looks! Bring water and go slow.', time: '6 days ago' }
                ]},
                { id: 2, user: 'DesertNomad', badge: 'expert', type: 'tip', text: ' CRITICAL: Download Tracks4Africa app before you go. Cell service is non-existent in most of Namibia. This app saved us multiple times!', time: '2 weeks ago', reactions: { '': 35, '': 12 }, replies: [
                    { user: 'SafariSol', text: 'Can confirm - this is essential! Also has all campsites marked.', time: '1 week ago' }
                ]},
                { id: 3, user: 'CoupleAdventure', badge: null, type: 'question', text: 'First time doing a rooftop tent trip. Any tips for setting up camp? We\'re a bit nervous about wild camping...', time: '3 days ago', reactions: { '': 5 }, replies: [
                    { user: 'DesertNomad', text: 'It\'s super safe! Just pick official campsites. NWR camps have fences. Set up before dark and you\'ll be fine!', time: '2 days ago' },
                    { user: 'SafariSol', text: 'The rooftop tent is actually easy - practice at the rental place first. Most animals ignore you up there!', time: '2 days ago' },
                    { user: 'WildlifeWatcher', text: 'Bring a headlamp! Essential for nighttime bathroom trips. And enjoy the stars - they\'re incredible.', time: '1 day ago' }
                ]},
                { id: 4, user: 'BudgetTraveler', badge: null, type: 'question', text: 'How much should I budget for fuel? The distances look massive...', time: '4 days ago', reactions: { '': 8 }, replies: [
                    { user: 'DesertNomad', text: 'Budget about 350-400 for the full route. Fill up EVERY station - some are 300km apart! Toyota Hilux uses about 12L/100km on gravel.', time: '3 days ago' }
                ]}
            ]
        };

        function loadTripChat(tripId) {
            // Merge default messages with user messages
            const defaultMsgs = defaultChatMessages[tripId] || [];
            const userMsgs = tripChatMessages[tripId] || [];
            
            const allMessages = [...defaultMsgs, ...userMsgs].sort((a, b) => {
                // Keep order, but user messages at the end
                if (a.id > 100 && b.id <= 100) return 1;
                if (b.id > 100 && a.id <= 100) return -1;
                return 0;
            });
            
            return allMessages;
        }

        function renderTripChat(tripId) {
            const container = document.getElementById('tripChatMessages');
            const messages = loadTripChat(tripId);
            
            // Simulate online count
            const onlineCount = Math.floor(Math.random() * 15) + 5;
            document.getElementById('chatOnlineCount').textContent = ` ${onlineCount} online`;
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                        <p>Be the first to start a conversation about this trip!</p>
                        <p style="font-size: 0.8rem;">Ask questions, share tips, or tell us about your experience.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map(msg => `
                <div class="chat-message ${msg.type} ${msg.own ? 'own' : ''}" data-msg-id="${msg.id}">
                    <div class="chat-msg-header">
                        <span class="chat-msg-user">${msg.user}</span>
                        ${msg.badge ? `<span class="chat-msg-badge ${msg.badge}">${msg.badge === 'verified' ? ' Verified' : ' Expert'}</span>` : ''}
                    </div>
                    <div class="chat-msg-text">${msg.text}</div>
                    <div class="chat-msg-footer">
                        <div class="chat-msg-reactions">
                            ${Object.entries(msg.reactions || {}).map(([emoji, count]) => `
                                <span class="chat-reaction" onclick="reactToMessage(${msg.id}, '${emoji}')">${emoji} ${count}</span>
                            `).join('')}
                            <span class="chat-reaction" onclick="reactToMessage(${msg.id}, '')">+</span>
                        </div>
                        <span>${msg.time}</span>
                    </div>
                    ${msg.replies && msg.replies.length > 0 ? `
                        <div class="chat-replies">
                            ${msg.replies.map(reply => `
                                <div class="chat-reply">
                                    <strong>${reply.user}:</strong> ${reply.text}
                                    <span style="color: var(--text-muted); margin-left: 8px;">${reply.time}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <span class="chat-reply-btn" onclick="replyToMessage(${msg.id})"> Reply</span>
                </div>
            `).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function setChatType(type) {
            currentChatType = type;
            // Handle both old and new class names
            document.querySelectorAll('.chat-type-btn, .chat-pill').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            
            const input = document.getElementById('chatMessageInput');
            if (input) {
                const placeholders = {
                    'question': 'Ask the community...',
                    'tip': 'Share a helpful tip...',
                    'experience': 'Tell your story...'
                };
                input.placeholder = placeholders[type] || 'Type a message...';
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatMessageInput');
            const text = input.value.trim();
            if (!text || !currentDetailTrip) return;

            const tripId = currentDetailTrip.id;
            if (!tripChatMessages[tripId]) {
                tripChatMessages[tripId] = [];
            }

            const newMessage = {
                id: Date.now(),
                user: userName || 'Anonymous Traveler',
                badge: null,
                type: currentChatType,
                text: text,
                time: 'Just now',
                reactions: {},
                replies: [],
                own: true
            };

            tripChatMessages[tripId].push(newMessage);
            localStorage.setItem('tripChatMessages', JSON.stringify(tripChatMessages));

            input.value = '';
            renderTripChat(tripId);

            // Show confirmation
            showToast('Message posted! ');
        }

        function reactToMessage(msgId, emoji) {
            if (!currentDetailTrip) return;
            const tripId = currentDetailTrip.id;
            
            // Find message in user messages
            if (tripChatMessages[tripId]) {
                const msg = tripChatMessages[tripId].find(m => m.id === msgId);
                if (msg) {
                    if (!msg.reactions) msg.reactions = {};
                    msg.reactions[emoji] = (msg.reactions[emoji] || 0) + 1;
                    localStorage.setItem('tripChatMessages', JSON.stringify(tripChatMessages));
                }
            }
            
            renderTripChat(tripId);
        }

        function replyToMessage(msgId) {
            const input = document.getElementById('chatMessageInput');
            input.focus();
            input.placeholder = `Reply to message...`;
            input.dataset.replyTo = msgId;
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--accent-primary);
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                font-size: 0.9rem;
                z-index: 10001;
                animation: fadeInUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Add Enter key listener for chat
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatMessageInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        });

        function renderRouteDetails(trip) {
            // Render rental providers
            const rentalContainer = document.getElementById('rentalProvidersList');
            if (trip.rentalProviders && trip.rentalProviders.length > 0) {
                rentalContainer.innerHTML = trip.rentalProviders.map(r => `
                    <div class="rental-card">
                        <div class="rental-header">
                            <span class="rental-name"><a href="${r.url}" target="_blank"> ${r.name}</a></span>
                            <span class="rental-rating">${r.rating}</span>
                        </div>
                        <div class="rental-note">${r.note}</div>
                    </div>
                `).join('');
            } else {
                rentalContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.8rem;">Pas d\'info disponible</p>';
            }

            // Render camping sites
            const campingContainer = document.getElementById('campingSitesList');
            if (trip.campingSites && trip.campingSites.length > 0) {
                campingContainer.innerHTML = trip.campingSites.map(c => `
                    <div class="camping-card" onclick="focusOnCamping(${c.coords[0]}, ${c.coords[1]}, '${c.name}')">
                        <div class="camping-header">
                            <span class="camping-name"> ${c.name}</span>
                            <span class="camping-type ${c.type.toLowerCase()}">${c.type}</span>
                        </div>
                        <div class="camping-location"> ${c.location}</div>
                        <div class="camping-info">
                            <span class="camping-price"> ${c.price}/nuit</span>
                            <span class="camping-facilities">${c.facilities}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                campingContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.8rem;">Pas d\'info disponible</p>';
            }
        }

        function focusOnCamping(lat, lng, name) {
            if (roadMap) {
                roadMap.setView([lat, lng], 12);
                L.popup()
                    .setLatLng([lat, lng])
                    .setContent(`<div class="route-popup"><h4> ${name}</h4></div>`)
                    .openOn(roadMap);
            }
        }

        // ==================== LEAGUE SYSTEM ====================
        function markTripCompleted(tripId) {
            if (!completedTrips.includes(tripId)) {
                completedTrips.push(tripId);
                saveToStorage();
                renderRoadTrips();
                updateLeagueStats();
                
                // Show celebration
                const allTrips = getAllTrips();
                const trip = allTrips.find(t => t.id === tripId);
                if (trip) {
                    alert(` Congratulations! You completed "${trip.name}"!\n\n+${parseInt(trip.distance) || 0} km added to your total!`);
                }
            }
        }

        function updateLeagueStats() {
            const allTrips = getAllTrips();
            const completedCount = completedTrips.length;
            
            // Calculate total km
            let totalKm = 0;
            completedTrips.forEach(tripId => {
                const trip = allTrips.find(t => t.id === tripId);
                if (trip) {
                    const km = parseInt(trip.distance.replace(/[^\d]/g, '')) || 0;
                    totalKm += km;
                }
            });
            
            // Update UI
            document.getElementById('completedTripsCount').textContent = completedCount;
            document.getElementById('totalKmCount').textContent = totalKm.toLocaleString();
            
            // Calculate rank and badge
            const { badge, title, rank } = calculateLeagueBadge(completedCount);
            document.getElementById('leagueBadge').innerHTML = `
                <span class="badge-icon">${badge}</span>
                <span class="badge-title">${title}</span>
            `;
            document.getElementById('userRank').textContent = rank;
        }

        function calculateLeagueBadge(completedCount) {
            if (completedCount >= 16) return { badge: '', title: 'Legendary Explorer', rank: '' };
            if (completedCount >= 11) return { badge: '', title: 'World Traveler', rank: '#1' };
            if (completedCount >= 6) return { badge: '', title: 'Adventure Seeker', rank: '#2' };
            if (completedCount >= 3) return { badge: '', title: 'Road Warrior', rank: '#3' };
            return { badge: '', title: 'Beginner Explorer', rank: '-' };
        }

        // ==================== LEADERBOARD ====================
        function openLeaderboardModal() {
            document.getElementById('leaderboardModal').classList.add('active');
            renderLeaderboard();
        }

        function closeLeaderboardModal() {
            document.getElementById('leaderboardModal').classList.remove('active');
        }

        function renderLeaderboard() {
            const container = document.getElementById('leaderboardList');
            
            // Simulated leaderboard data (in real app, would come from a server)
            const allTrips = getAllTrips();
            let userTotalKm = 0;
            completedTrips.forEach(tripId => {
                const trip = allTrips.find(t => t.id === tripId);
                if (trip) userTotalKm += parseInt(trip.distance.replace(/[^\d]/g, '')) || 0;
            });
            
            const leaderboard = [
                { name: 'NomadKing', trips: 23, km: 45000, badge: '' },
                { name: 'WanderlustQueen', trips: 18, km: 38000, badge: '' },
                { name: 'RoadWarrior2000', trips: 14, km: 28000, badge: '' },
                { name: 'VanlifeVibes', trips: 11, km: 22000, badge: '' },
                { name: userName, trips: completedTrips.length, km: userTotalKm, badge: calculateLeagueBadge(completedTrips.length).badge, isCurrentUser: true },
                { name: 'AdventureAlex', trips: 8, km: 15000, badge: '' },
                { name: 'SunsetChaser', trips: 5, km: 9500, badge: '' },
                { name: 'MountainMike', trips: 3, km: 5200, badge: '' }
            ].sort((a, b) => b.trips - a.trips || b.km - a.km);
            
            container.innerHTML = leaderboard.map((user, idx) => {
                const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
                return `
                    <div class="leaderboard-item ${user.isCurrentUser ? 'current-user' : ''}">
                        <div class="leaderboard-rank ${rankClass}">${idx + 1}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${user.name} ${user.isCurrentUser ? '(You)' : ''}</div>
                            <div class="leaderboard-stats">${user.trips} trips  ${user.km.toLocaleString()} km</div>
                        </div>
                        <div class="leaderboard-badge">${user.badge}</div>
                    </div>
                `;
            }).join('');
        }

        // ==================== CREATE ROAD TRIP ====================
        function openCreateTripModal() {
            document.getElementById('createTripModal').classList.add('active');
        }

        function closeCreateTripModal() {
            document.getElementById('createTripModal').classList.remove('active');
        }

        function addWaypoint() {
            const container = document.getElementById('waypointsList');
            const newRow = document.createElement('div');
            newRow.className = 'waypoint-row';
            newRow.innerHTML = `
                <input type="text" class="form-input waypoint-name" placeholder="Place name">
                <input type="number" class="form-input waypoint-lat" placeholder="Latitude" step="0.0001">
                <input type="number" class="form-input waypoint-lng" placeholder="Longitude" step="0.0001">
                <button class="btn-icon" onclick="removeWaypoint(this)" title="Remove"></button>
            `;
            container.appendChild(newRow);
        }

        function removeWaypoint(btn) {
            const rows = document.querySelectorAll('.waypoint-row');
            if (rows.length > 2) {
                btn.parentElement.remove();
            } else {
                alert('Minimum 2 waypoints required');
            }
        }

        function submitNewTrip() {
            const name = document.getElementById('newTripName').value.trim();
            const country = document.getElementById('newTripCountry').value.trim();
            const distance = document.getElementById('newTripDistance').value;
            const duration = document.getElementById('newTripDuration').value.trim();
            const icon = document.getElementById('newTripIcon').value.trim() || '';
            const description = document.getElementById('newTripDescription').value.trim();
            const tips = document.getElementById('newTripTips').value.trim();
            
            // Get selected tags
            const tags = Array.from(document.querySelectorAll('.tag-selector input:checked')).map(cb => cb.value);
            
            // Get waypoints
            const waypointRows = document.querySelectorAll('.waypoint-row');
            const waypoints = [];
            waypointRows.forEach(row => {
                const placeName = row.querySelector('.waypoint-name').value.trim();
                const lat = parseFloat(row.querySelector('.waypoint-lat').value);
                const lng = parseFloat(row.querySelector('.waypoint-lng').value);
                if (placeName && !isNaN(lat) && !isNaN(lng)) {
                    waypoints.push([lat, lng, placeName]);
                }
            });
            
            // Validation
            if (!name || !country || !distance || !duration || !description) {
                alert('Please fill in all required fields (*)');
                return;
            }
            if (waypoints.length < 2) {
                alert('Please add at least 2 valid waypoints with coordinates');
                return;
            }
            
            // Create new trip
            const newTrip = {
                id: 'user_' + Date.now(),
                name: name,
                icon: icon,
                country: country,
                distance: distance + ' km',
                duration: duration,
                coordinates: [waypoints[0].slice(0, 2), waypoints[waypoints.length - 1].slice(0, 2)],
                waypoints: waypoints,
                tags: tags,
                description: description,
                tips: tips,
                userCreated: true,
                createdBy: userName,
                createdAt: new Date().toISOString()
            };
            
            userCreatedTrips.push(newTrip);
            saveToStorage();
            renderRoadTrips();
            
            // Add to map
            if (roadMap) {
                addTripToMap(newTrip);
            }
            
            closeCreateTripModal();
            alert(` Your road trip "${name}" has been added!\n\nIt's now available for everyone in the community.`);
            
            // Reset form
            document.getElementById('newTripName').value = '';
            document.getElementById('newTripCountry').value = '';
            document.getElementById('newTripDistance').value = '';
            document.getElementById('newTripDuration').value = '';
            document.getElementById('newTripIcon').value = '';
            document.getElementById('newTripDescription').value = '';
            document.getElementById('newTripTips').value = '';
            document.querySelectorAll('.tag-selector input').forEach(cb => cb.checked = false);
        }

        function addTripToMap(trip) {
            if (!roadMap || !trip.waypoints) return;
            
            const coords = trip.waypoints.map(w => [w[0], w[1]]);
            const routeLine = L.polyline(coords, {
                color: '#a855f7', // Purple for user-created
                weight: 3,
                opacity: 0.8,
                dashArray: '5, 10'
            }).addTo(roadMap);

            trip.waypoints.forEach((wp, idx) => {
                const marker = L.marker([wp[0], wp[1]], {
                    icon: L.divIcon({
                        className: 'custom-marker poi-marker',
                        html: idx === 0 ? '' : (idx === trip.waypoints.length - 1 ? '' : ''),
                        iconSize: [30, 30]
                    })
                }).addTo(roadMap);

                marker.bindPopup(`
                    <div class="route-popup">
                        <h4>${wp[2]}</h4>
                        <p>${trip.name}</p>
                        <div style="font-size: 0.8rem; color: #a855f7;"> Community Trip</div>
                    </div>
                `);
            });
        }

        // ==================== COUNTRY ROAD VIEWER ====================
        function zoomToCountryRoads(countryName) {
            if (!roadMap || currentMode !== 'serendipity') return;
            
            const coords = countryCoordinates[countryName];
            if (coords) {
                roadMap.setView([coords[0], coords[1]], coords[2]);
                
                // Update UI
                document.getElementById('countryRoadsInfo').style.display = 'block';
                document.getElementById('selectedRoadsCountry').textContent = ` ${countryName} - Main Roads`;
            }
        }

        function resetRoadMapView() {
            if (roadMap) {
                roadMap.setView([30, 0], 2);
                document.getElementById('countryRoadsInfo').style.display = 'none';
            }
        }

        // ==================== TRIP PLANNER (DIARY MODE) ====================
        function openTripPlannerModal() {
            if (!currentCountryName || currentCountryName === 'Unknown') {
                alert('Please select a country first!');
                return;
            }
            
            document.getElementById('tripPlannerModal').classList.add('active');
            document.getElementById('plannerCountryName').textContent = currentCountryName;
            
            // Initialize planner map
            setTimeout(() => {
                initTripPlannerMap();
            }, 100);
        }

        function closeTripPlannerModal() {
            document.getElementById('tripPlannerModal').classList.remove('active');
        }

        function initTripPlannerMap() {
            if (tripPlannerMap) {
                tripPlannerMap.remove();
            }

            const coords = countryCoordinates[currentCountryName] || [30, 0, 3];
            
            tripPlannerMap = L.map('tripPlannerMap', {
                center: [coords[0], coords[1]],
                zoom: coords[2] || 6,
                zoomControl: true
            });

            // Add OpenStreetMap tiles (shows roads clearly)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(tripPlannerMap);

            // Click handler to add stops
            tripPlannerMap.on('click', function(e) {
                addPlannerStop(e.latlng.lat, e.latlng.lng);
            });

            // Clear previous session
            plannerMarkers = [];
            plannerStops = [];
            if (plannerRoute) {
                plannerRoute.remove();
                plannerRoute = null;
            }
            updatePlannerUI();
        }

        function setStopType(type) {
            currentStopType = type;
            document.querySelectorAll('.stop-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
        }

        function getStopIcon(type) {
            const icons = {
                'waypoint': '',
                'camping': '',
                'fuel': '',
                'hotel': '',
                'atm': '',
                'viewpoint': '',
                'restaurant': ''
            };
            return icons[type] || '';
        }

        function addPlannerStop(lat, lng) {
            const stopId = Date.now();
            const stop = {
                id: stopId,
                type: currentStopType,
                lat: lat,
                lng: lng,
                name: `${getStopIcon(currentStopType)} Stop ${plannerStops.length + 1}`
            };
            
            plannerStops.push(stop);

            // Add marker
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'planner-marker',
                    html: `<div style="font-size: 1.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">${getStopIcon(currentStopType)}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                }),
                draggable: true
            }).addTo(tripPlannerMap);

            marker.stopId = stopId;
            marker.on('dragend', function(e) {
                const newPos = e.target.getLatLng();
                const stopIdx = plannerStops.findIndex(s => s.id === stopId);
                if (stopIdx >= 0) {
                    plannerStops[stopIdx].lat = newPos.lat;
                    plannerStops[stopIdx].lng = newPos.lng;
                    updatePlannerRoute();
                }
            });

            marker.bindPopup(`
                <div style="text-align: center;">
                    <strong>${getStopIcon(currentStopType)} ${currentStopType}</strong><br>
                    <small>${lat.toFixed(4)}, ${lng.toFixed(4)}</small>
                </div>
            `);

            plannerMarkers.push(marker);
            updatePlannerRoute();
            updatePlannerUI();
        }

        function removePlannerStop(stopId) {
            const stopIdx = plannerStops.findIndex(s => s.id === stopId);
            if (stopIdx >= 0) {
                plannerStops.splice(stopIdx, 1);
                
                // Remove marker
                const markerIdx = plannerMarkers.findIndex(m => m.stopId === stopId);
                if (markerIdx >= 0) {
                    tripPlannerMap.removeLayer(plannerMarkers[markerIdx]);
                    plannerMarkers.splice(markerIdx, 1);
                }
                
                updatePlannerRoute();
                updatePlannerUI();
            }
        }

        function updatePlannerRoute() {
            if (plannerRoute) {
                tripPlannerMap.removeLayer(plannerRoute);
            }

            if (plannerStops.length >= 2) {
                const coords = plannerStops.map(s => [s.lat, s.lng]);
                plannerRoute = L.polyline(coords, {
                    color: '#6366f1',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 10'
                }).addTo(tripPlannerMap);
            }
        }

        function updatePlannerUI() {
            const listContainer = document.getElementById('routeStopsList');
            
            if (plannerStops.length === 0) {
                listContainer.innerHTML = '<p class="empty-hint">Click on map to add stops...</p>';
            } else {
                listContainer.innerHTML = plannerStops.map((stop, idx) => `
                    <div class="route-stop-item">
                        <span class="stop-number">${idx + 1}</span>
                        <span class="stop-icon">${getStopIcon(stop.type)}</span>
                        <span class="stop-name">${stop.type}</span>
                        <button class="stop-delete" onclick="removePlannerStop(${stop.id})"></button>
                    </div>
                `).join('');
            }

            document.getElementById('plannerStopsCount').textContent = plannerStops.length;
            
            // Calculate approximate distance
            let totalDist = 0;
            for (let i = 1; i < plannerStops.length; i++) {
                totalDist += calculateDistance(
                    plannerStops[i-1].lat, plannerStops[i-1].lng,
                    plannerStops[i].lat, plannerStops[i].lng
                );
            }
            document.getElementById('plannerDistance').textContent = Math.round(totalDist) + ' km';
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function clearPlannerRoute() {
            if (confirm('Clear all stops?')) {
                plannerStops = [];
                plannerMarkers.forEach(m => tripPlannerMap.removeLayer(m));
                plannerMarkers = [];
                if (plannerRoute) {
                    tripPlannerMap.removeLayer(plannerRoute);
                    plannerRoute = null;
                }
                updatePlannerUI();
            }
        }

        function savePlannedTrip() {
            if (plannerStops.length < 2) {
                alert('Please add at least 2 stops to save a trip');
                return;
            }

            const tripName = document.getElementById('plannedTripName').value.trim() || 
                             `${currentCountryName} Trip ${plannedTrips.length + 1}`;
            const tripNotes = document.getElementById('plannedTripNotes').value.trim();

            let totalDist = 0;
            for (let i = 1; i < plannerStops.length; i++) {
                totalDist += calculateDistance(
                    plannerStops[i-1].lat, plannerStops[i-1].lng,
                    plannerStops[i].lat, plannerStops[i].lng
                );
            }

            const newTrip = {
                id: 'planned_' + Date.now(),
                name: tripName,
                country: currentCountryName,
                stops: [...plannerStops],
                distance: Math.round(totalDist),
                notes: tripNotes,
                createdAt: new Date().toISOString()
            };

            plannedTrips.push(newTrip);
            saveToStorage();
            renderPlannedTrips();
            
            alert(` Trip "${tripName}" saved!\n\n${plannerStops.length} stops  ${Math.round(totalDist)} km`);
            closeTripPlannerModal();
        }

        function shareToCommunnity() {
            if (plannerStops.length < 2) {
                alert('Please add at least 2 stops to share');
                return;
            }

            const tripName = document.getElementById('plannedTripName').value.trim();
            if (!tripName) {
                alert('Please give your trip a name first');
                return;
            }

            // Convert to community format
            let totalDist = 0;
            for (let i = 1; i < plannerStops.length; i++) {
                totalDist += calculateDistance(
                    plannerStops[i-1].lat, plannerStops[i-1].lng,
                    plannerStops[i].lat, plannerStops[i].lng
                );
            }

            const communityTrip = {
                id: 'user_' + Date.now(),
                name: tripName,
                icon: '',
                country: currentCountryName,
                distance: Math.round(totalDist) + ' km',
                duration: 'Varies',
                coordinates: [[plannerStops[0].lat, plannerStops[0].lng], [plannerStops[plannerStops.length-1].lat, plannerStops[plannerStops.length-1].lng]],
                waypoints: plannerStops.map(s => [s.lat, s.lng, `${getStopIcon(s.type)} ${s.type}`]),
                tags: ['community'],
                description: document.getElementById('plannedTripNotes').value.trim() || `Community trip in ${currentCountryName}`,
                tips: '',
                userCreated: true,
                createdBy: userName,
                createdAt: new Date().toISOString()
            };

            userCreatedTrips.push(communityTrip);
            saveToStorage();
            renderRoadTrips();
            
            alert(` Trip "${tripName}" shared with the community!\n\nIt's now available in Serendipity mode for everyone.`);
            closeTripPlannerModal();
        }

        function renderPlannedTrips() {
            const container = document.getElementById('plannedTripsList');
            
            if (plannedTrips.length === 0) {
                container.innerHTML = '<p style="font-size: 0.7rem; color: var(--text-muted); text-align: center; padding: 10px;">No trips planned yet</p>';
                return;
            }

            container.innerHTML = plannedTrips.map(trip => `
                <div class="planned-trip-item" onclick="viewPlannedTrip('${trip.id}')">
                    <span class="trip-icon"></span>
                    <div class="trip-info">
                        <div class="trip-name">${trip.name}</div>
                        <div class="trip-meta">${trip.country}  ${trip.stops.length} stops  ${trip.distance} km</div>
                    </div>
                </div>
            `).join('');
        }

        function viewPlannedTrip(tripId) {
            const trip = plannedTrips.find(t => t.id === tripId);
            if (!trip) return;

            // Open planner modal and load the trip
            currentCountryName = trip.country;
            openTripPlannerModal();
            
            setTimeout(() => {
                // Load stops
                trip.stops.forEach(stop => {
                    currentStopType = stop.type;
                    addPlannerStop(stop.lat, stop.lng);
                });
                
                document.getElementById('plannedTripName').value = trip.name;
                document.getElementById('plannedTripNotes').value = trip.notes || '';
                
                // Fit bounds
                if (plannerStops.length > 0) {
                    const bounds = L.latLngBounds(plannerStops.map(s => [s.lat, s.lng]));
                    tripPlannerMap.fitBounds(bounds, { padding: [50, 50] });
                }
            }, 300);
        }

        function searchNearby(type) {
            if (!tripPlannerMap) return;
            
            const center = tripPlannerMap.getCenter();
            const query = encodeURIComponent(`${type} near ${center.lat},${center.lng}`);
            
            // Open Google Maps search
            window.open(`https://www.google.com/maps/search/${query}`, '_blank');
        }

        // Enable/disable plan trip button based on country selection
        function updatePlanTripButton() {
            const btn = document.getElementById('planTripBtn');
            if (btn) {
                btn.disabled = !currentCountryName || currentCountryName === 'Unknown' || currentCountryName === '';
            }
        }

        // ==================== SATELLITE VIEW (DOUBLE-CLICK) ====================
        function openCountrySatelliteView(countryName) {
            document.getElementById('satelliteViewModal').classList.add('active');
            document.getElementById('satelliteCountryName').textContent = countryName;
            
            // Initialize satellite map
            setTimeout(() => {
                initSatelliteMap(countryName);
                populateCountryInfo(countryName);
            }, 100);
        }

        function closeSatelliteViewModal() {
            document.getElementById('satelliteViewModal').classList.remove('active');
            if (satelliteMap) {
                satelliteMap.remove();
                satelliteMap = null;
            }
        }

        function initSatelliteMap(countryName) {
            if (satelliteMap) {
                satelliteMap.remove();
            }

            const coords = countryCoordinates[countryName] || [30, 0, 4];
            
            satelliteMap = L.map('satelliteMap', {
                center: [coords[0], coords[1]],
                zoom: coords[2] || 6,
                zoomControl: true
            });

            // Create all layer options
            // Esri World Imagery - FREE satellite imagery
            satelliteLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: ' Esri, Maxar, Earthstar Geographics',
                maxZoom: 19
            });

            // Stamen Terrain - Shows terrain features
            satelliteLayers.terrain = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}{r}.png', {
                attribution: ' Stadia Maps,  OpenStreetMap',
                maxZoom: 18
            });

            // OpenStreetMap - Shows roads clearly
            satelliteLayers.roads = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors',
                maxZoom: 19
            });

            // Hybrid - Satellite with road labels
            satelliteLayers.hybrid = L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19
                }),
                L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lines/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    opacity: 0.5
                }),
                L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png', {
                    maxZoom: 19
                })
            ]);

            // Add default satellite layer
            satelliteLayers.satellite.addTo(satelliteMap);
            currentSatelliteLayer = 'satellite';
            updateLayerButtons();

            // Add landmarks for this country
            addCountryLandmarks(countryName);
            
            // Add scale control
            L.control.scale({ imperial: false }).addTo(satelliteMap);
        }

        function setSatelliteLayer(layerType) {
            if (!satelliteMap) return;

            // Remove current layer
            Object.values(satelliteLayers).forEach(layer => {
                if (satelliteMap.hasLayer(layer)) {
                    satelliteMap.removeLayer(layer);
                }
            });

            // Add new layer
            satelliteLayers[layerType].addTo(satelliteMap);
            currentSatelliteLayer = layerType;
            updateLayerButtons();
        }

        function updateLayerButtons() {
            document.querySelectorAll('.layer-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.layer === currentSatelliteLayer);
            });
        }

        function addCountryLandmarks(countryName) {
            // Filter viewpoints for this country
            const landmarks = worldViewpoints.filter(v => v.country === countryName);
            
            landmarks.forEach(landmark => {
                const marker = L.marker([landmark.lat, landmark.lng], {
                    icon: L.divIcon({
                        className: 'landmark-marker',
                        html: `<div style="font-size: 1.5rem; text-shadow: 0 2px 8px rgba(0,0,0,0.8);">${landmark.icon}</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(satelliteMap);

                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 8px 0;">${landmark.icon} ${landmark.name}</h4>
                        <p style="margin: 0; font-size: 0.85rem; color: #666;">
                            ${landmark.unesco ? ' UNESCO World Heritage' : landmark.type}
                        </p>
                        <a href="https://www.google.com/search?q=${encodeURIComponent(landmark.name)}" target="_blank" 
                           style="display: inline-block; margin-top: 8px; font-size: 0.8rem; color: #6366f1;">
                            Learn more 
                        </a>
                    </div>
                `);
            });
        }

        function populateCountryInfo(countryName) {
            // Quick facts
            const quickFactsContainer = document.getElementById('countryQuickFacts');
            const info = vanliferInfo[countryName] || defaultVanliferInfo;
            
            quickFactsContainer.innerHTML = `
                <div class="quick-fact-item">
                    <span class="fact-label"> Tolls</span>
                    <span class="fact-value">${info.tolls}</span>
                </div>
                <div class="quick-fact-item">
                    <span class="fact-label"> Camping</span>
                    <span class="fact-value">${info.camping}</span>
                </div>
                <div class="quick-fact-item">
                    <span class="fact-label"> Fuel</span>
                    <span class="fact-value">${info.fuel}</span>
                </div>
                <div class="quick-fact-item">
                    <span class="fact-label"> Visa</span>
                    <span class="fact-value">${info.visa}</span>
                </div>
                <div class="quick-fact-item">
                    <span class="fact-label"> Roads</span>
                    <span class="fact-value">${info.roadQuality}</span>
                </div>
            `;

            // Landmarks
            const landmarksContainer = document.getElementById('countryLandmarks');
            const landmarks = worldViewpoints.filter(v => v.country === countryName);
            
            if (landmarks.length > 0) {
                landmarksContainer.innerHTML = landmarks.map(l => `
                    <div class="landmark-item" onclick="flyToLandmark(${l.lat}, ${l.lng}, '${l.name}')">
                        <span class="landmark-icon">${l.icon}</span>
                        <div>
                            <div class="landmark-name">${l.name}</div>
                            <div class="landmark-type">${l.unesco ? 'UNESCO' : l.type}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                landmarksContainer.innerHTML = '<p style="font-size: 0.8rem; color: var(--text-muted);">No landmarks data yet</p>';
            }
        }

        function flyToLandmark(lat, lng, name) {
            if (satelliteMap) {
                satelliteMap.flyTo([lat, lng], 14, { duration: 1.5 });
            }
        }

        function planTripFromSatellite() {
            const countryName = document.getElementById('satelliteCountryName').textContent;
            closeSatelliteViewModal();
            currentCountryName = countryName;
            openTripPlannerModal();
        }

        function openInGoogleEarth() {
            const countryName = document.getElementById('satelliteCountryName').textContent;
            const coords = countryCoordinates[countryName];
            if (coords) {
                window.open(`https://earth.google.com/web/@${coords[0]},${coords[1]},0a,1000000d,35y,0h,0t,0r`, '_blank');
            } else {
                window.open(`https://earth.google.com/web/search/${encodeURIComponent(countryName)}`, '_blank');
            }
        }

        // ==================== COMMUNITY ALERTS ====================
        function renderAlerts() {
            const container = document.getElementById('alertsList');
            
            // Default sample alerts
            if (communityAlerts.length === 0) {
                communityAlerts = [
                    { id: 1, type: 'tip', title: 'Dune 45 Lever du soleil', description: 'Arrivez avant 5h30 pour le lever de soleil sur Dune 45. Magique! Prvoir lampe frontale.', location: 'Sossusvlei, Namibie', date: '1 semaine', lat: -24.7275, lng: 15.4739 },
                    { id: 2, type: 'camping', title: 'Sesriem = Accs prioritaire', description: 'Dormir au camp NWR Sesriem permet d\'entrer dans le parc 1h avant les autres visiteurs!', location: 'Sesriem, Namibie', date: '2 semaines', lat: -24.4800, lng: 15.8300 },
                    { id: 3, type: 'hazard', title: 'Piste sableuse D707', description: 'Route trs sableuse entre Solitaire et Walvis Bay. 4x4 indispensable, rduire pression pneus.', location: 'D707, Namibie', date: '3 semaines', lat: -23.5500, lng: 15.2000 },
                    { id: 4, type: 'fuel', title: 'Dernire station avant Sossusvlei', description: 'Faites le plein  Solitaire! Prochaine station  200km.', location: 'Solitaire, Namibie', date: '1 mois', lat: -23.8900, lng: 16.0100 },
                    { id: 5, type: 'tip', title: 'lphants du dsert  Palmwag', description: 'Game drive matinal  Palmwag = quasi garanti de voir les lphants du dsert!', location: 'Palmwag, Namibie', date: '1 mois', lat: -19.8800, lng: 13.9500 },
                    { id: 6, type: 'camping', title: 'Okaukuejo Waterhole', description: 'Le waterhole d\'Okaukuejo est illumin la nuit. Rhinos noirs rguliers aprs 22h!', location: 'Etosha, Namibie', date: '1 mois', lat: -18.9000, lng: 15.9200 },
                    { id: 7, type: 'road_work', title: 'Road Construction', description: 'I-40 near Flagstaff, expect delays', location: 'Route 66, Arizona', date: '2 hours ago', lat: 35.2, lng: -111.6 },
                    { id: 8, type: 'hazard', title: 'Pothole Warning', description: 'Large potholes after km marker 245', location: 'Transfgran, Romania', date: '3 days ago', lat: 45.6, lng: 24.6 }
                ];
            }

            container.innerHTML = communityAlerts.map(alert => `
                <div class="alert-item ${alert.type === 'hazard' ? 'danger' : (alert.type === 'camping' || alert.type === 'tip' ? 'success' : '')}">
                    <span class="alert-icon">${getAlertIcon(alert.type)}</span>
                    <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-desc">${alert.description}</div>
                        <div class="alert-meta"> ${alert.location}  ${alert.date}</div>
                    </div>
                </div>
            `).join('');
        }

        function getAlertIcon(type) {
            const icons = {
                'road_work': '',
                'hazard': '',
                'police': '',
                'fuel': '',
                'camping': '',
                'tip': ''
            };
            return icons[type] || '';
        }

        function openAlertModal() {
            document.getElementById('alertModal').classList.add('active');
        }

        function closeAlertModal() {
            document.getElementById('alertModal').classList.remove('active');
        }

        function submitAlert() {
            const type = document.getElementById('alertType').value;
            const location = document.getElementById('alertLocation').value;
            const description = document.getElementById('alertDescription').value;

            if (!location || !description) {
                alert('Please fill in all fields');
                return;
            }

            const newAlert = {
                id: Date.now(),
                type: type,
                title: document.getElementById('alertType').options[document.getElementById('alertType').selectedIndex].text.replace(/[^\w\s]/g, '').trim(),
                description: description,
                location: location,
                date: 'Just now'
            };

            communityAlerts.unshift(newAlert);
            renderAlerts();
            closeAlertModal();
            saveToStorage();

            // Clear form
            document.getElementById('alertLocation').value = '';
            document.getElementById('alertDescription').value = '';
        }

        // ==================== MAP ACTIONS ====================
        function markAsVisited() {
            if (!selectedCountry) {
                alert('Please select a country first');
                return;
            }
            d3.select(selectedCountry).style('fill', VISITED_COLOR);
            countryColors[currentCountryId] = VISITED_COLOR;
            saveToStorage();
            updateStats();
        }

        function resetMap() {
            if (confirm('Reset all progress?')) {
                g.selectAll("path").style('fill', DEFAULT_COLOR);
                countryColors = {};
                selectedCountry = null;
                document.getElementById('selectedCountryName').textContent = 'Click a country';
                document.getElementById('selectedDisplay').classList.remove('has-selection');
                document.getElementById('countrySearch').value = '';
                saveToStorage();
                updateStats();
            }
        }

        function updateStats() {
            const visited = Object.keys(countryColors).length;
            document.getElementById('countriesVisited').textContent = visited;

            const continents = new Set();
            Object.keys(countryColors).forEach(id => {
                if (continentMapping[id]) continents.add(continentMapping[id]);
            });
            document.getElementById('continentsExplored').textContent = continents.size;

            // Update serendipity stats
            document.getElementById('routesExplored').textContent = activeRoute ? 1 : 0;
            document.getElementById('kmTraveled').textContent = activeRoute ? 
                roadTrips.find(r => r.id === activeRoute)?.distance.replace(' km', '') || '0' : '0';
        }

        // ==================== ZOOM ====================
        let zoom;

        function setupZoom() {
            zoom = d3.zoom()
                .scaleExtent([1, 8])
                .on("zoom", (event) => g.attr("transform", event.transform));
            svg.call(zoom);
        }

        function zoomIn() {
            if (currentMode === 'serendipity' && roadMap) {
                roadMap.zoomIn();
            } else {
                svg.transition().call(zoom.scaleBy, 1.5);
            }
        }

        function zoomOut() {
            if (currentMode === 'serendipity' && roadMap) {
                roadMap.zoomOut();
            } else {
                svg.transition().call(zoom.scaleBy, 0.67);
            }
        }

        function resetZoom() {
            if (currentMode === 'serendipity' && roadMap) {
                roadMap.setView([30, 0], 2);
            } else {
                svg.transition().call(zoom.transform, d3.zoomIdentity);
            }
        }

        // ==================== STORAGE ====================
        function saveToStorage() {
            const data = {
                countryColors,
                communityAlerts,
                activeRoute,
                completedTrips,
                userCreatedTrips,
                plannedTrips,
                userName
            };
            localStorage.setItem('travelDiarySerendipity', JSON.stringify(data));
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('travelDiarySerendipity');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.countryColors) {
                        countryColors = data.countryColors;
                        Object.keys(countryColors).forEach(id => {
                            const el = document.querySelector(`[data-id="${id}"]`);
                            if (el) d3.select(el).style('fill', countryColors[id]);
                        });
                    }
                    if (data.communityAlerts) communityAlerts = data.communityAlerts;
                    if (data.activeRoute) activeRoute = data.activeRoute;
                    if (data.completedTrips) completedTrips = data.completedTrips;
                    if (data.userCreatedTrips) userCreatedTrips = data.userCreatedTrips;
                    if (data.plannedTrips) plannedTrips = data.plannedTrips;
                    if (data.userName) userName = data.userName;
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        // ==================== EXPORT/IMPORT ====================
        function exportData() {
            const data = {
                countryColors,
                communityAlerts,
                activeRoute,
                completedTrips,
                userCreatedTrips,
                plannedTrips,
                userName,
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'travel-diary-' + Date.now() + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('fileInput').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.countryColors) {
                        countryColors = data.countryColors;
                        Object.keys(countryColors).forEach(id => {
                            const el = document.querySelector(`[data-id="${id}"]`);
                            if (el) d3.select(el).style('fill', countryColors[id]);
                        });
                    }
                    if (data.communityAlerts) {
                        communityAlerts = data.communityAlerts;
                        renderAlerts();
                    }
                    saveToStorage();
                    updateStats();
                    alert('Data imported successfully!');
                } catch (err) {
                    alert('Error importing file');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ==================== KEYBOARD ====================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeAlertModal();
                closeLeaderboardModal();
                closeCreateTripModal();
                closeTripPlannerModal();
                closeSatelliteViewModal();
                closeTripDetailModal();
            }
        });

        // ==================== INIT ====================
        initMap();
        
        // Initialize UI after a short delay to ensure DOM is ready
        setTimeout(() => {
            updateLeagueStats();
            renderPlannedTrips();
        }, 100);
    </script>
</body>
</html>
